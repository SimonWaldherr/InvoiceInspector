<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ZUGFeRD / XRechnung / EN16931 E-Rechnungs-Reader inkl. PDF-Extraktion</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.6.172/pdf.min.js"></script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.6;
      background: #f7f7f7;
    }

    h1, h2 {
      margin-bottom: 0.5em;
    }

    h1 {
      font-size: 2em;
      margin-top: 0;
      color: #333;
    }

    .description, section, details {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .drop-zone {
      border: 2px dashed #aaa;
      border-radius: 5px;
      padding: 40px;
      text-align: center;
      color: #333;
      background: #fff;
      margin-bottom: 20px;
      transition: border-color 0.3s, background-color 0.3s;
      cursor: pointer;
      position: relative;
    }

    .drop-zone.dragover {
      border-color: #007BFF;
      background-color: #f0f8ff;
    }

    .drop-zone p {
      margin: 0;
      font-size: 1.1em;
    }

    .hidden {
      display: none;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
    }

    table th, table td {
      border: 1px solid #ccc;
      padding: 8px;
      vertical-align: top;
    }

    table th {
      background: #f0f0f0;
      text-align: left;
      width: 12.5%;
    }

    .error {
      color: red;
      background-color: #ffe6e6;
      padding: 10px;
      border-radius: 5px;
    }

    .download-buttons {
      margin-bottom: 20px;
      text-align: center;
    }

    .download-buttons button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #007BFF;
      color: white;
      transition: background-color 0.3s, transform 0.2s;
    }

    .download-buttons button:hover {
      background-color: #0056b3;
      transform: scale(1.05);
    }

    details summary {
      cursor: pointer;
      font-weight: bold;
    }

    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 400px;
      overflow: auto;
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    /* Dark Mode Support */
    @media (prefers-color-scheme: dark) {
      body {
        background: #1a1a1a;
        color: #e0e0e0;
      }

      .description, section, details {
        background: #2d2d2d;
        border-color: #444;
        color: #e0e0e0;
      }

      .drop-zone {
        background: #2d2d2d;
        border-color: #555;
        color: #e0e0e0;
      }

      .drop-zone.dragover {
        border-color: #0099ff;
        background-color: #1a3a5a;
      }

      table th {
        background: #383838;
        color: #e0e0e0;
      }

      table th, table td {
        border-color: #555;
      }

      pre {
        background-color: #1e1e1e;
        border-color: #555;
        color: #e0e0e0;
      }

      .error {
        background-color: #4a1a1a;
        color: #ff9999;
      }
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007BFF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Improved table responsiveness */
    .table-container {
      overflow-x: auto;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    /* Success message */
    .success {
      color: #155724;
      background-color: #d4edda;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #c3e6cb;
      margin-bottom: 20px;
    }

    /* Statistics section */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #dee2e6;
      text-align: center;
    }

    .stat-card h3 {
      margin: 0 0 10px 0;
      font-size: 1.2em;
      color: #495057;
    }

    .stat-card .value {
      font-size: 1.5em;
      font-weight: bold;
      color: #007BFF;
    }

    @media (prefers-color-scheme: dark) {
      .stat-card {
        background: #343a40;
        border-color: #495057;
      }

      .stat-card h3 {
        color: #adb5bd;
      }

      .success {
        color: #b8e6b8;
        background-color: #155724;
        border-color: #28a745;
      }

      .table-container {
        border-color: #555;
      }
    }

    @media (max-width: 768px) {
      table th, table td {
        font-size: 0.9em;
      }

      .drop-zone {
        padding: 20px;
      }

      .download-buttons button {
        width: 100%;
        margin: 10px 0;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h1>E-Rechnungs-Reader (ZUGFeRD, XRechnung, EN16931) mit PDF-Extraktion</h1>

  <section class="description">
    <h2>Beschreibung</h2>
    <p>Dieses Tool erm√∂glicht das Anzeigen von elektronischen Rechnungen im XML-Format sowie ZUGFeRD-PDF/A-3-Dateien. Die eingebettete XML-Datei in ZUGFeRD-PDFs wird automatisch extrahiert und die Rechnungsdaten werden strukturiert dargestellt.</p>
    <p><strong>Hinweis:</strong> Dieses Tool verarbeitet elektronische Rechnungen (z. B. ZUGFeRD, XRechnung) vollst√§ndig clientseitig im Browser. Die Dateien werden nicht hochgeladen oder gespeichert.<br/>Es wird keine Gew√§hr f√ºr die Richtigkeit, Vollst√§ndigkeit oder Rechtskonformit√§t der angezeigten Daten √ºbernommen. Jegliche Haftung f√ºr Sch√§den oder Verluste, die aus der Nutzung resultieren, ist ausgeschlossen. Die Verantwortung f√ºr die korrekte Verarbeitung und Pr√ºfung der Daten liegt beim Nutzer.</p>
  </section>

  <div class="drop-zone" id="dropZone">
    <p>üìÑ Datei hierher ziehen und fallen lassen oder klicken, um eine Datei auszuw√§hlen.</p>
    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">Unterst√ºtzte Formate: ZUGFeRD PDF, XRechnung XML, EN16931 XML</p>
    <input type="file" id="invoiceFile" accept=".xml,.pdf,application/pdf" style="display:none;" />
  </div>

  <div id="loadingSection" class="hidden" style="text-align: center; padding: 20px;">
    <div class="loading"></div>
    <span>Verarbeitung l√§uft...</span>
  </div>

  <div id="successSection" class="success hidden">
    ‚úÖ Rechnung erfolgreich verarbeitet!
  </div>

  <section id="statsSection" class="hidden">
    <h2>üìä Statistiken</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Positionen</h3>
        <div class="value" id="statLineItems">0</div>
      </div>
      <div class="stat-card">
        <h3>Nettosumme</h3>
        <div class="value" id="statNetAmount">0 ‚Ç¨</div>
      </div>
      <div class="stat-card">
        <h3>Steuern</h3>
        <div class="value" id="statTaxAmount">0 ‚Ç¨</div>
      </div>
      <div class="stat-card">
        <h3>Bruttosumme</h3>
        <div class="value" id="statGrossAmount">0 ‚Ç¨</div>
      </div>
    </div>
  </section>

  <div class="download-buttons hidden" id="downloadButtons">
    <button id="downloadXml">üìÑ XML speichern</button>
    <button id="downloadPdf">üìã PDF speichern</button>
    <button id="downloadJson">üìä JSON Export</button>
    <button id="downloadCsv">üìà CSV Export</button>
  </div>

  <details id="xmlViewer" class="hidden">
    <summary>XML anzeigen</summary>
    <pre id="originalXml"></pre>
  </details>

  <section id="errorSection" class="error hidden"></section>

  <section id="headerSection" class="hidden">
    <h2>üìã Rechnungsinformationen</h2>
    <div class="table-container">
      <table>
        <tr><th>Rechnungsnummer</th><td id="invNumber"></td></tr>
        <tr><th>Rechnungstyp</th><td id="invType"></td></tr>
        <tr><th>Rechnungsdatum</th><td id="invDate"></td></tr>
        <tr><th>F√§lligkeitsdatum</th><td id="invDueDate"></td></tr>
        <tr><th>Bestellnummer</th><td id="invOrderNumber"></td></tr>
        <tr><th>Notiz</th><td id="invNote"></td></tr>
      </table>
    </div>
  </section>

  <section id="sellerSection" class="hidden">
    <h2>üè¢ Verk√§ufer / Rechnungssteller</h2>
    <div class="table-container">
      <table>
        <tr><th>Name</th><td id="sellerName"></td></tr>
        <tr><th>Adresse</th><td id="sellerAddress"></td></tr>
        <tr><th>E-Mail</th><td id="sellerEmail"></td></tr>
        <tr><th>Telefon</th><td id="sellerPhone"></td></tr>
        <tr><th>Steuer-ID</th><td id="sellerTaxID"></td></tr>
        <tr><th>Handelsregister</th><td id="sellerRegister"></td></tr>
      </table>
    </div>
  </section>

  <section id="buyerSection" class="hidden">
    <h2>üë§ K√§ufer / Rechnungsempf√§nger</h2>
    <div class="table-container">
      <table>
        <tr><th>Name</th><td id="buyerName"></td></tr>
        <tr><th>Adresse</th><td id="buyerAddress"></td></tr>
        <tr><th>E-Mail</th><td id="buyerEmail"></td></tr>
        <tr><th>Telefon</th><td id="buyerPhone"></td></tr>
        <tr><th>Steuer-ID</th><td id="buyerTaxID"></td></tr>
      </table>
    </div>
  </section>

  <section id="paymentSection" class="hidden">
    <h2>üí≥ Zahlungsinformationen</h2>
    <div class="table-container">
      <table>
        <tr><th>W√§hrung</th><td id="currency"></td></tr>
        <tr><th>Zahlungsart</th><td id="paymentType"></td></tr>
        <tr><th>Zahlungsziel</th><td id="paymentTerms"></td></tr>
        <tr><th>IBAN</th><td id="iban"></td></tr>
        <tr><th>BIC</th><td id="bic"></td></tr>
        <tr><th>Kontoinhaber</th><td id="accountHolder"></td></tr>
        <tr><th>Gesamt netto</th><td id="netAmount"></td></tr>
        <tr><th>Steuerbetrag</th><td id="taxAmount"></td></tr>
        <tr><th>Gesamt brutto</th><td id="grossAmount"></td></tr>
        <tr><th>F√§lliger Betrag</th><td id="dueAmount"></td></tr>
      </table>
    </div>
  </section>

  <section id="lineItemsSection" class="hidden">
    <h2>üì¶ Positionen</h2>
    <div class="table-container">
      <table id="lineItemsTable">
        <thead>
          <tr>
            <th data-key="posNr">Pos.-Nr.</th>
            <th data-key="productName">Produktname</th>
            <th data-key="description">Beschreibung</th>
            <th data-key="notes">Notiz</th>
            <th data-key="quantity">Menge</th>
            <th data-key="unit">Einheit</th>
            <th data-key="unitPrice">Einzelpreis</th>
            <th data-key="lineNet">Zeilen-Netto</th>
            <th data-key="taxRate">Steuersatz</th>
            <th data-key="lineGross">Zeilenbrutto</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <script>
    (function() {
      "use strict";

      // DOM-Elemente
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('invoiceFile');
      const loadingSection = document.getElementById('loadingSection');
      const successSection = document.getElementById('successSection');
      const errorSection = document.getElementById('errorSection');
      const statsSection = document.getElementById('statsSection');
      const headerSection = document.getElementById('headerSection');
      const sellerSection = document.getElementById('sellerSection');
      const buyerSection = document.getElementById('buyerSection');
      const paymentSection = document.getElementById('paymentSection');
      const lineItemsSection = document.getElementById('lineItemsSection');
      const xmlViewer = document.getElementById('xmlViewer');
      const originalXml = document.getElementById('originalXml');
      const downloadButtons = document.getElementById('downloadButtons');
      const downloadXmlButton = document.getElementById('downloadXml');
      const downloadPdfButton = document.getElementById('downloadPdf');
      const downloadJsonButton = document.getElementById('downloadJson');
      const downloadCsvButton = document.getElementById('downloadCsv');
      const lineItemsTable = document.getElementById('lineItemsTable');
      const tableHeaders = lineItemsTable.querySelectorAll('th');

      // Globale Variablen
      let xmlDoc = null;
      let originalPdfBlob = null;
      let originalXmlBlob = null;
      let currentLabels = {};
      let invoiceData = {}; // F√ºr JSON/CSV Export

      // Mehrsprachige Labels
      const labels = {
        de: {
          posNr: "Pos.-Nr.",
          productName: "Produktname",
          description: "Beschreibung",
          notes: "Notiz",
          quantity: "Menge",
          unit: "Einheit",
          unitPrice: "Einzelpreis",
          lineNet: "Zeilen-Netto",
          taxRate: "Steuersatz",
          lineGross: "Zeilenbrutto",
          xmlViewerSummary: "XML anzeigen",
          invoiceInfo: "üìã Rechnungsinformationen",
          sellerInfo: "üè¢ Verk√§ufer / Rechnungssteller",
          buyerInfo: "üë§ K√§ufer / Rechnungsempf√§nger",
          paymentInfo: "üí≥ Zahlungsinformationen",
          lineItems: "üì¶ Positionen",
          statistics: "üìä Statistiken",
          downloadXml: "üìÑ XML speichern",
          downloadPdf: "üìã PDF speichern",
          downloadJson: "üìä JSON Export",
          downloadCsv: "üìà CSV Export",
          noFileFound: "Keine XML-Datei im PDF gefunden.",
          unsupportedFormat: "Dateiformat nicht unterst√ºtzt. Bitte eine PDF (ZUGFeRD) oder XML-Datei hochladen.",
          invalidXml: "Die extrahierte Datei ist keine g√ºltige XML-Rechnung.",
          pdfNotAvailable: "Original-PDF ist nicht verf√ºgbar.",
          processingError: "Fehler beim Verarbeiten der Datei: ",
        },
        en: {
          posNr: "No.",
          productName: "Product Name",
          description: "Description",
          notes: "Notes",
          quantity: "Quantity",
          unit: "Unit",
          unitPrice: "Unit Price",
          lineNet: "Line Net",
          taxRate: "Tax Rate",
          lineGross: "Line Gross",
          xmlViewerSummary: "Show XML",
          invoiceInfo: "üìã Invoice Information",
          sellerInfo: "üè¢ Seller / Issuer",
          buyerInfo: "üë§ Buyer / Recipient",
          paymentInfo: "üí≥ Payment Information",
          lineItems: "üì¶ Line Items",
          statistics: "üìä Statistics",
          downloadXml: "üìÑ Save XML",
          downloadPdf: "üìã Save PDF",
          downloadJson: "üìä JSON Export",
          downloadCsv: "üìà CSV Export",
          noFileFound: "No XML file found in the PDF.",
          unsupportedFormat: "Unsupported file format. Please upload a PDF (ZUGFeRD) or XML file.",
          invalidXml: "The extracted file is not a valid XML invoice.",
          pdfNotAvailable: "Original PDF is not available.",
          processingError: "Error processing the file: ",
        }
      };

      // Sprachenerkennung und Labels setzen
      function setLanguageLabels() {
        const userLang = navigator.language || navigator.userLanguage;
        if (userLang.startsWith('de')) {
          currentLabels = labels.de;
        } else {
          currentLabels = labels.en;
        }

        // Aktualisiere alle relevanten Texte basierend auf der Sprache
        // Update Table Headers
        tableHeaders.forEach(th => {
          const key = th.getAttribute('data-key');
          if (currentLabels[key]) {
            th.textContent = currentLabels[key];
          }
        });

        // Update Download Buttons
        downloadXmlButton.textContent = currentLabels.downloadXml || "Save XML";
        downloadPdfButton.textContent = currentLabels.downloadPdf || "Save PDF";
        downloadJsonButton.textContent = currentLabels.downloadJson || "JSON Export";
        downloadCsvButton.textContent = currentLabels.downloadCsv || "CSV Export";

        // Update XML Viewer Summary
        const xmlViewerSummary = document.querySelector('#xmlViewer summary');
        if (xmlViewerSummary) {
          xmlViewerSummary.textContent = currentLabels.xmlViewerSummary || "Show XML";
        }

        // Update Section Titles
        const sectionTitles = {
          headerSection: currentLabels.invoiceInfo || "Invoice Information",
          sellerSection: currentLabels.sellerInfo || "Seller / Issuer",
          buyerSection: currentLabels.buyerInfo || "Buyer / Recipient",
          paymentSection: currentLabels.paymentInfo || "Payment Information",
          lineItemsSection: currentLabels.lineItems || "Line Items",
          statsSection: currentLabels.statistics || "Statistics"
        };

        for (const [sectionId, title] of Object.entries(sectionTitles)) {
          const section = document.getElementById(sectionId);
          if (section && section.querySelector('h2')) {
            section.querySelector('h2').textContent = title;
          }
        }
      }

      setLanguageLabels(); // Initiales Setzen der Labels

      // Event-Listener f√ºr Drag-and-Drop und Klick
      dropZone.addEventListener('click', () => fileInput.click());

      ['dragover', 'dragleave', 'drop'].forEach(event => {
        dropZone.addEventListener(event, handleDragEvents, false);
      });

      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if(file) handleFile(file);
      });

      function handleDragEvents(e) {
        e.preventDefault();
        if (e.type === 'dragover') {
          dropZone.classList.add('dragover');
        } else {
          dropZone.classList.remove('dragover');
          if (e.type === 'drop') {
            const file = e.dataTransfer.files[0];
            if(file) handleFile(file);
          }
        }
      }

      async function handleFile(file) {
        resetUI();
        showLoading();
        
        try {
          if(file.type === "application/pdf") {
            originalPdfBlob = file;
            const xmlContent = await extractXmlFromPdf(file);
            if(xmlContent) {
              originalXmlBlob = new Blob([xmlContent], { type: "application/xml" });
              await parseXML(xmlContent);
            } else {
              showError(currentLabels.noFileFound || "No XML file found in the PDF.");
            }
          } else if(file.name.toLowerCase().endsWith(".xml")) {
            originalXmlBlob = file;
            const text = await file.text();
            await parseXML(text);
          } else {
            showError(currentLabels.unsupportedFormat || "Unsupported file format. Please upload a PDF (ZUGFeRD) or XML file.");
          }
        } catch (err) {
          showError(`${currentLabels.processingError || "Error processing the file: "} ${err.message}`);
          console.error(err);
        } finally {
          hideLoading();
        }
      }

      async function extractXmlFromPdf(file) {
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({data: new Uint8Array(arrayBuffer)}).promise;
          const attachments = await pdf.getAttachments(); // Korrektur: await hinzugef√ºgt

          if(!attachments) return null;

          for (const [filename, attachment] of Object.entries(attachments)) {
            if(filename.toLowerCase().endsWith(".xml")) {
              const decoder = new TextDecoder("utf-8");
              return decoder.decode(attachment.content);
            }
          }

          return null;
        } catch (error) {
          console.error("Error extracting XML from PDF:", error);
          throw error;
        }
      }

      function parseXML(xmlString) {
        const parser = new DOMParser();
        xmlDoc = parser.parseFromString(xmlString, "application/xml");

        if(xmlDoc.querySelector("parsererror")) {
          showError(currentLabels.invalidXml || "The extracted file is not a valid XML invoice.");
          return;
        }

        // XML anzeigen
        originalXml.textContent = beautifyXml(xmlString);
        xmlViewer.classList.remove('hidden');

        // Download-Buttons konfigurieren
        if(originalXmlBlob || originalPdfBlob) {
          downloadButtons.classList.remove('hidden');
          downloadXmlButton.onclick = () => downloadBlob(originalXmlBlob, 'invoice.xml');
          downloadPdfButton.onclick = () => {
            if(originalPdfBlob) {
              downloadBlob(originalPdfBlob, 'invoice.pdf');
            } else {
              showError(currentLabels.pdfNotAvailable || "Original PDF is not available.");
            }
          };
          downloadJsonButton.onclick = () => downloadInvoiceAsJson();
          downloadCsvButton.onclick = () => downloadInvoiceAsCsv();
        }

        // Namespace-Resolver
        const namespaces = {
          'rsm': "urn:un:unece:uncefact:data:standard:CrossIndustryInvoice:100",
          'ram': "urn:un:unece:uncefact:data:standard:ReusableAggregateBusinessInformationEntity:100",
          'udt': "urn:un:unece:uncefact:data:standard:UnqualifiedDataType:100"
        };

        const resolver = (prefix) => namespaces[prefix] || null;

        // XPath-Hilfsfunktionen
        const selectNode = (contextNode, xpath) => {
          const result = xmlDoc.evaluate(
            xpath,
            contextNode,
            resolver,
            XPathResult.FIRST_ORDERED_NODE_TYPE,
            null
          );
          return result.singleNodeValue;
        };

        const selectNodes = (contextNode, xpath) => {
          const result = xmlDoc.evaluate(
            xpath,
            contextNode,
            resolver,
            XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,
            null
          );
          return Array.from({length: result.snapshotLength}, (_, i) => result.snapshotItem(i));
        };

        // Rechnungsinformationen auslesen und anzeigen
        displayInvoiceInfo(selectNode, selectNodes);
        displaySellerInfo(selectNode);
        displayBuyerInfo(selectNode);
        displayPaymentInfo(selectNode, selectNodes);
        const lineItemsCount = displayLineItems(selectNode, selectNodes);
        
        // Statistiken anzeigen
        displayStatistics(lineItemsCount);
        
        // Erfolg anzeigen
        showSuccess();
      }

      function displayInvoiceInfo(selectNode, selectNodes) {
        const invNumber = selectNode(xmlDoc, "/rsm:CrossIndustryInvoice/rsm:ExchangedDocument/ram:ID");
        const invType = selectNode(xmlDoc, "/rsm:CrossIndustryInvoice/rsm:ExchangedDocument/ram:TypeCode");
        const invDateNode = selectNode(xmlDoc, "/rsm:CrossIndustryInvoice/rsm:ExchangedDocument/ram:IssueDateTime/udt:DateTimeString");
        const invDueDateNode = selectNode(xmlDoc, "//ram:SpecifiedTradePaymentTerms/ram:DueDateDateTime/udt:DateTimeString");
        const invOrderNumber = selectNode(xmlDoc, "//ram:BuyerOrderReferencedDocument/ram:IssuerAssignedID");
        const invNoteNodes = selectNodes(xmlDoc, "/rsm:CrossIndustryInvoice/rsm:ExchangedDocument/ram:IncludedNote/ram:Content");

        invoiceData.header = {};
        
        if(invNumber) {
          const number = invNumber.textContent.trim();
          document.getElementById("invNumber").textContent = number;
          invoiceData.header.number = number;
        }
        
        if(invType) {
          const type = invType.textContent.trim();
          document.getElementById("invType").textContent = type;
          invoiceData.header.type = type;
        }
        
        if(invDateNode) {
          let dtStr = invDateNode.textContent.trim();
          let formattedDate = formatDate(dtStr);
          document.getElementById("invDate").textContent = formattedDate;
          invoiceData.header.date = formattedDate;
        }
        
        if(invDueDateNode) {
          let dtStr = invDueDateNode.textContent.trim();
          let formattedDate = formatDate(dtStr);
          document.getElementById("invDueDate").textContent = formattedDate;
          invoiceData.header.dueDate = formattedDate;
        }
        
        if(invOrderNumber) {
          const orderNumber = invOrderNumber.textContent.trim();
          document.getElementById("invOrderNumber").textContent = orderNumber;
          invoiceData.header.orderNumber = orderNumber;
        }
        
        if(invNoteNodes.length > 0) {
          const notes = invNoteNodes.map(note => note.textContent.trim()).join("\n");
          document.getElementById("invNote").textContent = notes;
          invoiceData.header.notes = notes;
        }
        
        headerSection.classList.remove('hidden');
      }

      function displaySellerInfo(selectNode) {
        const sellerName = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:Name");
        const sellerStreet = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:PostalTradeAddress/ram:LineOne");
        const sellerCity = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:PostalTradeAddress/ram:CityName");
        const sellerZip = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:PostalTradeAddress/ram:PostcodeCode");
        const sellerCountry = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:PostalTradeAddress/ram:CountryID");
        const sellerEmail = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:DefinedTradeContact/ram:EmailURIUniversalCommunication/ram:URIID");
        const sellerPhone = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:DefinedTradeContact/ram:TelephoneUniversalCommunication/ram:CompleteNumber");
        const sellerTaxVA = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:SpecifiedTaxRegistration/ram:ID[@schemeID='VA']");
        const sellerTaxFC = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:SpecifiedTaxRegistration/ram:ID[@schemeID='FC']");
        const sellerRegister = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:SpecifiedLegalOrganization/ram:ID");

        invoiceData.seller = {};
        
        if(sellerName) {
          const name = sellerName.textContent.trim();
          document.getElementById("sellerName").textContent = name;
          invoiceData.seller.name = name;
        }

        const sellerAddressParts = [
          sellerStreet?.textContent.trim(),
          (sellerZip && sellerCity) ? `${sellerZip.textContent.trim()} ${sellerCity.textContent.trim()}` : null,
          sellerCountry?.textContent.trim()
        ].filter(Boolean).join(", ");
        if(sellerAddressParts) {
          document.getElementById("sellerAddress").textContent = sellerAddressParts;
          invoiceData.seller.address = sellerAddressParts;
        }

        if(sellerEmail) {
          const email = sellerEmail.textContent.trim();
          document.getElementById("sellerEmail").textContent = email;
          invoiceData.seller.email = email;
        }

        if(sellerPhone) {
          const phone = sellerPhone.textContent.trim();
          document.getElementById("sellerPhone").textContent = phone;
          invoiceData.seller.phone = phone;
        }

        const taxInfo = [
          sellerTaxVA ? `VA: ${sellerTaxVA.textContent.trim()}` : null,
          sellerTaxFC ? `FC: ${sellerTaxFC.textContent.trim()}` : null
        ].filter(Boolean).join("\n");
        if(taxInfo) {
          document.getElementById("sellerTaxID").textContent = taxInfo;
          invoiceData.seller.taxId = taxInfo;
        }

        if(sellerRegister) {
          const register = sellerRegister.textContent.trim();
          document.getElementById("sellerRegister").textContent = register;
          invoiceData.seller.register = register;
        }

        sellerSection.classList.remove('hidden');
      }

      function displayBuyerInfo(selectNode) {
        const buyerName = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:Name");
        const buyerStreet = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:LineOne");
        const buyerCity = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:CityName");
        const buyerZip = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:PostcodeCode");
        const buyerCountry = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:CountryID");
        const buyerEmail = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:DefinedTradeContact/ram:EmailURIUniversalCommunication/ram:URIID");
        const buyerPhone = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:DefinedTradeContact/ram:TelephoneUniversalCommunication/ram:CompleteNumber");
        const buyerTaxVA = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:SpecifiedTaxRegistration/ram:ID[@schemeID='VA']");
        const buyerTaxFC = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:SpecifiedTaxRegistration/ram:ID[@schemeID='FC']");

        invoiceData.buyer = {};
        
        if(buyerName) {
          const name = buyerName.textContent.trim();
          document.getElementById("buyerName").textContent = name;
          invoiceData.buyer.name = name;
        }

        const buyerAddressParts = [
          buyerStreet?.textContent.trim(),
          (buyerZip && buyerCity) ? `${buyerZip.textContent.trim()} ${buyerCity.textContent.trim()}` : null,
          buyerCountry?.textContent.trim()
        ].filter(Boolean).join(", ");
        if(buyerAddressParts) {
          document.getElementById("buyerAddress").textContent = buyerAddressParts;
          invoiceData.buyer.address = buyerAddressParts;
        }

        if(buyerEmail) {
          const email = buyerEmail.textContent.trim();
          document.getElementById("buyerEmail").textContent = email;
          invoiceData.buyer.email = email;
        }

        if(buyerPhone) {
          const phone = buyerPhone.textContent.trim();
          document.getElementById("buyerPhone").textContent = phone;
          invoiceData.buyer.phone = phone;
        }

        const taxInfo = [
          buyerTaxVA ? `VA: ${buyerTaxVA.textContent.trim()}` : null,
          buyerTaxFC ? `FC: ${buyerTaxFC.textContent.trim()}` : null
        ].filter(Boolean).join("\n");
        if(taxInfo) {
          document.getElementById("buyerTaxID").textContent = taxInfo;
          invoiceData.buyer.taxId = taxInfo;
        }

        buyerSection.classList.remove('hidden');
      }

      function displayPaymentInfo(selectNode, selectNodes) {
        const paymentMeans = selectNode(xmlDoc, "//ram:ApplicableHeaderTradeSettlement/ram:SpecifiedTradeSettlementPaymentMeans");
        const paymentTerms = selectNode(xmlDoc, "//ram:SpecifiedTradePaymentTerms/ram:Description");
        let currencySymbol = "‚Ç¨"; // Standard-W√§hrung

        invoiceData.payment = {};

        if(paymentMeans) {
          // W√§hrung
          const currencyNode = selectNode(xmlDoc, "//ram:ApplicableHeaderTradeSettlement/ram:InvoiceCurrencyCode");
          let currencyCode = "EUR";
          if(currencyNode) {
            currencyCode = currencyNode.textContent.trim();
            document.getElementById("currency").textContent = currencyCode;
            currencySymbol = getCurrencySymbol(currencyCode);
            invoiceData.payment.currency = currencyCode;
          }

          // Zahlungsart
          const paymentTypeCode = selectNode(paymentMeans, ".//ram:TypeCode");
          if(paymentTypeCode) {
            const paymentType = getPaymentTypeName(paymentTypeCode.textContent.trim());
            document.getElementById("paymentType").textContent = paymentType;
            invoiceData.payment.type = paymentType;
          }

          // IBAN
          const iban = selectNode(paymentMeans, ".//ram:PayerPartyCreditorFinancialAccount/ram:IBANID | .//ram:PayeePartyCreditorFinancialAccount/ram:IBANID");
          if(iban) {
            const ibanValue = iban.textContent.trim();
            document.getElementById("iban").textContent = ibanValue;
            invoiceData.payment.iban = ibanValue;
          }

          // BIC
          const bic = selectNode(paymentMeans, ".//ram:PayeeSpecifiedCreditorFinancialInstitution/ram:BICID | .//ram:PayeePartyCreditorFinancialInstitution/ram:BICID");
          if(bic) {
            const bicValue = bic.textContent.trim();
            document.getElementById("bic").textContent = bicValue;
            invoiceData.payment.bic = bicValue;
          }

          // Kontoinhaber
          const accountHolder = selectNode(paymentMeans, ".//ram:PayeePartyCreditorFinancialAccount/ram:AccountName");
          if(accountHolder) {
            const holder = accountHolder.textContent.trim();
            document.getElementById("accountHolder").textContent = holder;
            invoiceData.payment.accountHolder = holder;
          }
        }

        // Zahlungsziel
        if(paymentTerms) {
          const terms = paymentTerms.textContent.trim();
          document.getElementById("paymentTerms").textContent = terms;
          invoiceData.payment.terms = terms;
        }

        // Monet√§re Summen
        const monetarySummation = selectNode(xmlDoc, "//ram:ApplicableHeaderTradeSettlement/ram:SpecifiedTradeSettlementMonetarySummation | //ram:ApplicableHeaderTradeSettlement/ram:SpecifiedTradeSettlementHeaderMonetarySummation");
        if(monetarySummation) {
          const netAmountNode = selectNode(monetarySummation, ".//ram:LineTotalAmount");
          const taxAmountNode = selectNode(monetarySummation, ".//ram:TaxTotalAmount");
          const grossAmountNode = selectNode(monetarySummation, ".//ram:GrandTotalAmount");
          const dueAmountNode = selectNode(monetarySummation, ".//ram:DuePayableAmount");

          if(netAmountNode) {
            const netAmount = netAmountNode.textContent.trim();
            const formattedNet = formatCurrency(netAmount, currencySymbol);
            document.getElementById("netAmount").textContent = formattedNet;
            invoiceData.payment.netAmount = parseFloat(netAmount);
          }

          if(taxAmountNode) {
            const taxAmount = taxAmountNode.textContent.trim();
            const formattedTax = formatCurrency(taxAmount, currencySymbol);
            document.getElementById("taxAmount").textContent = formattedTax;
            invoiceData.payment.taxAmount = parseFloat(taxAmount);
          }

          if(grossAmountNode) {
            const grossAmount = grossAmountNode.textContent.trim();
            const formattedGross = formatCurrency(grossAmount, currencySymbol);
            document.getElementById("grossAmount").textContent = formattedGross;
            invoiceData.payment.grossAmount = parseFloat(grossAmount);
          }

          if(dueAmountNode) {
            const dueAmount = dueAmountNode.textContent.trim();
            const formattedDue = formatCurrency(dueAmount, currencySymbol);
            document.getElementById("dueAmount").textContent = formattedDue;
            invoiceData.payment.dueAmount = parseFloat(dueAmount);
          }
        }

        paymentSection.classList.remove('hidden');
      }

      function displayLineItems(selectNode, selectNodes) {
        const lineItems = selectNodes(xmlDoc, "//ram:IncludedSupplyChainTradeLineItem");
        const tbody = lineItemsTable.querySelector("tbody");
        let calculatedTotalNet = 0;

        invoiceData.lineItems = [];

        lineItems.forEach((item, index) => {
          const lineID = selectNode(item, "./ram:AssociatedDocumentLineDocument/ram:LineID")?.textContent.trim() || (index + 1).toString();
          const productNote = selectNode(item, "./ram:AssociatedDocumentLineDocument/ram:IncludedNote/ram:Content")?.textContent.trim() || "";
          const productName = selectNode(item, "./ram:SpecifiedTradeProduct/ram:Name")?.textContent.trim() || "";
          const productDesc = selectNode(item, "./ram:SpecifiedTradeProduct/ram:Description")?.textContent.trim() || "";
          const qtyElement = selectNode(item, "./ram:SpecifiedLineTradeDelivery/ram:BilledQuantity");
          const qtyText = qtyElement?.textContent.trim() || "0";
          const quantity = parseFloat(qtyText);
          const unit = qtyElement?.getAttribute('unitCode') || "";
          const netPricePerUnit = parseFloat(selectNode(item, "./ram:SpecifiedLineTradeAgreement/ram:NetPriceProductTradePrice/ram:ChargeAmount")?.textContent.trim() || "0");
          const taxRateText = selectNode(item, "./ram:SpecifiedLineTradeSettlement/ram:ApplicableTradeTax/ram:RateApplicablePercent")?.textContent.trim() || "0";
          const taxRate = parseFloat(taxRateText);
          const lineNet = netPricePerUnit * quantity;
          const vatAmount = lineNet * (taxRate / 100);
          const lineGross = lineNet + vatAmount;

          calculatedTotalNet += lineNet;

          // Daten f√ºr Export speichern
          invoiceData.lineItems.push({
            position: lineID,
            productName,
            description: productDesc,
            notes: productNote,
            quantity,
            unit,
            unitPrice: netPricePerUnit,
            lineNet,
            taxRate,
            lineGross
          });

          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${escapeHtml(lineID)}</td>
            <td>${escapeHtml(productName)}</td>
            <td>${escapeHtml(productDesc)}</td>
            <td>${escapeHtml(productNote)}</td>
            <td>${escapeHtml(quantity.toFixed(2))}</td>
            <td>${escapeHtml(unit)}</td>
            <td>${formatCurrency(netPricePerUnit.toFixed(2), getCurrencySymbol(document.getElementById("currency").textContent.trim() || 'EUR'))}</td>
            <td>${formatCurrency(lineNet.toFixed(2), getCurrencySymbol(document.getElementById("currency").textContent.trim() || 'EUR'))}</td>
            <td>${escapeHtml(taxRate.toFixed(2))}%</td>
            <td>${formatCurrency(lineGross.toFixed(2), getCurrencySymbol(document.getElementById("currency").textContent.trim() || 'EUR'))}</td>
          `;

          tbody.appendChild(tr);
        });

        if(lineItems.length > 0) {
          const netAmountDisplay = document.getElementById("netAmount");
          if(!netAmountDisplay.textContent) {
            netAmountDisplay.textContent = formatCurrency(calculatedTotalNet.toFixed(2), getCurrencySymbol(document.getElementById("currency").textContent.trim() || 'EUR'));
          }
          lineItemsSection.classList.remove('hidden');
        }

        return lineItems.length;
      }

      function showLoading() {
        loadingSection.classList.remove('hidden');
      }

      function hideLoading() {
        loadingSection.classList.add('hidden');
      }

      function showSuccess() {
        successSection.classList.remove('hidden');
        setTimeout(() => successSection.classList.add('hidden'), 3000);
      }

      function displayStatistics(lineItemsCount) {
        document.getElementById('statLineItems').textContent = lineItemsCount;
        document.getElementById('statNetAmount').textContent = document.getElementById('netAmount').textContent || '0 ‚Ç¨';
        document.getElementById('statTaxAmount').textContent = document.getElementById('taxAmount').textContent || '0 ‚Ç¨';
        document.getElementById('statGrossAmount').textContent = document.getElementById('grossAmount').textContent || '0 ‚Ç¨';
        statsSection.classList.remove('hidden');
      }

      function formatDate(dateStr) {
        if (/^\d{8}$/.test(dateStr)) {
          return `${dateStr.slice(6,8)}.${dateStr.slice(4,6)}.${dateStr.slice(0,4)}`;
        }
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
          const [year, month, day] = dateStr.split('-');
          return `${day}.${month}.${year}`;
        }
        return dateStr;
      }

      function getPaymentTypeName(code) {
        const paymentTypes = {
          '1': 'Instrumentenbasierte Zahlung',
          '10': 'Barzahlung',
          '20': 'Scheck',
          '30': '√úberweisung',
          '31': 'Abbuchung',
          '42': 'Zahlung an ein Bankkonto',
          '48': 'Kartenzahlung',
          '49': 'Lastschrift',
          '58': 'SEPA-√úberweisung',
          '59': 'SEPA-Lastschrift'
        };
        return paymentTypes[code] || `Unbekannt (${code})`;
      }

      function downloadInvoiceAsJson() {
        const jsonData = JSON.stringify(invoiceData, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const filename = `invoice_${invoiceData.header?.number || 'unknown'}.json`;
        downloadBlob(blob, filename);
      }

      function downloadInvoiceAsCsv() {
        if (!invoiceData.lineItems || invoiceData.lineItems.length === 0) {
          alert('Keine Positionen zum Exportieren verf√ºgbar.');
          return;
        }

        // CSV Header
        const headers = ['Position', 'Produktname', 'Beschreibung', 'Notiz', 'Menge', 'Einheit', 'Einzelpreis', 'Zeilen-Netto', 'Steuersatz', 'Zeilenbrutto'];
        
        // CSV Daten
        const csvData = [
          headers.join(','),
          ...invoiceData.lineItems.map(item => [
            `"${item.position}"`,
            `"${item.productName}"`,
            `"${item.description}"`,
            `"${item.notes}"`,
            item.quantity,
            `"${item.unit}"`,
            item.unitPrice.toFixed(2),
            item.lineNet.toFixed(2),
            item.taxRate.toFixed(2),
            item.lineGross.toFixed(2)
          ].join(','))
        ].join('\n');

        const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
        const filename = `invoice_${invoiceData.header?.number || 'unknown'}_positions.csv`;
        downloadBlob(blob, filename);
      }

      function showError(msg) {
        errorSection.textContent = msg;
        errorSection.classList.remove("hidden");
      }

      function resetUI() {
        // Fehler- und Anzeigeabschnitte zur√ºcksetzen
        errorSection.textContent = "";
        errorSection.classList.add("hidden");
        successSection.classList.add("hidden");

        [headerSection, sellerSection, buyerSection, paymentSection, lineItemsSection, xmlViewer, downloadButtons, statsSection].forEach(section => section.classList.add('hidden'));

        // Inhalt der Tabellen und Bereiche zur√ºcksetzen
        document.querySelectorAll("#headerSection td, #sellerSection td, #buyerSection td, #paymentSection td").forEach(td => td.textContent = "");
        originalXml.textContent = "";
        lineItemsTable.querySelector("tbody").innerHTML = "";
        
        // Daten zur√ºcksetzen
        invoiceData = {};
      }

      function beautifyXml(xml) {
        const PADDING = '  ';
        const reg = /(>)(<)(\/*)/g;
        let formatted = '';
        let pad = 0;

        xml = xml.replace(reg, '$1\r\n$2$3');
        xml.split('\r\n').forEach(node => {
          let indent = 0;
          if (node.match(/.+<\/\w[^>]*>$/)) {
            indent = 0;
          } else if (node.match(/^<\/\w/)) {
            if (pad !== 0) pad -= 1;
          } else if (node.match(/^<\w[^>]*[^\/]>.*$/)) {
            indent = 1;
          }

          formatted += PADDING.repeat(pad) + node.trim() + '\r\n';
          pad += indent;
        });

        return formatted;
      }

      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function getCurrencySymbol(code) {
        const symbols = {
          'EUR': '‚Ç¨',
          'USD': '$',
          'GBP': '¬£',
          'CHF': 'CHF',
          // Weitere W√§hrungen k√∂nnen hier hinzugef√ºgt werden
        };
        return symbols[code] || code;
      }

      function formatCurrency(amount, currencySymbol) {
        const formattedAmount = parseFloat(amount).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        switch(currencySymbol) {
          case 'CHF':
            return `${formattedAmount} ${currencySymbol}`;
          case '‚Ç¨':
            return `${formattedAmount} ${currencySymbol}`;
          case '$':
            return `${currencySymbol}${formattedAmount}`;
          case '¬£':
            return `${currencySymbol}${formattedAmount}`;
          default:
            return `${formattedAmount} ${currencySymbol}`;
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

    })();
  </script>
</body>
</html>
