<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ZUGFeRD / XRechnung / EN16931 E-Rechnungs-Reader inkl. PDF-Extraktion</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.6.172/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.6;
      background: #f7f7f7;
    }

    h1, h2 {
      margin-bottom: 0.5em;
    }

    h1 {
      font-size: 2em;
      margin-top: 0;
      color: #333;
      flex: 1;
    }

    /* Language Switcher */
    .language-switcher {
      display: flex;
      gap: 5px;
    }

    .lang-btn {
      padding: 8px 15px;
      border: 2px solid #007BFF;
      background: #fff;
      color: #007BFF;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .lang-btn:hover {
      background: #f0f8ff;
      transform: scale(1.05);
    }

    .lang-btn.active {
      background: #007BFF;
      color: #fff;
    }

    .description, section, details {
      background: #fff;
      padding: 20px;
      margin-bottom: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .drop-zone {
      border: 2px dashed #aaa;
      border-radius: 5px;
      padding: 40px;
      text-align: center;
      color: #333;
      background: #fff;
      margin-bottom: 20px;
      transition: border-color 0.3s, background-color 0.3s;
      cursor: pointer;
      position: relative;
    }

    .drop-zone.dragover {
      border-color: #007BFF;
      background-color: #f0f8ff;
    }

    .drop-zone p {
      margin: 0;
      font-size: 1.1em;
    }

    .hidden {
      display: none;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
    }

    table th, table td {
      border: 1px solid #ccc;
      padding: 8px;
      vertical-align: top;
    }

    table th {
      background: #f0f0f0;
      text-align: left;
      width: 12.5%;
    }

    .zugferd-tag {
      font-size: 0.75em;
      color: #666;
      margin-left: 4px;
      opacity: 0.8;
    }

    .error {
      color: red;
      background-color: #ffe6e6;
      padding: 10px;
      border-radius: 5px;
    }

    .download-buttons {
      margin-bottom: 20px;
      text-align: center;
    }

    .download-buttons button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #007BFF;
      color: white;
      transition: background-color 0.3s, transform 0.2s;
    }

    .download-buttons button:hover {
      background-color: #0056b3;
      transform: scale(1.05);
    }

    .sample-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid #007BFF;
      background-color: #ffffff;
      color: #007BFF;
      font-size: 0.95em;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s, color 0.3s;
    }

    .sample-btn:hover {
      background-color: #e7f1ff;
      color: #0056b3;
      transform: translateY(-1px);
    }

    /* Copy button styling */
    .copy-btn {
      padding: 3px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #f0f0f0;
      cursor: pointer;
    }
    .copy-btn:hover { background: #e6e6e6; }

    details summary {
      cursor: pointer;
      font-weight: bold;
    }

    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 400px;
      overflow: auto;
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background: #1a1a1a;
        color: #e0e0e0;
      }

      h1 {
        color: #e0e0e0;
      }

      .lang-btn {
        border-color: #0099ff;
        background: #2d2d2d;
        color: #0099ff;
      }

      .lang-btn:hover {
        background: #1a3a5a;
      }

      .lang-btn.active {
        background: #0099ff;
        color: #fff;
      }

      .description, section, details {
        background: #2d2d2d;
        border-color: #444;
        color: #e0e0e0;
      }

      .drop-zone {
        background: #2d2d2d;
        border-color: #555;
        color: #e0e0e0;
      }

      .drop-zone.dragover {
        border-color: #0099ff;
        background-color: #1a3a5a;
      }

      table th {
        background: #383838;
        color: #e0e0e0;
      }

      table th, table td {
        border-color: #555;
      }

      pre {
        background-color: #1e1e1e;
        border-color: #555;
        color: #e0e0e0;
      }

      .zugferd-tag {
        color: #adb5bd;
      }

      .error {
        background-color: #4a1a1a;
        color: #ff9999;
      }
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007BFF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Improved table responsiveness */
    .table-container {
      overflow-x: auto;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    /* Success message */
    .success {
      color: #155724;
      background-color: #d4edda;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #c3e6cb;
      margin-bottom: 20px;
    }

    /* Statistics section */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #dee2e6;
      text-align: center;
    }

    .stat-card h3 {
      margin: 0 0 10px 0;
      font-size: 1.2em;
      color: #495057;
    }

    .stat-card .value {
      font-size: 1.5em;
      font-weight: bold;
      color: #007BFF;
    }

    @media (prefers-color-scheme: dark) {
      .stat-card {
        background: #343a40;
        border-color: #495057;
      }

      .stat-card h3 {
        color: #adb5bd;
      }

      .success {
        color: #b8e6b8;
        background-color: #155724;
        border-color: #28a745;
      }

      .table-container {
        border-color: #555;
      }
    }

    @media (max-width: 768px) {
      table th, table td {
        font-size: 0.9em;
      }

      .drop-zone {
        padding: 20px;
      }

      .download-buttons button {
        width: 100%;
        margin: 10px 0;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    /* EPC QR Code Styles */
    .qr-section {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }

    .qr-section h3 {
      margin: 0 0 15px 0;
      color: #495057;
      font-size: 1.2em;
    }

    .qr-code-container {
      display: inline-block;
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
    }

    .qr-info {
      font-size: 0.9em;
      color: #666;
      line-height: 1.4;
    }

    .qr-info strong {
      color: #333;
    }

    @media (prefers-color-scheme: dark) {
      .qr-section {
        background: #343a40;
        border-color: #495057;
      }

      .qr-section h3 {
        color: #adb5bd;
      }

      .qr-code-container {
        background: #fff;
      }

      .qr-info {
        color: #adb5bd;
      }

      .qr-info strong {
        color: #fff;
      }
    }
  </style>
</head>
<body>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1 id="mainTitle">E-Rechnungs-Reader (ZUGFeRD, XRechnung, EN16931) mit PDF-Extraktion</h1>
    <div class="language-switcher">
      <button id="langDe" class="lang-btn active">üá©üá™ DE</button>
      <button id="langEn" class="lang-btn">üá∫üá∏ EN</button>
    </div>
  </div>

  <section class="description">
    <h2 id="descriptionTitle">Beschreibung</h2>
    <p id="descriptionText">Dieses Tool erm√∂glicht das Anzeigen von elektronischen Rechnungen im XML-Format sowie ZUGFeRD-PDF/A-3-Dateien. Die eingebettete XML-Datei in ZUGFeRD-PDFs wird automatisch extrahiert und die Rechnungsdaten werden strukturiert dargestellt.</p>
    <p id="disclaimerText"><strong>Hinweis:</strong> Dieses Tool verarbeitet elektronische Rechnungen (z. B. ZUGFeRD, XRechnung) vollst√§ndig clientseitig im Browser. Die Dateien werden nicht hochgeladen oder gespeichert.<br/>Es wird keine Gew√§hr f√ºr die Richtigkeit, Vollst√§ndigkeit oder Rechtskonformit√§t der angezeigten Daten √ºbernommen. Jegliche Haftung f√ºr Sch√§den oder Verluste, die aus der Nutzung resultieren, ist ausgeschlossen. Die Verantwortung f√ºr die korrekte Verarbeitung und Pr√ºfung der Daten liegt beim Nutzer.</p>
  </section>

  <div class="drop-zone" id="dropZone">
    <p id="dropZoneText">üìÑ Datei hierher ziehen und fallen lassen oder klicken, um eine Datei auszuw√§hlen.</p>
    <p id="supportedFormatsText" style="font-size: 0.9em; color: #666; margin-top: 10px;">Unterst√ºtzte Formate: ZUGFeRD PDF, XRechnung XML, EN16931 XML</p>
    <input type="file" id="invoiceFile" accept=".xml,.pdf,application/pdf" style="display:none;" />
    <div style="margin-top: 12px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
      <button id="loadSampleBtn" type="button" class="sample-btn">üß™ Beispiel-Rechnung laden</button>
    </div>
  </div>

  <div id="loadingSection" class="hidden" style="text-align: center; padding: 20px;">
    <div class="loading"></div>
    <span id="loadingText">Verarbeitung l√§uft...</span>
  </div>

  <div id="successSection" class="success hidden">
    <span id="successText">‚úÖ Rechnung erfolgreich verarbeitet!</span>
  </div>

  <section id="statsSection" class="hidden">
    <h2 id="statsTitle">üìä Statistiken</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <h3 id="statPositionsLabel">Positionen</h3>
        <div class="value" id="statLineItems">0</div>
      </div>
      <div class="stat-card">
        <h3 id="statNetLabel">Nettosumme</h3>
        <div class="value" id="statNetAmount">0 ‚Ç¨</div>
      </div>
      <div class="stat-card">
        <h3 id="statTaxLabel">Steuern</h3>
        <div class="value" id="statTaxAmount">0 ‚Ç¨</div>
      </div>
      <div class="stat-card">
        <h3 id="statGrossLabel">Bruttosumme</h3>
        <div class="value" id="statGrossAmount">0 ‚Ç¨</div>
      </div>
    </div>
  </section>

  <div class="download-buttons hidden" id="downloadButtons">
    <button id="downloadXml">üìÑ XML speichern</button>
    <button id="downloadPdf">üìã PDF speichern</button>
    <button id="downloadJson">üìä JSON Export</button>
    <button id="downloadCsv">üìà CSV Export</button>
  </div>

  <details id="xmlViewer" class="hidden">
    <summary>XML anzeigen</summary>
    <pre id="originalXml"></pre>
  </details>

  <section id="errorSection" class="error hidden"></section>

  <section id="headerSection" class="hidden">
    <h2 id="invoiceInfoTitle">üìã Rechnungsinformationen</h2>
    <div class="table-container">
      <table>
        <tr><th id="invNumberLabel">Rechnungsnummer</th><td id="invNumber"></td></tr>
        <tr><th id="invTypeLabel">Rechnungstyp</th><td id="invType"></td></tr>
        <tr><th id="invDateLabel">Rechnungsdatum</th><td id="invDate"></td></tr>
        <tr><th id="invDueDateLabel">F√§lligkeitsdatum</th><td id="invDueDate"></td></tr>
        <tr><th id="invOrderNumberLabel">Bestellnummer</th><td id="invOrderNumber"></td></tr>
        <tr><th id="invNoteLabel">Notiz</th><td id="invNote"></td></tr>
      </table>
    </div>
  </section>

  <section id="sellerSection" class="hidden">
    <h2 id="sellerInfoTitle">üè¢ Verk√§ufer / Rechnungssteller</h2>
    <div class="table-container">
      <table>
        <tr><th id="sellerNameLabel">Name</th><td id="sellerName"></td></tr>
        <tr><th id="sellerAddressLabel">Adresse</th><td id="sellerAddress"></td></tr>
        <tr><th id="sellerEmailLabel">E-Mail</th><td id="sellerEmail"></td></tr>
        <tr><th id="sellerPhoneLabel">Telefon</th><td id="sellerPhone"></td></tr>
        <tr><th id="sellerTaxIDLabel">Steuer-ID</th><td id="sellerTaxID"></td></tr>
        <tr><th id="sellerRegisterLabel">Handelsregister</th><td id="sellerRegister"></td></tr>
      </table>
    </div>
  </section>

  <section id="buyerSection" class="hidden">
    <h2 id="buyerInfoTitle">üë§ K√§ufer / Rechnungsempf√§nger</h2>
    <div class="table-container">
      <table>
        <tr><th id="buyerNameLabel">Name</th><td id="buyerName"></td></tr>
        <tr><th id="buyerAddressLabel">Adresse</th><td id="buyerAddress"></td></tr>
        <tr><th id="buyerAddress2Label">Adresszusatz</th><td id="buyerAddress2"></td></tr>
        <tr><th id="buyerEmailLabel">E-Mail</th><td id="buyerEmail"></td></tr>
        <tr><th id="buyerPhoneLabel">Telefon</th><td id="buyerPhone"></td></tr>
        <tr><th id="buyerTaxIDLabel">Steuer-ID</th><td id="buyerTaxID"></td></tr>
      </table>
    </div>
  </section>

  <section id="paymentSection" class="hidden">
    <h2 id="paymentInfoTitle">üí≥ Zahlungsinformationen</h2>
    <div class="table-container">
      <table>
        <tr><th id="currencyLabel">W√§hrung</th><td id="currency"></td></tr>
        <tr><th id="paymentTypeLabel">Zahlungsart</th><td id="paymentType"></td></tr>
        <tr><th id="paymentTermsLabel">Zahlungsziel</th><td id="paymentTerms"></td></tr>
        <tr><th id="ibanLabel">IBAN</th><td id="iban"></td></tr>
        <tr><th id="bicLabel">BIC</th><td id="bic"></td></tr>
        <tr><th id="accountHolderLabel">Kontoinhaber</th><td id="accountHolder"></td></tr>
        <tr><th id="netAmountLabel">Gesamt netto</th><td id="netAmount"></td></tr>
        <tr><th id="taxAmountLabel">Steuerbetrag</th><td id="taxAmount"></td></tr>
        <tr><th id="grossAmountLabel">Gesamt brutto</th><td id="grossAmount"></td></tr>
        <tr><th id="dueAmountLabel">F√§lliger Betrag</th><td id="dueAmount"></td></tr>
      </table>
    </div>
    
    <!-- EPC QR Code Section -->
    <div id="qrCodeSection" class="qr-section hidden">
      <h3 id="qrCodeTitle">üì± QR-Code f√ºr √úberweisung</h3>
      <div class="qr-code-container"></div>
      <div class="qr-info">
        <div id="qrCodeInfo">
          <strong id="qrCodeInfoTitle">Zum Bezahlen einfach QR-Code mit Banking-App scannen</strong><br>
          <span id="qrCodeDetails">EPC-QR-Code (Girocode) nach europ√§ischem Standard</span>
        </div>
        <div style="margin-top:10px;">
          <button id="downloadQrBtn" type="button">QR-Code speichern</button>
        </div>
      </div>
    </div>
  </section>

  <section id="lineItemsSection" class="hidden">
    <h2 id="lineItemsTitle">üì¶ Positionen</h2>
    <div class="table-container">
      <table id="lineItemsTable">
        <thead>
          <tr>
            <th data-key="posNr" id="posNrHeader">Pos.-Nr.</th>
            <th data-key="productName" id="productNameHeader">Produktname</th>
            <th data-key="description" id="descriptionHeader">Beschreibung</th>
            <th data-key="notes" id="notesHeader">Notiz</th>
            <th data-key="quantity" id="quantityHeader">Menge</th>
            <th data-key="unit" id="unitHeader">Einheit</th>
            <th data-key="unitPrice" id="unitPriceHeader">Einzelpreis</th>
            <th data-key="lineNet" id="lineNetHeader">Zeilen-Netto</th>
            <th data-key="taxRate" id="taxRateHeader">Steuersatz</th>
            <th data-key="lineGross" id="lineGrossHeader">Zeilenbrutto</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <script>
    (function() {
      "use strict";

      // Configure PDF.js worker for reliability when parsing attachments
      if (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.6.172/pdf.worker.min.js';
      }

      // Helper: get current language labels anywhere in the script
      function getLabels() {
        return labels[currentLanguage] || labels.de;
      }

      // IBAN utilities: validation (ISO 13616 mod-97) and formatting for display
      function isValidIBAN(iban) {
        if (!iban) return false;
        const cleaned = iban.replace(/\s+/g, '').toUpperCase();
        if (!/^[A-Z]{2}\d{2}[A-Z0-9]{1,30}$/.test(cleaned)) return false;
        const rearranged = cleaned.slice(4) + cleaned.slice(0, 4);
        const expanded = rearranged.replace(/[A-Z]/g, c => (c.charCodeAt(0) - 55).toString());
        let remainder = 0;
        for (let i = 0; i < expanded.length; i += 7) {
          const block = remainder.toString() + expanded.substr(i, 7);
          remainder = parseInt(block, 10) % 97;
        }
        return remainder === 1;
      }

      function formatIbanForDisplay(iban) {
        return iban.replace(/\s+/g, '').replace(/(.{4})/g, '$1 ').trim();
      }

      function attachCopyButton(cellId) {
        const cell = document.getElementById(cellId);
        if (!cell) return;
        // avoid duplicating button
        if (cell.querySelector('button.copy-btn')) return;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'copy-btn';
        btn.style.marginLeft = '8px';
        btn.style.fontSize = '0.85em';
        btn.textContent = (currentLanguage === 'en') ? 'Copy' : 'Kopieren';
        btn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(cell.firstChild?.textContent?.trim() || '');
            const old = btn.textContent;
            btn.textContent = (currentLanguage === 'en') ? 'Copied!' : 'Kopiert!';
            setTimeout(() => { btn.textContent = old; }, 1200);
          } catch (e) {
            console.error('Clipboard failed', e);
          }
        });
        cell.appendChild(btn);
      }

      // DOM-Elemente
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('invoiceFile');
  const loadSampleBtn = document.getElementById('loadSampleBtn');
      const loadingSection = document.getElementById('loadingSection');
      const successSection = document.getElementById('successSection');
      const errorSection = document.getElementById('errorSection');
      const statsSection = document.getElementById('statsSection');
      const headerSection = document.getElementById('headerSection');
      const sellerSection = document.getElementById('sellerSection');
      const buyerSection = document.getElementById('buyerSection');
      const paymentSection = document.getElementById('paymentSection');
      const lineItemsSection = document.getElementById('lineItemsSection');
      const xmlViewer = document.getElementById('xmlViewer');
      const originalXml = document.getElementById('originalXml');
      const downloadButtons = document.getElementById('downloadButtons');
      const downloadXmlButton = document.getElementById('downloadXml');
      const downloadPdfButton = document.getElementById('downloadPdf');
      const downloadJsonButton = document.getElementById('downloadJson');
      const downloadCsvButton = document.getElementById('downloadCsv');
      const lineItemsTable = document.getElementById('lineItemsTable');
      const tableHeaders = lineItemsTable.querySelectorAll('th');

      // Globale Variablen
      let xmlDoc = null;
      let originalPdfBlob = null;
      let originalXmlBlob = null;
      // Initiale Sprachvariable
      let currentLanguage = 'de'; // Standard: Deutsch
      let invoiceData = {}; // F√ºr JSON/CSV Export

      // Mehrsprachige Labels
      const labels = {
        de: {
          // UI Texte
          mainTitle: "E-Rechnungs-Reader (ZUGFeRD, XRechnung, EN16931) mit PDF-Extraktion",
          descriptionTitle: "Beschreibung",
          descriptionText: "Dieses Tool erm√∂glicht das Anzeigen von elektronischen Rechnungen im XML-Format sowie ZUGFeRD-PDF/A-3-Dateien. Die eingebettete XML-Datei in ZUGFeRD-PDFs wird automatisch extrahiert und die Rechnungsdaten werden strukturiert dargestellt.",
          disclaimerText: "<strong>Hinweis:</strong> Dieses Tool verarbeitet elektronische Rechnungen (z. B. ZUGFeRD, XRechnung) vollst√§ndig clientseitig im Browser. Die Dateien werden nicht hochgeladen oder gespeichert.<br/>Es wird keine Gew√§hr f√ºr die Richtigkeit, Vollst√§ndigkeit oder Rechtskonformit√§t der angezeigten Daten √ºbernommen. Jegliche Haftung f√ºr Sch√§den oder Verluste, die aus der Nutzung resultieren, ist ausgeschlossen. Die Verantwortung f√ºr die korrekte Verarbeitung und Pr√ºfung der Daten liegt beim Nutzer.",
          dropZoneText: "üìÑ Datei hierher ziehen und fallen lassen oder klicken, um eine Datei auszuw√§hlen.",
          supportedFormatsText: "Unterst√ºtzte Formate: ZUGFeRD PDF, XRechnung XML, EN16931 XML",
          loadingText: "Verarbeitung l√§uft...",
          successText: "‚úÖ Rechnung erfolgreich verarbeitet!",
          
          // Tabellen-Header
          posNr: "Pos.-Nr.",
          productName: "Produktname",
          description: "Beschreibung",
          notes: "Notiz",
          quantity: "Menge",
          unit: "Einheit",
          unitPrice: "Einzelpreis",
          lineNet: "Zeilen-Netto",
          taxRate: "Steuersatz",
          lineGross: "Zeilenbrutto",
          
          // Sektionen
          xmlViewerSummary: "XML anzeigen",
          invoiceInfo: "üìã Rechnungsinformationen",
          sellerInfo: "üè¢ Verk√§ufer / Rechnungssteller",
          buyerInfo: "üë§ K√§ufer / Rechnungsempf√§nger",
          paymentInfo: "üí≥ Zahlungsinformationen",
          lineItems: "üì¶ Positionen",
          statistics: "üìä Statistiken",
          
          // Buttons
          downloadXml: "üìÑ XML speichern",
          downloadPdf: "üìã PDF speichern",
          downloadJson: "üìä JSON Export",
          downloadCsv: "üìà CSV Export",
          
          // Felder
          invNumber: "Rechnungsnummer",
          invType: "Rechnungstyp",
          invDate: "Rechnungsdatum",
          invDueDate: "F√§lligkeitsdatum",
          invOrderNumber: "Bestellnummer",
          invNote: "Notiz",
          sellerName: "Name",
          sellerAddress: "Adresse",
          sellerEmail: "E-Mail",
          sellerPhone: "Telefon",
          sellerTaxID: "Steuer-ID",
          sellerRegister: "Handelsregister",
          buyerName: "Name",
          buyerAddress: "Adresse",
          buyerAddress2: "Adresszusatz",
          buyerEmail: "E-Mail",
          buyerPhone: "Telefon",
          buyerTaxID: "Steuer-ID",
          currency: "W√§hrung",
          paymentType: "Zahlungsart",
          paymentTerms: "Zahlungsziel",
          iban: "IBAN",
          bic: "BIC",
          accountHolder: "Kontoinhaber",
          netAmount: "Gesamt netto",
          taxAmount: "Steuerbetrag",
          grossAmount: "Gesamt brutto",
          dueAmount: "F√§lliger Betrag",
          
          // Statistiken
          statPositions: "Positionen",
          statNet: "Nettosumme",
          statTax: "Steuern",
          statGross: "Bruttosumme",
          
          // Fehlermeldungen
          noFileFound: "Keine XML-Datei im PDF gefunden.",
          unsupportedFormat: "Dateiformat nicht unterst√ºtzt. Bitte eine PDF (ZUGFeRD) oder XML-Datei hochladen.",
          invalidXml: "Die extrahierte Datei ist keine g√ºltige XML-Rechnung.",
          pdfNotAvailable: "Original-PDF ist nicht verf√ºgbar.",
          processingError: "Fehler beim Verarbeiten der Datei: ",
          noPositionsToExport: "Keine Positionen zum Exportieren verf√ºgbar.",
          
          // QR-Code
          qrCodeTitle: "üì± QR-Code f√ºr √úberweisung",
          qrCodeInfoTitle: "Zum Bezahlen einfach QR-Code mit Banking-App scannen",
          qrCodeDetails: "EPC-QR-Code (Girocode) nach europ√§ischem Standard",
          // Beispiel-Rechnung
          loadSample: "üß™ Beispiel-Rechnung laden",
        },
        en: {
          // UI Texte
          mainTitle: "Electronic Invoice Reader (ZUGFeRD, XRechnung, EN16931) with PDF Extraction",
          descriptionTitle: "Description",
          descriptionText: "This tool allows viewing electronic invoices in XML format as well as ZUGFeRD PDF/A-3 files. The embedded XML file in ZUGFeRD PDFs is automatically extracted and the invoice data is displayed in a structured format.",
          disclaimerText: "<strong>Note:</strong> This tool processes electronic invoices (e.g. ZUGFeRD, XRechnung) completely client-side in the browser. Files are not uploaded or stored.<br/>No warranty is given for the accuracy, completeness or legal compliance of the displayed data. Any liability for damage or loss resulting from use is excluded. The responsibility for correct processing and verification of data lies with the user.",
          dropZoneText: "üìÑ Drag and drop a file here or click to select a file.",
          supportedFormatsText: "Supported formats: ZUGFeRD PDF, XRechnung XML, EN16931 XML",
          loadingText: "Processing...",
          successText: "‚úÖ Invoice processed successfully!",
          
          // Tabellen-Header
          posNr: "No.",
          productName: "Product Name",
          description: "Description",
          notes: "Notes",
          quantity: "Quantity",
          unit: "Unit",
          unitPrice: "Unit Price",
          lineNet: "Line Net",
          taxRate: "Tax Rate",
          lineGross: "Line Gross",
          
          // Sektionen
          xmlViewerSummary: "Show XML",
          invoiceInfo: "üìã Invoice Information",
          sellerInfo: "üè¢ Seller / Issuer",
          buyerInfo: "üë§ Buyer / Recipient",
          paymentInfo: "üí≥ Payment Information",
          lineItems: "üì¶ Line Items",
          statistics: "üìä Statistics",
          
          // Buttons
          downloadXml: "üìÑ Save XML",
          downloadPdf: "üìã Save PDF",
          downloadJson: "üìä JSON Export",
          downloadCsv: "üìà CSV Export",
          
          // Felder
          invNumber: "Invoice Number",
          invType: "Invoice Type",
          invDate: "Invoice Date",
          invDueDate: "Due Date",
          invOrderNumber: "Order Number",
          invNote: "Note",
          sellerName: "Name",
          sellerAddress: "Address",
          sellerEmail: "Email",
          sellerPhone: "Phone",
          sellerTaxID: "Tax ID",
          sellerRegister: "Commercial Register",
          buyerName: "Name",
          buyerAddress: "Address",
          buyerAddress2: "Address line 2",
          buyerEmail: "Email",
          buyerPhone: "Phone",
          buyerTaxID: "Tax ID",
          currency: "Currency",
          paymentType: "Payment Type",
          paymentTerms: "Payment Terms",
          iban: "IBAN",
          bic: "BIC",
          accountHolder: "Account Holder",
          netAmount: "Total Net",
          taxAmount: "Tax Amount",
          grossAmount: "Total Gross",
          dueAmount: "Amount Due",
          
          // Statistiken
          statPositions: "Line Items",
          statNet: "Net Total",
          statTax: "Taxes",
          statGross: "Gross Total",
          
          // Fehlermeldungen
          noFileFound: "No XML file found in the PDF.",
          unsupportedFormat: "Unsupported file format. Please upload a PDF (ZUGFeRD) or XML file.",
          invalidXml: "The extracted file is not a valid XML invoice.",
          pdfNotAvailable: "Original PDF is not available.",
          processingError: "Error processing the file: ",
          noPositionsToExport: "No line items available for export.",
          
          // QR-Code
          qrCodeTitle: "üì± QR Code for Payment",
          qrCodeInfoTitle: "Simply scan QR code with your banking app to pay",
          qrCodeDetails: "EPC QR Code (Girocode) according to European standard",
          // Sample invoice
          loadSample: "üß™ Load sample invoice",
        }
      };

      // Mapping of UI label element IDs to ZUGFeRD / EN16931 BT codes
      // Based on "√úbersichtsliste-Eingabefelder-OZG-RE_092025" (OZG-RE input field overview).
      // Some UI fields aggregate several BT fields (e.g. address), in which case
      // multiple BT codes are listed.
      const zugferdFieldMap = {
        // 1.1 Rechnungsdaten
        invTypeLabel: 'BT-3',
        invNumberLabel: 'BT-1',
        invDateLabel: 'BT-2',
        invDueDateLabel: 'BT-9',
        invOrderNumberLabel: 'BT-13',
        invNoteLabel: 'BT-22',

        // 2.1 Verk√§ufer ‚Äì rechtlicher Name, steuerliche Angaben
        sellerNameLabel: 'BT-27',
        sellerTaxIDLabel: 'BT-31, BT-32',
        sellerRegisterLabel: 'BT-33',

        // 2.3 Postanschrift des Verk√§ufers ‚Äì aggregated into one address field
        // Stra√üe/Hausnummer (BT-35), Postfach (BT-36), PLZ (BT-38), Ort (BT-37),
        // Bundesland (BT-39), Land (BT-40)
        sellerAddressLabel: 'BT-35, BT-36, BT-38, BT-37, BT-39, BT-40',

        // 2.4 Kontaktdaten des Verk√§ufers
        sellerPhoneLabel: 'BT-42',
        sellerEmailLabel: 'BT-43',

        // 3.1 K√§ufer ‚Äì rechtlicher Name, steuerliche Angaben
        buyerNameLabel: 'BT-44',
        buyerTaxIDLabel: 'BT-48',

        // 3.2 Postanschrift des K√§ufers ‚Äì aggregated into one address field
        // Stra√üe/Hausnummer oder Postfach (BT-50), PLZ (BT-53), Ort (BT-52),
        // Bundesland (BT-54), Land (BT-55)
        buyerAddressLabel: 'BT-50, BT-53, BT-52, BT-54, BT-55',

        // 3.2 Adresszusatz
        buyerAddress2Label: 'BT-51',

        // 3.3 Kontaktdaten des K√§ufers
        buyerEmailLabel: 'BT-58',
        buyerPhoneLabel: 'BT-57',

        // 5.4 Rechnungsbetr√§ge
        netAmountLabel: 'BT-106',
        taxAmountLabel: 'BT-110',
        grossAmountLabel: 'BT-112',
        dueAmountLabel: 'BT-115',

        // 1.1 W√§hrung
        currencyLabel: 'BT-5',

        // 6. Zahlungsdaten
        paymentTypeLabel: 'BT-82',
        paymentTermsLabel: 'BT-20',

        // 6.2 Zahlungsmittel: √úberweisung
        accountHolderLabel: 'BT-85',
        ibanLabel: 'BT-84',
        bicLabel: 'BT-86',

        // 4.1 Rechnungspositionen (tabellarische Darstellung der Positionen)
        posNrHeader: 'BT-126',
        productNameHeader: 'BT-153',
        descriptionHeader: 'BT-154',
        quantityHeader: 'BT-129',
        unitHeader: 'BT-130'
      };

      // Sprachenerkennung und Labels setzen
      function setLanguage(lang) {
        currentLanguage = lang;
        try { localStorage.setItem('lang', lang); } catch (_) {}
        const currentLabels = labels[lang];
        
        // UI Elemente aktualisieren
        document.getElementById('mainTitle').textContent = currentLabels.mainTitle;
        document.getElementById('descriptionTitle').textContent = currentLabels.descriptionTitle;
        document.getElementById('descriptionText').textContent = currentLabels.descriptionText;
        document.getElementById('disclaimerText').innerHTML = currentLabels.disclaimerText;
        document.getElementById('dropZoneText').textContent = currentLabels.dropZoneText;
        document.getElementById('supportedFormatsText').textContent = currentLabels.supportedFormatsText;
        document.getElementById('loadingText').textContent = currentLabels.loadingText;
        document.getElementById('successText').textContent = currentLabels.successText;

        // Sprachbuttons aktualisieren
        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(lang === 'de' ? 'langDe' : 'langEn').classList.add('active');

        // Titel setzen
        document.title = currentLabels.mainTitle;

        // Sektionen-Titel
        const statsTitle = document.getElementById('statsTitle');
        const invoiceInfoTitle = document.getElementById('invoiceInfoTitle');
        const sellerInfoTitle = document.getElementById('sellerInfoTitle');
        const buyerInfoTitle = document.getElementById('buyerInfoTitle');
        const paymentInfoTitle = document.getElementById('paymentInfoTitle');
        const lineItemsTitle = document.getElementById('lineItemsTitle');

        if (statsTitle) statsTitle.textContent = currentLabels.statistics;
        if (invoiceInfoTitle) invoiceInfoTitle.textContent = currentLabels.invoiceInfo;
        if (sellerInfoTitle) sellerInfoTitle.textContent = currentLabels.sellerInfo;
        if (buyerInfoTitle) buyerInfoTitle.textContent = currentLabels.buyerInfo;
        if (paymentInfoTitle) paymentInfoTitle.textContent = currentLabels.paymentInfo;
        if (lineItemsTitle) lineItemsTitle.textContent = currentLabels.lineItems;

        // Statistiken Labels
        const statPositionsLabel = document.getElementById('statPositionsLabel');
        const statNetLabel = document.getElementById('statNetLabel');
        const statTaxLabel = document.getElementById('statTaxLabel');
        const statGrossLabel = document.getElementById('statGrossLabel');

        if (statPositionsLabel) statPositionsLabel.textContent = currentLabels.statPositions;
        if (statNetLabel) statNetLabel.textContent = currentLabels.statNet;
        if (statTaxLabel) statTaxLabel.textContent = currentLabels.statTax;
        if (statGrossLabel) statGrossLabel.textContent = currentLabels.statGross;

        // Tabellen-Labels
        updateTableLabels(currentLabels);

        // Download-Buttons
        downloadXmlButton.textContent = currentLabels.downloadXml;
        downloadPdfButton.textContent = currentLabels.downloadPdf;
        downloadJsonButton.textContent = currentLabels.downloadJson;
        downloadCsvButton.textContent = currentLabels.downloadCsv;

        // Sample button label
        if (loadSampleBtn && currentLabels.loadSample) {
          loadSampleBtn.textContent = currentLabels.loadSample;
        }

        // XML Viewer Summary
        const xmlViewerSummary = document.querySelector('#xmlViewer summary');
        if (xmlViewerSummary) {
          xmlViewerSummary.textContent = currentLabels.xmlViewerSummary;
        }

        // QR-Code Labels
        const qrCodeTitle = document.getElementById('qrCodeTitle');
        const qrCodeInfoTitle = document.getElementById('qrCodeInfoTitle');
        const qrCodeDetails = document.getElementById('qrCodeDetails');
        
        if (qrCodeTitle) qrCodeTitle.textContent = currentLabels.qrCodeTitle;
        if (qrCodeInfoTitle) qrCodeInfoTitle.textContent = currentLabels.qrCodeInfoTitle;
        if (qrCodeDetails) qrCodeDetails.textContent = currentLabels.qrCodeDetails;
  const downloadQrBtn = document.getElementById('downloadQrBtn');
  if (downloadQrBtn) downloadQrBtn.textContent = lang === 'de' ? 'QR-Code speichern' : 'Save QR Code';

        // Tabellenkopf f√ºr Line Items
        document.getElementById('posNrHeader').textContent = currentLabels.posNr;
        document.getElementById('productNameHeader').textContent = currentLabels.productName;
        document.getElementById('descriptionHeader').textContent = currentLabels.description;
        document.getElementById('notesHeader').textContent = currentLabels.notes;
        document.getElementById('quantityHeader').textContent = currentLabels.quantity;
        document.getElementById('unitHeader').textContent = currentLabels.unit;
        document.getElementById('unitPriceHeader').textContent = currentLabels.unitPrice;
        document.getElementById('lineNetHeader').textContent = currentLabels.lineNet;
        document.getElementById('taxRateHeader').textContent = currentLabels.taxRate;
        document.getElementById('lineGrossHeader').textContent = currentLabels.lineGross;

        // After all labels are re-rendered, append ZUGFeRD BT tags
        applyZugferdFieldTags();
      }

      function updateTableLabels(currentLabels) {
        // Rechnungsinformationen
        const invNumberLabel = document.getElementById('invNumberLabel');
        const invTypeLabel = document.getElementById('invTypeLabel');
        const invDateLabel = document.getElementById('invDateLabel');
        const invDueDateLabel = document.getElementById('invDueDateLabel');
        const invOrderNumberLabel = document.getElementById('invOrderNumberLabel');
        const invNoteLabel = document.getElementById('invNoteLabel');

        if (invNumberLabel) invNumberLabel.textContent = currentLabels.invNumber;
        if (invTypeLabel) invTypeLabel.textContent = currentLabels.invType;
        if (invDateLabel) invDateLabel.textContent = currentLabels.invDate;
        if (invDueDateLabel) invDueDateLabel.textContent = currentLabels.invDueDate;
        if (invOrderNumberLabel) invOrderNumberLabel.textContent = currentLabels.invOrderNumber;
        if (invNoteLabel) invNoteLabel.textContent = currentLabels.invNote;

        // Verk√§ufer
        const sellerNameLabel = document.getElementById('sellerNameLabel');
        const sellerAddressLabel = document.getElementById('sellerAddressLabel');
        const sellerEmailLabel = document.getElementById('sellerEmailLabel');
        const sellerPhoneLabel = document.getElementById('sellerPhoneLabel');
        const sellerTaxIDLabel = document.getElementById('sellerTaxIDLabel');
        const sellerRegisterLabel = document.getElementById('sellerRegisterLabel');

        if (sellerNameLabel) sellerNameLabel.textContent = currentLabels.sellerName;
        if (sellerAddressLabel) sellerAddressLabel.textContent = currentLabels.sellerAddress;
        if (sellerEmailLabel) sellerEmailLabel.textContent = currentLabels.sellerEmail;
        if (sellerPhoneLabel) sellerPhoneLabel.textContent = currentLabels.sellerPhone;
        if (sellerTaxIDLabel) sellerTaxIDLabel.textContent = currentLabels.sellerTaxID;
        if (sellerRegisterLabel) sellerRegisterLabel.textContent = currentLabels.sellerRegister;

        // K√§ufer
        const buyerNameLabel = document.getElementById('buyerNameLabel');
        const buyerAddressLabel = document.getElementById('buyerAddressLabel');
        const buyerAddress2Label = document.getElementById('buyerAddress2Label');
        const buyerEmailLabel = document.getElementById('buyerEmailLabel');
        const buyerPhoneLabel = document.getElementById('buyerPhoneLabel');
        const buyerTaxIDLabel = document.getElementById('buyerTaxIDLabel');

        if (buyerNameLabel) buyerNameLabel.textContent = currentLabels.buyerName;
        if (buyerAddressLabel) buyerAddressLabel.textContent = currentLabels.buyerAddress;
        if (buyerAddress2Label) buyerAddress2Label.textContent = currentLabels.buyerAddress2;
        if (buyerEmailLabel) buyerEmailLabel.textContent = currentLabels.buyerEmail;
        if (buyerPhoneLabel) buyerPhoneLabel.textContent = currentLabels.buyerPhone;
        if (buyerTaxIDLabel) buyerTaxIDLabel.textContent = currentLabels.buyerTaxID;

        // Zahlungsinformationen
        const currencyLabel = document.getElementById('currencyLabel');
        const paymentTypeLabel = document.getElementById('paymentTypeLabel');
        const paymentTermsLabel = document.getElementById('paymentTermsLabel');
        const ibanLabel = document.getElementById('ibanLabel');
        const bicLabel = document.getElementById('bicLabel');
        const accountHolderLabel = document.getElementById('accountHolderLabel');
        const netAmountLabel = document.getElementById('netAmountLabel');
        const taxAmountLabel = document.getElementById('taxAmountLabel');
        const grossAmountLabel = document.getElementById('grossAmountLabel');
        const dueAmountLabel = document.getElementById('dueAmountLabel');

        if (currencyLabel) currencyLabel.textContent = currentLabels.currency;
        if (paymentTypeLabel) paymentTypeLabel.textContent = currentLabels.paymentType;
        if (paymentTermsLabel) paymentTermsLabel.textContent = currentLabels.paymentTerms;
        if (ibanLabel) ibanLabel.textContent = currentLabels.iban;
        if (bicLabel) bicLabel.textContent = currentLabels.bic;
        if (accountHolderLabel) accountHolderLabel.textContent = currentLabels.accountHolder;
        if (netAmountLabel) netAmountLabel.textContent = currentLabels.netAmount;
        if (taxAmountLabel) taxAmountLabel.textContent = currentLabels.taxAmount;
        if (grossAmountLabel) grossAmountLabel.textContent = currentLabels.grossAmount;
        if (dueAmountLabel) dueAmountLabel.textContent = currentLabels.dueAmount;
      }

      function applyZugferdFieldTags() {
        Object.entries(zugferdFieldMap).forEach(([labelId, btCode]) => {
          if (!btCode) return;
          const labelElement = document.getElementById(labelId);
          if (!labelElement) return;

          // Remove any existing BT tag so we can re-apply on language change
          const existingTag = labelElement.querySelector('.zugferd-tag');
          if (existingTag) {
            existingTag.remove();
          }

          const tagSpan = document.createElement('span');
          tagSpan.className = 'zugferd-tag';
          tagSpan.textContent = ` (${btCode})`;
          labelElement.appendChild(tagSpan);
        });
      }

      function initializeLanguage() {
  // Bevorzugte Sprache aus LocalStorage, sonst aus Browser-Einstellungen
  let savedLang = null;
  try { savedLang = localStorage.getItem('lang'); } catch (_) {}
  const userLang = navigator.language || navigator.userLanguage || 'en';
  const initialLang = savedLang || (userLang.startsWith('de') ? 'de' : 'en');
        setLanguage(initialLang);
      }

      // Variables
      let xmlData = null;
      let lineItems = [];
      let pdfJs = null;
      // currentLanguage = 'de';

      // Event Listeners f√ºr Sprachumschaltung
      document.getElementById('langDe').addEventListener('click', () => setLanguage('de'));
      document.getElementById('langEn').addEventListener('click', () => setLanguage('en'));

      // Beispiel-Rechnung laden
      if (loadSampleBtn) {
        loadSampleBtn.addEventListener('click', async () => {
          try {
            resetUI();
            showLoading();
            const url = 'https://simonwaldherr.github.io/InvoiceInspector/RE-2025-0815.pdf';
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error('HTTP ' + response.status);
            }
            const blob = await response.blob();
            // Blob in File-√§hnliches Objekt wrappen, damit handleFile-Pfade funktionieren
            const file = new File([blob], 'RE-2025-0815.pdf', { type: 'application/pdf' });
            await handleFile(file);
          } catch (e) {
            console.error('Sample invoice load failed', e);
            const L = getLabels();
            const msg = (currentLanguage === 'en')
              ? 'Sample invoice could not be loaded: '
              : 'Beispiel-Rechnung konnte nicht geladen werden: ';
            showError(msg + e.message);
          } finally {
            hideLoading();
          }
        });
      }

      // Initialisierung der Sprache
      initializeLanguage();

      // Event-Listener f√ºr Drag-and-Drop und Klick
      dropZone.addEventListener('click', () => fileInput.click());

      ['dragover', 'dragleave', 'drop'].forEach(event => {
        dropZone.addEventListener(event, handleDragEvents, false);
      });

      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if(file) handleFile(file);
      });

      function handleDragEvents(e) {
        e.preventDefault();
        if (e.type === 'dragover') {
          dropZone.classList.add('dragover');
        } else {
          dropZone.classList.remove('dragover');
          if (e.type === 'drop') {
            const file = e.dataTransfer.files[0];
            if(file) handleFile(file);
          }
        }
      }

      async function handleFile(file) {
        resetUI();
        showLoading();
        
        try {
          if(file.type === "application/pdf") {
            originalPdfBlob = file;
            const xmlContent = await extractXmlFromPdf(file);
            if(xmlContent) {
              originalXmlBlob = new Blob([xmlContent], { type: "application/xml" });
              await parseXML(xmlContent);
            } else {
              showError((getLabels().noFileFound) || "No XML file found in the PDF.");
            }
          } else if(file.name.toLowerCase().endsWith(".xml")) {
            originalXmlBlob = file;
            const text = await file.text();
            await parseXML(text);
          } else {
            showError((getLabels().unsupportedFormat) || "Unsupported file format. Please upload a PDF (ZUGFeRD) or XML file.");
          }
        } catch (err) {
          const L = getLabels();
          showError(`${L.processingError || "Error processing the file: "} ${err.message}`);
          console.error(err);
        } finally {
          hideLoading();
        }
      }

      async function extractXmlFromPdf(file) {
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({data: new Uint8Array(arrayBuffer)}).promise;
          const attachments = await pdf.getAttachments(); // Korrektur: await hinzugef√ºgt

          if(!attachments) return null;

          for (const [filename, attachment] of Object.entries(attachments)) {
            if(filename.toLowerCase().endsWith(".xml")) {
              const decoder = new TextDecoder("utf-8");
              return decoder.decode(attachment.content);
            }
          }

          return null;
        } catch (error) {
          console.error("Error extracting XML from PDF:", error);
          throw error;
        }
      }

      function parseXML(xmlString) {
        const parser = new DOMParser();
        xmlDoc = parser.parseFromString(xmlString, "application/xml");

        if(xmlDoc.querySelector("parsererror")) {
          showError((getLabels().invalidXml) || "The extracted file is not a valid XML invoice.");
          return;
        }

        // XML anzeigen
        originalXml.textContent = beautifyXml(xmlString);
        xmlViewer.classList.remove('hidden');

        // Download-Buttons konfigurieren
        if(originalXmlBlob || originalPdfBlob) {
          downloadButtons.classList.remove('hidden');
          downloadXmlButton.onclick = () => downloadBlob(originalXmlBlob, 'invoice.xml');
      downloadPdfButton.onclick = () => {
            if(originalPdfBlob) {
              downloadBlob(originalPdfBlob, 'invoice.pdf');
            } else {
        showError((getLabels().pdfNotAvailable) || "Original PDF is not available.");
            }
          };
          downloadJsonButton.onclick = () => downloadInvoiceAsJson();
          downloadCsvButton.onclick = () => downloadInvoiceAsCsv();
        }

        // Namespace-Resolver
        const namespaces = {
          'rsm': "urn:un:unece:uncefact:data:standard:CrossIndustryInvoice:100",
          'ram': "urn:un:unece:uncefact:data:standard:ReusableAggregateBusinessInformationEntity:100",
          'udt': "urn:un:unece:uncefact:data:standard:UnqualifiedDataType:100"
        };

        const resolver = (prefix) => namespaces[prefix] || null;

        // XPath-Hilfsfunktionen
        const selectNode = (contextNode, xpath) => {
          const result = xmlDoc.evaluate(
            xpath,
            contextNode,
            resolver,
            XPathResult.FIRST_ORDERED_NODE_TYPE,
            null
          );
          return result.singleNodeValue;
        };

        const selectNodes = (contextNode, xpath) => {
          const result = xmlDoc.evaluate(
            xpath,
            contextNode,
            resolver,
            XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,
            null
          );
          return Array.from({length: result.snapshotLength}, (_, i) => result.snapshotItem(i));
        };

        // Rechnungsinformationen auslesen und anzeigen
        displayInvoiceInfo(selectNode, selectNodes);
        displaySellerInfo(selectNode);
        displayBuyerInfo(selectNode);
        displayPaymentInfo(selectNode, selectNodes);
        const lineItemsCount = displayLineItems(selectNode, selectNodes);
        
        // Statistiken anzeigen
        displayStatistics(lineItemsCount);
        
        // Erfolg anzeigen
        showSuccess();
      }

      function displayInvoiceInfo(selectNode, selectNodes) {
        const invNumber = selectNode(xmlDoc, "/rsm:CrossIndustryInvoice/rsm:ExchangedDocument/ram:ID");
        const invType = selectNode(xmlDoc, "/rsm:CrossIndustryInvoice/rsm:ExchangedDocument/ram:TypeCode");
        const invDateNode = selectNode(xmlDoc, "/rsm:CrossIndustryInvoice/rsm:ExchangedDocument/ram:IssueDateTime/udt:DateTimeString");
        const invDueDateNode = selectNode(xmlDoc, "//ram:SpecifiedTradePaymentTerms/ram:DueDateDateTime/udt:DateTimeString");
        const invOrderNumber = selectNode(xmlDoc, "//ram:BuyerOrderReferencedDocument/ram:IssuerAssignedID");
        const invNoteNodes = selectNodes(xmlDoc, "/rsm:CrossIndustryInvoice/rsm:ExchangedDocument/ram:IncludedNote/ram:Content");

        invoiceData.header = {};
        
        if(invNumber) {
          const number = invNumber.textContent.trim();
          document.getElementById("invNumber").textContent = number;
          invoiceData.header.number = number;
          attachCopyButton('invNumber');
        }
        
        if(invType) {
          const type = invType.textContent.trim();
          document.getElementById("invType").textContent = type;
          invoiceData.header.type = type;
        }
        
        if(invDateNode) {
          let dtStr = invDateNode.textContent.trim();
          let formattedDate = formatDate(dtStr);
          document.getElementById("invDate").textContent = formattedDate;
          invoiceData.header.date = formattedDate;
        }
        
        if(invDueDateNode) {
          let dtStr = invDueDateNode.textContent.trim();
          let formattedDate = formatDate(dtStr);
          document.getElementById("invDueDate").textContent = formattedDate;
          invoiceData.header.dueDate = formattedDate;
        }
        
        if(invOrderNumber) {
          const orderNumber = invOrderNumber.textContent.trim();
          document.getElementById("invOrderNumber").textContent = orderNumber;
          invoiceData.header.orderNumber = orderNumber;
        }
        
        if(invNoteNodes.length > 0) {
          const notes = invNoteNodes.map(note => note.textContent.trim()).join("\n");
          document.getElementById("invNote").textContent = notes;
          invoiceData.header.notes = notes;
        }
        
        headerSection.classList.remove('hidden');
      }

      function displaySellerInfo(selectNode) {
        const sellerName = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:Name");
        const sellerStreet = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:PostalTradeAddress/ram:LineOne");
        const sellerCity = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:PostalTradeAddress/ram:CityName");
        const sellerZip = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:PostalTradeAddress/ram:PostcodeCode");
        const sellerCountry = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:PostalTradeAddress/ram:CountryID");
        const sellerEmail = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:DefinedTradeContact/ram:EmailURIUniversalCommunication/ram:URIID");
        const sellerPhone = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:DefinedTradeContact/ram:TelephoneUniversalCommunication/ram:CompleteNumber");
        const sellerTaxVA = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:SpecifiedTaxRegistration/ram:ID[@schemeID='VA']");
        const sellerTaxFC = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:SpecifiedTaxRegistration/ram:ID[@schemeID='FC']");
        const sellerRegister = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:SpecifiedLegalOrganization/ram:ID");

        invoiceData.seller = {};
        
        if(sellerName) {
          const name = sellerName.textContent.trim();
          document.getElementById("sellerName").textContent = name;
          invoiceData.seller.name = name;
        }

        const sellerAddressParts = [
          sellerStreet?.textContent.trim(),
          (sellerZip && sellerCity) ? `${sellerZip.textContent.trim()} ${sellerCity.textContent.trim()}` : null,
          sellerCountry?.textContent.trim()
        ].filter(Boolean).join(", ");
        if(sellerAddressParts) {
          document.getElementById("sellerAddress").textContent = sellerAddressParts;
          invoiceData.seller.address = sellerAddressParts;
        }

        if(sellerEmail) {
          const email = sellerEmail.textContent.trim();
          document.getElementById("sellerEmail").textContent = email;
          invoiceData.seller.email = email;
        }

        if(sellerPhone) {
          const phone = sellerPhone.textContent.trim();
          document.getElementById("sellerPhone").textContent = phone;
          invoiceData.seller.phone = phone;
        }

        const taxInfo = [
          sellerTaxVA ? `VA: ${sellerTaxVA.textContent.trim()}` : null,
          sellerTaxFC ? `FC: ${sellerTaxFC.textContent.trim()}` : null
        ].filter(Boolean).join("\n");
        if(taxInfo) {
          document.getElementById("sellerTaxID").textContent = taxInfo;
          invoiceData.seller.taxId = taxInfo;
        }

        if(sellerRegister) {
          const register = sellerRegister.textContent.trim();
          document.getElementById("sellerRegister").textContent = register;
          invoiceData.seller.register = register;
        }

        sellerSection.classList.remove('hidden');
      }

      function displayBuyerInfo(selectNode) {
        const buyerName = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:Name");
        const buyerStreet = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:LineOne");
        const buyerAddressLineTwo = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:LineTwo");
        const buyerCity = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:CityName");
        const buyerZip = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:PostcodeCode");
        const buyerCountry = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:CountryID");
        const buyerEmail = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:DefinedTradeContact/ram:EmailURIUniversalCommunication/ram:URIID");
        const buyerPhone = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:DefinedTradeContact/ram:TelephoneUniversalCommunication/ram:CompleteNumber");
        const buyerTaxVA = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:SpecifiedTaxRegistration/ram:ID[@schemeID='VA']");
        const buyerTaxFC = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:SpecifiedTaxRegistration/ram:ID[@schemeID='FC']");

        invoiceData.buyer = {};
        
        if(buyerName) {
          const name = buyerName.textContent.trim();
          document.getElementById("buyerName").textContent = name;
          invoiceData.buyer.name = name;
        }

        const buyerAddressParts = [
          buyerStreet?.textContent.trim(),
          (buyerZip && buyerCity) ? `${buyerZip.textContent.trim()} ${buyerCity.textContent.trim()}` : null,
          buyerCountry?.textContent.trim()
        ].filter(Boolean).join(", ");
        if(buyerAddressParts) {
          document.getElementById("buyerAddress").textContent = buyerAddressParts;
          invoiceData.buyer.address = buyerAddressParts;
        }

        if(buyerAddressLineTwo) {
          const address2 = buyerAddressLineTwo.textContent.trim();
          document.getElementById("buyerAddress2").textContent = address2;
          invoiceData.buyer.address2 = address2;
        }

        if(buyerEmail) {
          const email = buyerEmail.textContent.trim();
          document.getElementById("buyerEmail").textContent = email;
          invoiceData.buyer.email = email;
        }

        if(buyerPhone) {
          const phone = buyerPhone.textContent.trim();
          document.getElementById("buyerPhone").textContent = phone;
          invoiceData.buyer.phone = phone;
        }

        const taxInfo = [
          buyerTaxVA ? `VA: ${buyerTaxVA.textContent.trim()}` : null,
          buyerTaxFC ? `FC: ${buyerTaxFC.textContent.trim()}` : null
        ].filter(Boolean).join("\n");
        if(taxInfo) {
          document.getElementById("buyerTaxID").textContent = taxInfo;
          invoiceData.buyer.taxId = taxInfo;
        }

        buyerSection.classList.remove('hidden');
      }

      function displayPaymentInfo(selectNode, selectNodes) {
        const paymentMeans = selectNode(xmlDoc, "//ram:ApplicableHeaderTradeSettlement/ram:SpecifiedTradeSettlementPaymentMeans");
        const paymentTerms = selectNode(xmlDoc, "//ram:SpecifiedTradePaymentTerms/ram:Description");
        let currencySymbol = "‚Ç¨"; // Standard-W√§hrung

        invoiceData.payment = {};

        if(paymentMeans) {
          // W√§hrung
          const currencyNode = selectNode(xmlDoc, "//ram:ApplicableHeaderTradeSettlement/ram:InvoiceCurrencyCode");
          let currencyCode = "EUR";
          if(currencyNode) {
            currencyCode = currencyNode.textContent.trim();
            document.getElementById("currency").textContent = currencyCode;
            currencySymbol = getCurrencySymbol(currencyCode);
            invoiceData.payment.currency = currencyCode;
          }

          // Zahlungsart
          const paymentTypeCode = selectNode(paymentMeans, ".//ram:TypeCode");
          if(paymentTypeCode) {
            const paymentType = getPaymentTypeName(paymentTypeCode.textContent.trim());
            document.getElementById("paymentType").textContent = paymentType;
            invoiceData.payment.type = paymentType;
          }

          // IBAN
          const iban = selectNode(paymentMeans, ".//ram:PayerPartyCreditorFinancialAccount/ram:IBANID | .//ram:PayeePartyCreditorFinancialAccount/ram:IBANID");
          if(iban) {
            const rawIban = iban.textContent.trim();
            document.getElementById("iban").textContent = formatIbanForDisplay(rawIban);
            invoiceData.payment.iban = rawIban;
            // einfache Validierung
            if (!isValidIBAN(rawIban)) {
              console.warn('Invalid IBAN detected');
            }
            attachCopyButton('iban');
          }

          // BIC
          const bic = selectNode(paymentMeans, ".//ram:PayeeSpecifiedCreditorFinancialInstitution/ram:BICID | .//ram:PayeePartyCreditorFinancialInstitution/ram:BICID");
          if(bic) {
            const bicValue = bic.textContent.trim();
            document.getElementById("bic").textContent = bicValue;
            invoiceData.payment.bic = bicValue;
            attachCopyButton('bic');
          }

          // Kontoinhaber
          const accountHolder = selectNode(paymentMeans, ".//ram:PayeePartyCreditorFinancialAccount/ram:AccountName");
          if(accountHolder) {
            const holder = accountHolder.textContent.trim();
            document.getElementById("accountHolder").textContent = holder;
            invoiceData.payment.accountHolder = holder;
          }
        }

        // Zahlungsziel
        if(paymentTerms) {
          const terms = paymentTerms.textContent.trim();
          document.getElementById("paymentTerms").textContent = terms;
          invoiceData.payment.terms = terms;
        }

        // Monet√§re Summen
        const monetarySummation = selectNode(xmlDoc, "//ram:ApplicableHeaderTradeSettlement/ram:SpecifiedTradeSettlementMonetarySummation | //ram:ApplicableHeaderTradeSettlement/ram:SpecifiedTradeSettlementHeaderMonetarySummation");
        if(monetarySummation) {
          const netAmountNode = selectNode(monetarySummation, ".//ram:LineTotalAmount");
          const taxAmountNode = selectNode(monetarySummation, ".//ram:TaxTotalAmount");
          const grossAmountNode = selectNode(monetarySummation, ".//ram:GrandTotalAmount");
          const dueAmountNode = selectNode(monetarySummation, ".//ram:DuePayableAmount");

          if(netAmountNode) {
            const netAmount = netAmountNode.textContent.trim();
            const formattedNet = formatCurrency(netAmount, currencySymbol);
            document.getElementById("netAmount").textContent = formattedNet;
            invoiceData.payment.netAmount = parseFloat(netAmount);
          }

          if(taxAmountNode) {
            const taxAmount = taxAmountNode.textContent.trim();
            const formattedTax = formatCurrency(taxAmount, currencySymbol);
            document.getElementById("taxAmount").textContent = formattedTax;
            invoiceData.payment.taxAmount = parseFloat(taxAmount);
          }

          if(grossAmountNode) {
            const grossAmount = grossAmountNode.textContent.trim();
            const formattedGross = formatCurrency(grossAmount, currencySymbol);
            document.getElementById("grossAmount").textContent = formattedGross;
            invoiceData.payment.grossAmount = parseFloat(grossAmount);
          }

          if(dueAmountNode) {
            const dueAmount = dueAmountNode.textContent.trim();
            const formattedDue = formatCurrency(dueAmount, currencySymbol);
            document.getElementById("dueAmount").textContent = formattedDue;
            invoiceData.payment.dueAmount = parseFloat(dueAmount);
          }
        }

        paymentSection.classList.remove('hidden');
        
        // EPC QR-Code generieren wenn IBAN vorhanden
        generateEPCQRCode(invoiceData.payment);
      }

      function generateEPCQRCode(paymentData) {
        const qrCodeSection = document.getElementById('qrCodeSection');
        const qrCodeContainer = document.querySelector('.qr-code-container');
  const downloadQrBtn = document.getElementById('downloadQrBtn');
        
        // Pr√ºfen ob notwendige Daten vorhanden sind
  if (!paymentData || !paymentData.iban || (!paymentData.grossAmount && !paymentData.dueAmount)) {
          qrCodeSection.classList.add('hidden');
          return;
        }

        try {
          // Vorherigen QR-Code l√∂schen
          qrCodeContainer.innerHTML = '';
          
          // EPC QR Code Daten nach SEPA Credit Transfer Standard
          const epcData = generateEPCData(paymentData);
          
          // Canvas Element erstellen
          const canvas = document.createElement('canvas');
          qrCodeContainer.appendChild(canvas);
          
          // QR Code generieren mit qrcode Bibliothek
          QRCode.toCanvas(canvas, epcData, {
            width: 200,
            height: 200,
            color: {
              dark: '#000000',
              light: '#FFFFFF'
            },
            errorCorrectionLevel: 'M'
          }, function (error) {
            if (error) {
              console.error('EPC QR Code generation failed:', error);
              qrCodeSection.classList.add('hidden');
            } else {
              qrCodeSection.classList.remove('hidden');
              // Download-Button aktivieren
              if (downloadQrBtn) {
                downloadQrBtn.disabled = false;
                downloadQrBtn.onclick = () => {
                  try {
                    const dataUrl = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = `epc_qrcode_${invoiceData.header?.number || 'invoice'}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                  } catch (e) {
                    console.error('QR download failed', e);
                  }
                };
              }
            }
          });
          
        } catch (error) {
          console.error('EPC QR Code generation failed:', error);
          qrCodeSection.classList.add('hidden');
        }
      }

      function generateEPCData(paymentData) {
        // EPC QR Code Format nach EPC069-12 Standard
        const serviceTag = "BCD";  // Service Tag
        const version = "002";     // Version
        const characterSet = "1";  // UTF-8
        const identification = "SCT"; // SEPA Credit Transfer
        
        // BIC (optional, kann leer sein bei IBAN)
        const bic = paymentData.bic || "";
        
        // Empf√§nger Name (max 70 Zeichen)
        const beneficiaryName = truncateString(invoiceData.seller?.name || "", 70);
        
        // IBAN (ohne Leerzeichen)
        const beneficiaryIban = paymentData.iban.replace(/\s/g, '');
        
        // Betrag in EUR mit 2 Dezimalstellen (max EUR 999999999.99)
  let amount = paymentData.grossAmount || paymentData.dueAmount || 0;
        if (amount > 999999999.99) amount = 999999999.99;
        const amountStr = `EUR${amount.toFixed(2)}`;
        
        // Verwendungszweck (max 140 Zeichen)
        const purpose = ""; // Leer lassen
        
        // Strukturierte Referenz (leer lassen, au√üer eine g√ºltige RF-Referenz liegt vor)
        const structuredReference = "";
        
        // Unstrukturierte Remittance Information (max 140 Zeichen)
        const prefix = (currentLanguage === 'en') ? 'Invoice' : 'Rechnung';
        const unstructuredReference = truncateString(
          `${prefix} ${invoiceData.header?.number || ''}`.trim(), 140
        );
        
        // Information for Beneficiary (max 70 Zeichen) - optional
        const beneficiaryInfo = "";
        
        // EPC String zusammenbauen (Felder durch \n getrennt)
        const epcLines = [
          serviceTag,
          version,
          characterSet,
          identification,
          bic,
          beneficiaryName,
          beneficiaryIban,
          amountStr,
          purpose,
          structuredReference,
          unstructuredReference,
          beneficiaryInfo
        ];
        
        return epcLines.join('\n');
      }

      function truncateString(str, maxLength) {
        if (str.length <= maxLength) return str;
        return str.substring(0, maxLength);
      }

      function displayLineItems(selectNode, selectNodes) {
        const lineItems = selectNodes(xmlDoc, "//ram:IncludedSupplyChainTradeLineItem");
        const tbody = lineItemsTable.querySelector("tbody");
        let calculatedTotalNet = 0;

        invoiceData.lineItems = [];

        lineItems.forEach((item, index) => {
          const lineID = selectNode(item, "./ram:AssociatedDocumentLineDocument/ram:LineID")?.textContent.trim() || (index + 1).toString();
          const productNote = selectNode(item, "./ram:AssociatedDocumentLineDocument/ram:IncludedNote/ram:Content")?.textContent.trim() || "";
          const productName = selectNode(item, "./ram:SpecifiedTradeProduct/ram:Name")?.textContent.trim() || "";
          const productDesc = selectNode(item, "./ram:SpecifiedTradeProduct/ram:Description")?.textContent.trim() || "";
          const qtyElement = selectNode(item, "./ram:SpecifiedLineTradeDelivery/ram:BilledQuantity");
          const qtyText = qtyElement?.textContent.trim() || "0";
          const quantity = parseFloat(qtyText);
          const unit = qtyElement?.getAttribute('unitCode') || "";
          const netPricePerUnit = parseFloat(selectNode(item, "./ram:SpecifiedLineTradeAgreement/ram:NetPriceProductTradePrice/ram:ChargeAmount")?.textContent.trim() || "0");
          const taxRateText = selectNode(item, "./ram:SpecifiedLineTradeSettlement/ram:ApplicableTradeTax/ram:RateApplicablePercent")?.textContent.trim() || "0";
          const taxRate = parseFloat(taxRateText);
          const lineNet = netPricePerUnit * quantity;
          const vatAmount = lineNet * (taxRate / 100);
          const lineGross = lineNet + vatAmount;

          calculatedTotalNet += lineNet;

          // Daten f√ºr Export speichern
          invoiceData.lineItems.push({
            position: lineID,
            productName,
            description: productDesc,
            notes: productNote,
            quantity,
            unit,
            unitPrice: netPricePerUnit,
            lineNet,
            taxRate,
            lineGross
          });

          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${escapeHtml(lineID)}</td>
            <td>${escapeHtml(productName)}</td>
            <td>${escapeHtml(productDesc)}</td>
            <td>${escapeHtml(productNote)}</td>
            <td>${escapeHtml(quantity.toFixed(2))}</td>
            <td>${escapeHtml(unit)}</td>
            <td>${formatCurrency(netPricePerUnit.toFixed(2), getCurrencySymbol(document.getElementById("currency").textContent.trim() || 'EUR'))}</td>
            <td>${formatCurrency(lineNet.toFixed(2), getCurrencySymbol(document.getElementById("currency").textContent.trim() || 'EUR'))}</td>
            <td>${escapeHtml(taxRate.toFixed(2))}%</td>
            <td>${formatCurrency(lineGross.toFixed(2), getCurrencySymbol(document.getElementById("currency").textContent.trim() || 'EUR'))}</td>
          `;

          tbody.appendChild(tr);
        });

        if(lineItems.length > 0) {
          const netAmountDisplay = document.getElementById("netAmount");
          if(!netAmountDisplay.textContent) {
            netAmountDisplay.textContent = formatCurrency(calculatedTotalNet.toFixed(2), getCurrencySymbol(document.getElementById("currency").textContent.trim() || 'EUR'));
          }
          lineItemsSection.classList.remove('hidden');
        }

        return lineItems.length;
      }

      function showLoading() {
        loadingSection.classList.remove('hidden');
      }

      function hideLoading() {
        loadingSection.classList.add('hidden');
      }

      function showSuccess() {
        successSection.classList.remove('hidden');
        setTimeout(() => successSection.classList.add('hidden'), 3000);
      }

      function displayStatistics(lineItemsCount) {
        document.getElementById('statLineItems').textContent = lineItemsCount;
        document.getElementById('statNetAmount').textContent = document.getElementById('netAmount').textContent || '0 ‚Ç¨';
        document.getElementById('statTaxAmount').textContent = document.getElementById('taxAmount').textContent || '0 ‚Ç¨';
        document.getElementById('statGrossAmount').textContent = document.getElementById('grossAmount').textContent || '0 ‚Ç¨';
        statsSection.classList.remove('hidden');
      }

      function formatDate(dateStr) {
        if (/^\d{8}$/.test(dateStr)) {
          return `${dateStr.slice(6,8)}.${dateStr.slice(4,6)}.${dateStr.slice(0,4)}`;
        }
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
          const [year, month, day] = dateStr.split('-');
          return `${day}.${month}.${year}`;
        }
        return dateStr;
      }

      function getPaymentTypeName(code) {
        const mapDe = {
          '1': 'Instrumentenbasierte Zahlung',
          '10': 'Barzahlung',
          '20': 'Scheck',
          '30': '√úberweisung',
          '31': 'Abbuchung',
          '42': 'Zahlung an ein Bankkonto',
          '48': 'Kartenzahlung',
          '49': 'Lastschrift',
          '58': 'SEPA-√úberweisung',
          '59': 'SEPA-Lastschrift'
        };
        const mapEn = {
          '1': 'Instrument-based payment',
          '10': 'Cash payment',
          '20': 'Cheque',
          '30': 'Credit transfer',
          '31': 'Debit transfer',
          '42': 'Payment to a bank account',
          '48': 'Card payment',
          '49': 'Direct debit',
          '58': 'SEPA Credit Transfer',
          '59': 'SEPA Direct Debit'
        };
        const dict = (currentLanguage === 'en') ? mapEn : mapDe;
        const fallback = (currentLanguage === 'en') ? `Unknown (${code})` : `Unbekannt (${code})`;
        return dict[code] || fallback;
      }

      function downloadInvoiceAsJson() {
        const jsonData = JSON.stringify(invoiceData, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const filename = `invoice_${invoiceData.header?.number || 'unknown'}.json`;
        downloadBlob(blob, filename);
      }

      function downloadInvoiceAsCsv() {
        const L = getLabels();
        if (!invoiceData.lineItems || invoiceData.lineItems.length === 0) {
          alert(L.noPositionsToExport || 'No line items available for export.');
          return;
        }

        // CSV Header
        const headers = [
          L.posNr,
          L.productName,
          L.description,
          L.notes,
          L.quantity,
          L.unit,
          L.unitPrice,
          L.lineNet,
          L.taxRate,
          L.lineGross
        ];
        
        // CSV Daten
        const csvData = [
          headers.join(','),
          ...invoiceData.lineItems.map(item => [
            `"${item.position}"`,
            `"${item.productName}"`,
            `"${item.description}"`,
            `"${item.notes}"`,
            item.quantity,
            `"${item.unit}"`,
            item.unitPrice.toFixed(2),
            item.lineNet.toFixed(2),
            item.taxRate.toFixed(2),
            item.lineGross.toFixed(2)
          ].join(','))
        ].join('\n');

        const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
        const filename = `invoice_${invoiceData.header?.number || 'unknown'}_positions.csv`;
        downloadBlob(blob, filename);
      }

      function showError(msg) {
        errorSection.textContent = msg;
        errorSection.classList.remove("hidden");
      }

      function resetUI() {
        // Fehler- und Anzeigeabschnitte zur√ºcksetzen
        errorSection.textContent = "";
        errorSection.classList.add("hidden");
        successSection.classList.add("hidden");

        [headerSection, sellerSection, buyerSection, paymentSection, lineItemsSection, xmlViewer, downloadButtons, statsSection].forEach(section => section.classList.add('hidden'));

        // QR-Code Sektion zur√ºcksetzen
        const qrCodeSection = document.getElementById('qrCodeSection');
        if (qrCodeSection) {
          qrCodeSection.classList.add('hidden');
          const qrCodeContainer = document.querySelector('.qr-code-container');
          if (qrCodeContainer) {
            qrCodeContainer.innerHTML = '';
          }
          const downloadQrBtn = document.getElementById('downloadQrBtn');
          if (downloadQrBtn) {
            downloadQrBtn.disabled = true;
            downloadQrBtn.onclick = null;
          }
        }

        // Inhalt der Tabellen und Bereiche zur√ºcksetzen
        document.querySelectorAll("#headerSection td, #sellerSection td, #buyerSection td, #paymentSection td").forEach(td => td.textContent = "");
        originalXml.textContent = "";
        lineItemsTable.querySelector("tbody").innerHTML = "";
        
        // Daten zur√ºcksetzen
        invoiceData = {};
      }

      function beautifyXml(xml) {
        const PADDING = '  ';
        const reg = /(>)(<)(\/*)/g;
        let formatted = '';
        let pad = 0;

        xml = xml.replace(reg, '$1\r\n$2$3');
        xml.split('\r\n').forEach(node => {
          let indent = 0;
          if (node.match(/.+<\/\w[^>]*>$/)) {
            indent = 0;
          } else if (node.match(/^<\/\w/)) {
            if (pad !== 0) pad -= 1;
          } else if (node.match(/^<\w[^>]*[^\/]>.*$/)) {
            indent = 1;
          }

          formatted += PADDING.repeat(pad) + node.trim() + '\r\n';
          pad += indent;
        });

        return formatted;
      }

      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function getCurrencySymbol(code) {
        const symbols = {
          'EUR': '‚Ç¨',
          'USD': '$',
          'GBP': '¬£',
          'CHF': 'CHF',
          // Weitere W√§hrungen k√∂nnen hier hinzugef√ºgt werden
        };
        return symbols[code] || code;
      }

      function formatCurrency(amount, currencySymbol) {
        const formattedAmount = parseFloat(amount).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        switch(currencySymbol) {
          case 'CHF':
            return `${formattedAmount} ${currencySymbol}`;
          case '‚Ç¨':
            return `${formattedAmount} ${currencySymbol}`;
          case '$':
            return `${currencySymbol}${formattedAmount}`;
          case '¬£':
            return `${currencySymbol}${formattedAmount}`;
          default:
            return `${formattedAmount} ${currencySymbol}`;
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

    })();
  </script>
</body>
</html>
