<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZUGFeRD / XRechnung / EN16931 E-Rechnungs-Reader inkl. PDF-Extraktion</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.6.172/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <style>
    /* ================================================================
       CSS Custom Properties ‚Äî single source for theming (light/dark)
       ================================================================ */
    :root {
      --color-bg: #f7f7f7;
      --color-text: #333;
      --color-heading: #333;
      --color-accent: #007BFF;
      --color-accent-hover: #0056b3;
      --color-card-bg: #fff;
      --color-card-border: #ccc;
      --color-card-shadow: rgba(0, 0, 0, 0.1);
      --color-input-bg: #fff;
      --color-input-border: #aaa;
      --color-table-header-bg: #f0f0f0;
      --color-pre-bg: #f9f9f9;
      --color-pre-border: #ccc;
      --color-tag: #666;
      --color-error-bg: #ffe6e6;
      --color-error-text: red;
      --color-success-bg: #d4edda;
      --color-success-text: #155724;
      --color-success-border: #c3e6cb;
      --color-stat-bg: #f8f9fa;
      --color-stat-border: #dee2e6;
      --color-stat-heading: #495057;
      --color-qr-info: #666;
      --color-qr-info-strong: #333;
      --color-dragover-bg: #f0f8ff;
      --color-dragover-border: #007BFF;
      --color-lang-bg: #fff;
      --color-lang-text: #007BFF;
      --color-lang-border: #007BFF;
      --color-lang-hover-bg: #f0f8ff;
      --color-muted: #666;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --color-bg: #1a1a1a;
        --color-text: #e0e0e0;
        --color-heading: #e0e0e0;
        --color-accent: #0099ff;
        --color-accent-hover: #007acc;
        --color-card-bg: #2d2d2d;
        --color-card-border: #444;
        --color-card-shadow: rgba(0, 0, 0, 0.3);
        --color-input-bg: #2d2d2d;
        --color-input-border: #555;
        --color-table-header-bg: #383838;
        --color-pre-bg: #1e1e1e;
        --color-pre-border: #555;
        --color-tag: #adb5bd;
        --color-error-bg: #4a1a1a;
        --color-error-text: #ff9999;
        --color-success-bg: #155724;
        --color-success-text: #b8e6b8;
        --color-success-border: #28a745;
        --color-stat-bg: #343a40;
        --color-stat-border: #495057;
        --color-stat-heading: #adb5bd;
        --color-qr-info: #adb5bd;
        --color-qr-info-strong: #fff;
        --color-dragover-bg: #1a3a5a;
        --color-dragover-border: #0099ff;
        --color-lang-bg: #2d2d2d;
        --color-lang-text: #0099ff;
        --color-lang-border: #0099ff;
        --color-lang-hover-bg: #1a3a5a;
        --color-muted: #adb5bd;
      }
    }

    /* ================================================================
       Base & Typography
       ================================================================ */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.6;
      background: var(--color-bg);
      color: var(--color-text);
    }

    h1, h2 { margin-bottom: 0.5em; }

    h1 {
      font-size: 2em;
      margin-top: 0;
      color: var(--color-heading);
      flex: 1;
    }

    /* ================================================================
       Language Switcher
       ================================================================ */
    .language-switcher { display: flex; gap: 5px; }

    .lang-btn {
      padding: 8px 15px;
      border: 2px solid var(--color-lang-border);
      background: var(--color-lang-bg);
      color: var(--color-lang-text);
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .lang-btn:hover {
      background: var(--color-lang-hover-bg);
      transform: scale(1.05);
    }

    .lang-btn.active {
      background: var(--color-accent);
      color: #fff;
    }

    /* ================================================================
       Cards (description, sections, details)
       ================================================================ */
    .description, section, details {
      background: var(--color-card-bg);
      padding: 20px;
      margin-bottom: 16px;
      border-radius: 5px;
      border: 1px solid var(--color-card-border);
      box-shadow: 0 2px 4px var(--color-card-shadow);
    }

    /* ================================================================
       Drop Zone
       ================================================================ */
    .drop-zone {
      border: 2px dashed var(--color-input-border);
      border-radius: 5px;
      padding: 40px;
      text-align: center;
      color: var(--color-text);
      background: var(--color-card-bg);
      margin-bottom: 20px;
      transition: border-color 0.3s, background-color 0.3s;
      cursor: pointer;
      position: relative;
    }

    .drop-zone.dragover {
      border-color: var(--color-dragover-border);
      background-color: var(--color-dragover-bg);
    }

    .drop-zone p { margin: 0; font-size: 1.1em; }

    /* ================================================================
       Utility
       ================================================================ */
    .hidden { display: none; }

    /* ================================================================
       Tables
       ================================================================ */
    table { border-collapse: collapse; width: 100%; }

    table th, table td {
      border: 1px solid var(--color-card-border);
      padding: 8px;
      vertical-align: top;
    }

    table th {
      background: var(--color-table-header-bg);
      text-align: left;
      width: 12.5%;
      color: var(--color-text);
    }

    .table-container {
      overflow-x: auto;
      border-radius: 5px;
      border: 1px solid var(--color-card-border);
    }

    .zugferd-tag {
      font-size: 0.75em;
      color: var(--color-tag);
      margin-left: 4px;
      opacity: 0.8;
    }

    /* ================================================================
       Feedback: Errors & Success
       ================================================================ */
    .error {
      color: var(--color-error-text);
      background-color: var(--color-error-bg);
      padding: 10px;
      border-radius: 5px;
    }

    .success {
      color: var(--color-success-text);
      background-color: var(--color-success-bg);
      padding: 10px;
      border-radius: 5px;
      border: 1px solid var(--color-success-border);
      margin-bottom: 20px;
    }

    /* ================================================================
       Buttons
       ================================================================ */
    .download-buttons {
      margin-bottom: 20px;
      text-align: center;
    }

    .download-buttons button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: var(--color-accent);
      color: white;
      transition: background-color 0.3s, transform 0.2s;
    }

    .download-buttons button:hover {
      background-color: var(--color-accent-hover);
      transform: scale(1.05);
    }

    .sample-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--color-accent);
      background-color: var(--color-card-bg);
      color: var(--color-accent);
      font-size: 0.95em;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s, color 0.3s;
    }

    .sample-btn:hover {
      background-color: var(--color-dragover-bg);
      color: var(--color-accent-hover);
      transform: translateY(-1px);
    }

    .copy-btn {
      padding: 3px 8px;
      border: 1px solid var(--color-card-border);
      border-radius: 4px;
      background: var(--color-table-header-bg);
      cursor: pointer;
    }

    .copy-btn:hover { background: var(--color-stat-bg); }

    /* ================================================================
       Code / XML Viewer
       ================================================================ */
    details summary { cursor: pointer; font-weight: bold; }

    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 400px;
      overflow: auto;
      background-color: var(--color-pre-bg);
      padding: 10px;
      border-radius: 5px;
      border: 1px solid var(--color-pre-border);
      color: var(--color-text);
    }

    /* ================================================================
       Loading Spinner
       ================================================================ */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--color-card-border);
      border-top: 3px solid var(--color-accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ================================================================
       Statistics Cards
       ================================================================ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--color-stat-bg);
      padding: 15px;
      border-radius: 5px;
      border: 1px solid var(--color-stat-border);
      text-align: center;
    }

    .stat-card h3 {
      margin: 0 0 10px 0;
      font-size: 1.2em;
      color: var(--color-stat-heading);
    }

    .stat-card .value {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--color-accent);
    }

    /* ================================================================
       Section Grid (side-by-side on wide screens)
       ================================================================ */
    .section-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    @media (min-width: 1400px) {
      .section-grid { grid-template-columns: 1fr 1fr; }
    }

    .section-grid > section { margin-bottom: 0; }

    /* ================================================================
       EPC QR Code
       ================================================================ */
    .qr-section {
      background: var(--color-stat-bg);
      border: 1px solid var(--color-stat-border);
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }

    .qr-section h3 {
      margin: 0 0 15px 0;
      color: var(--color-stat-heading);
      font-size: 1.2em;
    }

    .qr-code-container {
      display: inline-block;
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
    }

    .qr-info {
      font-size: 0.9em;
      color: var(--color-qr-info);
      line-height: 1.4;
    }

    .qr-info strong { color: var(--color-qr-info-strong); }

    /* QR Modal */
    .qr-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
    }

    .qr-modal.visible { display: flex; }

    .qr-modal-content {
      background: var(--color-card-bg);
      padding: 20px;
      border-radius: 8px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      text-align: center;
    }

    .qr-modal-content .qr-code-container {
      display: block;
      margin: 0 auto 12px auto;
    }

    /* ================================================================
       Responsive
       ================================================================ */
    @media (max-width: 768px) {
      table th, table td { font-size: 0.9em; }
      .drop-zone { padding: 20px; }
      .download-buttons button { width: 100%; margin: 10px 0; }
      .stats-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- ============================================================
       Header with title & language switcher
       ============================================================ -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1 data-i18n="mainTitle">E-Rechnungs-Reader (ZUGFeRD, XRechnung, EN16931) mit PDF-Extraktion</h1>
    <div class="language-switcher">
      <button id="langDe" class="lang-btn active">üá©üá™ DE</button>
      <button id="langEn" class="lang-btn">üá∫üá∏ EN</button>
    </div>
  </div>

  <!-- ============================================================
       Description
       ============================================================ -->
  <section class="description">
    <h2 data-i18n="descriptionTitle">Beschreibung</h2>
    <p data-i18n="descriptionText">Dieses Tool erm√∂glicht das Anzeigen von elektronischen Rechnungen im XML-Format sowie ZUGFeRD-PDF/A-3-Dateien. Die eingebettete XML-Datei in ZUGFeRD-PDFs wird automatisch extrahiert und die Rechnungsdaten werden strukturiert dargestellt.</p>
    <p data-i18n-html="disclaimerText"><strong>Hinweis:</strong> Dieses Tool verarbeitet elektronische Rechnungen (z. B. ZUGFeRD, XRechnung) vollst√§ndig clientseitig im Browser. Die Dateien werden nicht hochgeladen oder gespeichert.<br/>Es wird keine Gew√§hr f√ºr die Richtigkeit, Vollst√§ndigkeit oder Rechtskonformit√§t der angezeigten Daten √ºbernommen. Jegliche Haftung f√ºr Sch√§den oder Verluste, die aus der Nutzung resultieren, ist ausgeschlossen. Die Verantwortung f√ºr die korrekte Verarbeitung und Pr√ºfung der Daten liegt beim Nutzer.</p>
  </section>

  <!-- ============================================================
       Drop Zone
       ============================================================ -->
  <div class="drop-zone" id="dropZone">
    <p data-i18n="dropZoneText">üìÑ Datei hierher ziehen und fallen lassen oder klicken, um eine Datei auszuw√§hlen.</p>
    <p data-i18n="supportedFormatsText" style="font-size: 0.9em; color: var(--color-muted); margin-top: 10px;">Unterst√ºtzte Formate: ZUGFeRD PDF, XRechnung XML, EN16931 XML</p>
    <input type="file" id="invoiceFile" accept=".xml,.pdf,application/pdf" style="display: none;" />
  </div>

  <div style="margin-top: 12px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
    <button id="loadSampleBtn" type="button" class="sample-btn" data-i18n="loadSample">üß™ Beispiel-Rechnung laden</button>
  </div>

  <!-- ============================================================
       Loading & Success Feedback
       ============================================================ -->
  <div id="loadingSection" class="hidden" style="text-align: center; padding: 20px;">
    <div class="loading"></div>
    <span data-i18n="loadingText">Verarbeitung l√§uft...</span>
  </div>

  <div id="successSection" class="success hidden">
    <span data-i18n="successText">‚úÖ Rechnung erfolgreich verarbeitet!</span>
  </div>

  <!-- ============================================================
       Statistics
       ============================================================ -->
  <section id="statsSection" class="hidden">
    <h2 data-i18n="statistics">üìä Statistiken</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <h3 data-i18n="statPositions">Positionen</h3>
        <div class="value" id="statLineItems">0</div>
      </div>
      <div class="stat-card">
        <h3 data-i18n="statNet">Nettosumme</h3>
        <div class="value" id="statNetAmount">0 ‚Ç¨</div>
      </div>
      <div class="stat-card">
        <h3 data-i18n="statTax">Steuern</h3>
        <div class="value" id="statTaxAmount">0 ‚Ç¨</div>
      </div>
      <div class="stat-card">
        <h3 data-i18n="statGross">Bruttosumme</h3>
        <div class="value" id="statGrossAmount">0 ‚Ç¨</div>
      </div>
    </div>
  </section>

  <!-- ============================================================
       Download Buttons
       ============================================================ -->
  <div class="download-buttons hidden" id="downloadButtons">
    <button id="downloadXml" data-i18n="downloadXml">üìÑ XML speichern</button>
    <button id="downloadPdf" data-i18n="downloadPdf">üìã PDF speichern</button>
    <button id="downloadJson" data-i18n="downloadJson">üìä JSON Export</button>
    <button id="downloadCsv" data-i18n="downloadCsv">üìà CSV Export</button>
  </div>

  <!-- ============================================================
       XML Viewer
       ============================================================ -->
  <details id="xmlViewer" class="hidden">
    <summary data-i18n="xmlViewerSummary">XML anzeigen</summary>
    <pre id="originalXml"></pre>
  </details>

  <!-- ============================================================
       Error Section
       ============================================================ -->
  <section id="errorSection" class="error hidden"></section>

  <!-- ============================================================
       Invoice & Payment Info (side-by-side grid)
       ============================================================ -->
  <div class="section-grid" id="invoicePaymentGrid">
    <section id="headerSection" class="hidden">
      <h2 data-i18n="invoiceInfo">üìã Rechnungsinformationen</h2>
      <div class="table-container">
        <table>
          <tr><th data-i18n="invNumber" data-bt="BT-1">Rechnungsnummer</th><td id="invNumber"></td></tr>
          <tr><th data-i18n="invType" data-bt="BT-3">Rechnungstyp</th><td id="invType"></td></tr>
          <tr><th data-i18n="invDate" data-bt="BT-2">Rechnungsdatum</th><td id="invDate"></td></tr>
          <tr><th data-i18n="invDueDate" data-bt="BT-9">F√§lligkeitsdatum</th><td id="invDueDate"></td></tr>
          <tr><th data-i18n="invOrderNumber" data-bt="BT-13">Bestellnummer</th><td id="invOrderNumber"></td></tr>
          <tr><th data-i18n="invNote" data-bt="BT-22">Notiz</th><td id="invNote"></td></tr>
        </table>
      </div>
    </section>

    <section id="paymentSection" class="hidden">
      <h2 data-i18n="paymentInfo">üí≥ Zahlungsinformationen</h2>
      <div class="table-container">
        <table>
          <tr><th data-i18n="currency" data-bt="BT-5">W√§hrung</th><td id="currency"></td></tr>
          <tr><th data-i18n="paymentType" data-bt="BT-82">Zahlungsart</th><td id="paymentType"></td></tr>
          <tr><th data-i18n="paymentTerms" data-bt="BT-20">Zahlungsziel</th><td id="paymentTerms"></td></tr>
          <tr><th data-i18n="iban" data-bt="BT-84">IBAN</th><td id="iban"></td></tr>
          <tr><th data-i18n="bic" data-bt="BT-86">BIC</th><td id="bic"></td></tr>
          <tr><th data-i18n="accountHolder" data-bt="BT-85">Kontoinhaber</th><td id="accountHolder"></td></tr>
          <tr><th data-i18n="netAmount" data-bt="BT-106">Gesamt netto</th><td id="netAmount"></td></tr>
          <tr><th data-i18n="taxAmount" data-bt="BT-110">Steuerbetrag</th><td id="taxAmount"></td></tr>
          <tr><th data-i18n="grossAmount" data-bt="BT-112">Gesamt brutto</th><td id="grossAmount"></td></tr>
          <tr><th data-i18n="dueAmount" data-bt="BT-115">F√§lliger Betrag</th><td id="dueAmount"></td></tr>
        </table>
      </div>

      <!-- EPC QR Code buttons -->
      <div style="margin-top: 10px;">
        <button id="showQrBtn" type="button" class="sample-btn hidden">QR-Code anzeigen</button>
        <button id="downloadQrBtn" type="button" class="sample-btn hidden" style="margin-left: 8px;">QR-Code speichern</button>
      </div>
    </section>
  </div>

  <!-- ============================================================
       QR Modal
       ============================================================ -->
  <div id="qrModal" class="qr-modal" role="dialog" aria-hidden="true">
    <div class="qr-modal-content">
      <h3 data-i18n="qrCodeTitle">üì± QR-Code f√ºr √úberweisung</h3>
      <div class="qr-code-container"></div>
      <div class="qr-info">
        <div id="qrCodeInfo">
          <strong data-i18n="qrCodeInfoTitle">Zum Bezahlen einfach QR-Code mit Banking-App scannen</strong><br>
          <span data-i18n="qrCodeDetails">EPC-QR-Code (Girocode) nach europ√§ischem Standard</span>
        </div>
        <div style="margin-top: 10px; display: flex; gap: 8px; justify-content: center;">
          <button id="modalDownloadQrBtn" type="button" class="sample-btn">QR-Code speichern</button>
          <button id="closeQrModal" type="button" class="sample-btn">Schlie√üen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       Seller & Buyer Info (side-by-side grid)
       ============================================================ -->
  <div class="section-grid" id="sellerBuyerGrid">
    <section id="sellerSection" class="hidden">
      <h2 data-i18n="sellerInfo">üè¢ Verk√§ufer / Rechnungssteller</h2>
      <div class="table-container">
        <table>
          <tr><th data-i18n="sellerName" data-bt="BT-27">Name</th><td id="sellerName"></td></tr>
          <tr><th data-i18n="sellerAddress" data-bt="BT-35, BT-36, BT-38, BT-37, BT-39, BT-40">Adresse</th><td id="sellerAddress"></td></tr>
          <tr><th data-i18n="sellerEmail" data-bt="BT-43">E-Mail</th><td id="sellerEmail"></td></tr>
          <tr><th data-i18n="sellerPhone" data-bt="BT-42">Telefon</th><td id="sellerPhone"></td></tr>
          <tr><th data-i18n="sellerTaxID" data-bt="BT-31, BT-32">Steuer-ID</th><td id="sellerTaxID"></td></tr>
          <tr><th data-i18n="sellerRegister" data-bt="BT-33">Handelsregister</th><td id="sellerRegister"></td></tr>
        </table>
      </div>
    </section>

    <section id="buyerSection" class="hidden">
      <h2 data-i18n="buyerInfo">üë§ K√§ufer / Rechnungsempf√§nger</h2>
      <div class="table-container">
        <table>
          <tr><th data-i18n="buyerName" data-bt="BT-44">Name</th><td id="buyerName"></td></tr>
          <tr><th data-i18n="buyerAddress" data-bt="BT-50, BT-53, BT-52, BT-54, BT-55">Adresse</th><td id="buyerAddress"></td></tr>
          <tr><th data-i18n="buyerAddress2" data-bt="BT-51">Adresszusatz</th><td id="buyerAddress2"></td></tr>
          <tr><th data-i18n="buyerEmail" data-bt="BT-58">E-Mail</th><td id="buyerEmail"></td></tr>
          <tr><th data-i18n="buyerPhone" data-bt="BT-57">Telefon</th><td id="buyerPhone"></td></tr>
          <tr><th data-i18n="buyerTaxID" data-bt="BT-48">Steuer-ID</th><td id="buyerTaxID"></td></tr>
        </table>
      </div>
    </section>
  </div>

  <!-- ============================================================
       Line Items
       ============================================================ -->
  <section id="lineItemsSection" class="hidden">
    <h2 data-i18n="lineItems">üì¶ Positionen</h2>
    <div class="table-container">
      <table id="lineItemsTable">
        <thead>
          <tr>
            <th data-i18n="posNr" data-bt="BT-126">Pos.-Nr.</th>
            <th data-i18n="productName" data-bt="BT-153">Produktname</th>
            <th data-i18n="description" data-bt="BT-154">Beschreibung</th>
            <th data-i18n="notes">Notiz</th>
            <th data-i18n="quantity" data-bt="BT-129">Menge</th>
            <th data-i18n="unit" data-bt="BT-130">Einheit</th>
            <th data-i18n="unitPrice">Einzelpreis</th>
            <th data-i18n="lineNet">Zeilen-Netto</th>
            <th data-i18n="taxRate">Steuersatz</th>
            <th data-i18n="lineGross">Zeilenbrutto</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ============================================================
       Application Script
       ============================================================ -->
  <script>
    (function () {
      "use strict";

      /* ==============================================================
         1. CONFIGURATION & CONSTANTS
         ============================================================== */

      // PDF.js worker
      if (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.6.172/pdf.worker.min.js";
      }

      // XML namespace resolver for ZUGFeRD / CrossIndustryInvoice
      const XML_NAMESPACES = {
        rsm: "urn:un:unece:uncefact:data:standard:CrossIndustryInvoice:100",
        ram: "urn:un:unece:uncefact:data:standard:ReusableAggregateBusinessInformationEntity:100",
        udt: "urn:un:unece:uncefact:data:standard:UnqualifiedDataType:100",
      };

      const nsResolver = (prefix) => XML_NAMESPACES[prefix] || null;

      // UNECE Rec 20 unit code mapping (DE / EN)
      const UNIT_CODE_MAP = {
        C62: { de: "St√ºck",        en: "Piece" },
        HUR: { de: "Stunde",       en: "Hour" },
        DAY: { de: "Tag",          en: "Day" },
        MON: { de: "Monat",        en: "Month" },
        ANN: { de: "Jahr",         en: "Year" },
        KGM: { de: "Kilogramm",    en: "Kilogram" },
        GRM: { de: "Gramm",        en: "Gram" },
        TNE: { de: "Tonne",        en: "Tonne" },
        MTR: { de: "Meter",        en: "Metre" },
        CMT: { de: "Zentimeter",   en: "Centimetre" },
        MTK: { de: "Quadratmeter", en: "Square metre" },
        MTQ: { de: "Kubikmeter",   en: "Cubic metre" },
        LTR: { de: "Liter",        en: "Litre" },
        MIN: { de: "Minute",       en: "Minute" },
        P1:  { de: "Prozent",      en: "Percent" },
        PR:  { de: "Paar",         en: "Pair" },
        PA:  { de: "Paket",        en: "Package" },
        CT:  { de: "Karton",       en: "Carton" },
        PAL: { de: "Palette",      en: "Pallet" },
        ZZ:  { de: "Pauschale",    en: "Lump sum" },
      };

      // Currency symbols
      const CURRENCY_SYMBOLS = {
        EUR: "‚Ç¨", USD: "$", GBP: "¬£", CHF: "CHF",
      };

      // Payment type codes (UNTDID 4461)
      const PAYMENT_TYPES = {
        de: {
          1: "Instrumentenbasierte Zahlung", 10: "Barzahlung", 20: "Scheck",
          30: "√úberweisung", 31: "Abbuchung", 42: "Zahlung an ein Bankkonto",
          48: "Kartenzahlung", 49: "Lastschrift", 58: "SEPA-√úberweisung",
          59: "SEPA-Lastschrift",
        },
        en: {
          1: "Instrument-based payment", 10: "Cash payment", 20: "Cheque",
          30: "Credit transfer", 31: "Debit transfer", 42: "Payment to a bank account",
          48: "Card payment", 49: "Direct debit", 58: "SEPA Credit Transfer",
          59: "SEPA Direct Debit",
        },
      };

      /* ==============================================================
         2. INTERNATIONALISATION (i18n)
         ============================================================== */

      const LABELS = {
        de: {
          mainTitle: "E-Rechnungs-Reader (ZUGFeRD, XRechnung, EN16931) mit PDF-Extraktion",
          descriptionTitle: "Beschreibung",
          descriptionText: "Dieses Tool erm√∂glicht das Anzeigen von elektronischen Rechnungen im XML-Format sowie ZUGFeRD-PDF/A-3-Dateien. Die eingebettete XML-Datei in ZUGFeRD-PDFs wird automatisch extrahiert und die Rechnungsdaten werden strukturiert dargestellt.",
          disclaimerText: '<strong>Hinweis:</strong> Dieses Tool verarbeitet elektronische Rechnungen (z. B. ZUGFeRD, XRechnung) vollst√§ndig clientseitig im Browser. Die Dateien werden nicht hochgeladen oder gespeichert.<br/>Es wird keine Gew√§hr f√ºr die Richtigkeit, Vollst√§ndigkeit oder Rechtskonformit√§t der angezeigten Daten √ºbernommen. Jegliche Haftung f√ºr Sch√§den oder Verluste, die aus der Nutzung resultieren, ist ausgeschlossen. Die Verantwortung f√ºr die korrekte Verarbeitung und Pr√ºfung der Daten liegt beim Nutzer.',
          projectRelationText: 'Dieses Projekt geh√∂rt zusammen mit dem <a href="https://github.com/SimonWaldherr/InvoiceGenerator" target="_blank" rel="noopener noreferrer">InvoiceGenerator</a>. Den ZUGFeRD-Invoice-Rechnungsgenerator kannst du hier testen: <a href="https://simonwaldherr.github.io/InvoiceGenerator/" target="_blank" rel="noopener noreferrer">https://simonwaldherr.github.io/InvoiceGenerator/</a>',
          dropZoneText: "üìÑ Datei hierher ziehen und fallen lassen oder klicken, um eine Datei auszuw√§hlen.",
          supportedFormatsText: "Unterst√ºtzte Formate: ZUGFeRD PDF, XRechnung XML, EN16931 XML",
          loadingText: "Verarbeitung l√§uft...",
          successText: "‚úÖ Rechnung erfolgreich verarbeitet!",
          // Table headers
          posNr: "Pos.-Nr.", productName: "Produktname", description: "Beschreibung",
          notes: "Notiz", quantity: "Menge", unit: "Einheit", unitPrice: "Einzelpreis",
          lineNet: "Zeilen-Netto", taxRate: "Steuersatz", lineGross: "Zeilenbrutto",
          // Section titles
          xmlViewerSummary: "XML anzeigen",
          invoiceInfo: "üìã Rechnungsinformationen",
          sellerInfo: "üè¢ Verk√§ufer / Rechnungssteller",
          buyerInfo: "üë§ K√§ufer / Rechnungsempf√§nger",
          paymentInfo: "üí≥ Zahlungsinformationen",
          lineItems: "üì¶ Positionen",
          statistics: "üìä Statistiken",
          // Buttons
          downloadXml: "üìÑ XML speichern", downloadPdf: "üìã PDF speichern",
          downloadJson: "üìä JSON Export", downloadCsv: "üìà CSV Export",
          // Field labels
          invNumber: "Rechnungsnummer", invType: "Rechnungstyp",
          invDate: "Rechnungsdatum", invDueDate: "F√§lligkeitsdatum",
          invOrderNumber: "Bestellnummer", invNote: "Notiz",
          sellerName: "Name", sellerAddress: "Adresse",
          sellerEmail: "E-Mail", sellerPhone: "Telefon",
          sellerTaxID: "Steuer-ID", sellerRegister: "Handelsregister",
          buyerName: "Name", buyerAddress: "Adresse",
          buyerAddress2: "Adresszusatz", buyerEmail: "E-Mail",
          buyerPhone: "Telefon", buyerTaxID: "Steuer-ID",
          currency: "W√§hrung", paymentType: "Zahlungsart",
          paymentTerms: "Zahlungsziel", iban: "IBAN", bic: "BIC",
          accountHolder: "Kontoinhaber", netAmount: "Gesamt netto",
          taxAmount: "Steuerbetrag", grossAmount: "Gesamt brutto",
          dueAmount: "F√§lliger Betrag",
          // Stats
          statPositions: "Positionen", statNet: "Nettosumme",
          statTax: "Steuern", statGross: "Bruttosumme",
          // Errors
          noFileFound: "Keine XML-Datei im PDF gefunden.",
          unsupportedFormat: "Dateiformat nicht unterst√ºtzt. Bitte eine PDF (ZUGFeRD) oder XML-Datei hochladen.",
          invalidXml: "Die extrahierte Datei ist keine g√ºltige XML-Rechnung.",
          pdfNotAvailable: "Original-PDF ist nicht verf√ºgbar.",
          processingError: "Fehler beim Verarbeiten der Datei: ",
          noPositionsToExport: "Keine Positionen zum Exportieren verf√ºgbar.",
          // QR
          qrCodeTitle: "üì± QR-Code f√ºr √úberweisung",
          qrCodeInfoTitle: "Zum Bezahlen einfach QR-Code mit Banking-App scannen",
          qrCodeDetails: "EPC-QR-Code (Girocode) nach europ√§ischem Standard",
          // Misc
          loadSample: "üß™ Beispiel-Rechnung laden",
          copy: "Kopieren", copied: "Kopiert!",
          showQr: "QR-Code anzeigen", saveQr: "QR-Code speichern",
          close: "Schlie√üen",
          sampleLoadError: "Beispiel-Rechnung konnte nicht geladen werden: ",
        },
        en: {
          mainTitle: "Electronic Invoice Reader (ZUGFeRD, XRechnung, EN16931) with PDF Extraction",
          descriptionTitle: "Description",
          descriptionText: "This tool allows viewing electronic invoices in XML format as well as ZUGFeRD PDF/A-3 files. The embedded XML file in ZUGFeRD PDFs is automatically extracted and the invoice data is displayed in a structured format.",
          disclaimerText: '<strong>Note:</strong> This tool processes electronic invoices (e.g. ZUGFeRD, XRechnung) completely client-side in the browser. Files are not uploaded or stored.<br/>No warranty is given for the accuracy, completeness or legal compliance of the displayed data. Any liability for damage or loss resulting from use is excluded. The responsibility for correct processing and verification of data lies with the user.',
          projectRelationText: 'This project belongs together with the <a href="https://github.com/SimonWaldherr/InvoiceGenerator" target="_blank" rel="noopener noreferrer">InvoiceGenerator</a>. You can test the ZUGFeRD invoice generator here: <a href="https://simonwaldherr.github.io/InvoiceGenerator/" target="_blank" rel="noopener noreferrer">https://simonwaldherr.github.io/InvoiceGenerator/</a>',
          dropZoneText: "üìÑ Drag and drop a file here or click to select a file.",
          supportedFormatsText: "Supported formats: ZUGFeRD PDF, XRechnung XML, EN16931 XML",
          loadingText: "Processing...",
          successText: "‚úÖ Invoice processed successfully!",
          posNr: "No.", productName: "Product Name", description: "Description",
          notes: "Notes", quantity: "Quantity", unit: "Unit", unitPrice: "Unit Price",
          lineNet: "Line Net", taxRate: "Tax Rate", lineGross: "Line Gross",
          xmlViewerSummary: "Show XML",
          invoiceInfo: "üìã Invoice Information",
          sellerInfo: "üè¢ Seller / Issuer",
          buyerInfo: "üë§ Buyer / Recipient",
          paymentInfo: "üí≥ Payment Information",
          lineItems: "üì¶ Line Items",
          statistics: "üìä Statistics",
          downloadXml: "üìÑ Save XML", downloadPdf: "üìã Save PDF",
          downloadJson: "üìä JSON Export", downloadCsv: "üìà CSV Export",
          invNumber: "Invoice Number", invType: "Invoice Type",
          invDate: "Invoice Date", invDueDate: "Due Date",
          invOrderNumber: "Order Number", invNote: "Note",
          sellerName: "Name", sellerAddress: "Address",
          sellerEmail: "Email", sellerPhone: "Phone",
          sellerTaxID: "Tax ID", sellerRegister: "Commercial Register",
          buyerName: "Name", buyerAddress: "Address",
          buyerAddress2: "Address line 2", buyerEmail: "Email",
          buyerPhone: "Phone", buyerTaxID: "Tax ID",
          currency: "Currency", paymentType: "Payment Type",
          paymentTerms: "Payment Terms", iban: "IBAN", bic: "BIC",
          accountHolder: "Account Holder", netAmount: "Total Net",
          taxAmount: "Tax Amount", grossAmount: "Total Gross",
          dueAmount: "Amount Due",
          statPositions: "Line Items", statNet: "Net Total",
          statTax: "Taxes", statGross: "Gross Total",
          noFileFound: "No XML file found in the PDF.",
          unsupportedFormat: "Unsupported file format. Please upload a PDF (ZUGFeRD) or XML file.",
          invalidXml: "The extracted file is not a valid XML invoice.",
          pdfNotAvailable: "Original PDF is not available.",
          processingError: "Error processing the file: ",
          noPositionsToExport: "No line items available for export.",
          qrCodeTitle: "üì± QR Code for Payment",
          qrCodeInfoTitle: "Simply scan QR code with your banking app to pay",
          qrCodeDetails: "EPC QR Code (Girocode) according to European standard",
          loadSample: "üß™ Load sample invoice",
          copy: "Copy", copied: "Copied!",
          showQr: "Show QR Code", saveQr: "Save QR Code",
          close: "Close",
          sampleLoadError: "Sample invoice could not be loaded: ",
        },
      };

      /* ==============================================================
         3. APPLICATION STATE
         ============================================================== */

      let currentLanguage = "de";
      let xmlDoc = null;
      let originalPdfBlob = null;
      let originalXmlBlob = null;
      let invoiceData = {};

      /** Shortcut for current labels */
      const L = () => LABELS[currentLanguage] || LABELS.de;

      /* ==============================================================
         4. DOM REFERENCES (cached once)
         ============================================================== */

      const $ = (id) => document.getElementById(id);
      const dom = {
        dropZone:        $("dropZone"),
        fileInput:       $("invoiceFile"),
        loadSampleBtn:   $("loadSampleBtn"),
        loadingSection:  $("loadingSection"),
        successSection:  $("successSection"),
        errorSection:    $("errorSection"),
        statsSection:    $("statsSection"),
        headerSection:   $("headerSection"),
        sellerSection:   $("sellerSection"),
        buyerSection:    $("buyerSection"),
        paymentSection:  $("paymentSection"),
        lineItemsSection:$("lineItemsSection"),
        xmlViewer:       $("xmlViewer"),
        originalXml:     $("originalXml"),
        downloadButtons: $("downloadButtons"),
        lineItemsTable:  $("lineItemsTable"),
        qrModal:         $("qrModal"),
        showQrBtn:       $("showQrBtn"),
        downloadQrBtn:   $("downloadQrBtn"),
        modalDownloadQr: $("modalDownloadQrBtn"),
        closeQrModal:    $("closeQrModal"),
      };

      const CONTENT_SECTIONS = [
        dom.headerSection, dom.sellerSection, dom.buyerSection,
        dom.paymentSection, dom.lineItemsSection, dom.xmlViewer,
        dom.downloadButtons, dom.statsSection,
      ];

      /* ==============================================================
         5. PURE UTILITY FUNCTIONS
         ============================================================== */

      /** Validate IBAN checksum (ISO 13616 mod-97) */
      function isValidIBAN(iban) {
        if (!iban) return false;
        const cleaned = iban.replace(/\s+/g, "").toUpperCase();
        if (!/^[A-Z]{2}\d{2}[A-Z0-9]{1,30}$/.test(cleaned)) return false;
        const rearranged = cleaned.slice(4) + cleaned.slice(0, 4);
        const expanded = rearranged.replace(/[A-Z]/g, (c) => (c.charCodeAt(0) - 55).toString());
        let remainder = 0;
        for (let i = 0; i < expanded.length; i += 7) {
          remainder = parseInt(remainder.toString() + expanded.substr(i, 7), 10) % 97;
        }
        return remainder === 1;
      }

      /** Format IBAN in groups of 4 for readability */
      function formatIBAN(iban) {
        return iban.replace(/\s+/g, "").replace(/(.{4})/g, "$1 ").trim();
      }

      /** Get readable unit name for a UNECE Rec 20 code */
      function getUnitDisplay(code) {
        if (!code) return "";
        const normalized = code.trim().toUpperCase();
        const entry = UNIT_CODE_MAP[normalized];
        if (!entry) return normalized;
        return `${entry[currentLanguage] || entry.de} (${normalized})`;
      }

      /** Map currency code to symbol */
      function getCurrencySymbol(code) {
        return CURRENCY_SYMBOLS[code] || code;
      }

      /** Format a numeric amount with currency symbol */
      function formatCurrency(amount, symbol) {
        const formatted = parseFloat(amount).toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
        if (symbol === "$" || symbol === "¬£") return `${symbol}${formatted}`;
        return `${formatted} ${symbol}`;
      }

      /** Look up payment type name by UNTDID 4461 code */
      function getPaymentTypeName(code) {
        const dict = PAYMENT_TYPES[currentLanguage] || PAYMENT_TYPES.de;
        const fallback = currentLanguage === "en" ? `Unknown (${code})` : `Unbekannt (${code})`;
        return dict[code] || fallback;
      }

      /** Format ZUGFeRD date strings (YYYYMMDD or YYYY-MM-DD) ‚Üí DD.MM.YYYY */
      function formatDate(str) {
        if (/^\d{8}$/.test(str)) return `${str.slice(6, 8)}.${str.slice(4, 6)}.${str.slice(0, 4)}`;
        if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
          const [y, m, d] = str.split("-");
          return `${d}.${m}.${y}`;
        }
        return str;
      }

      /** Escape HTML entities */
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      /** Truncate string to a maximum length */
      function truncate(str, max) {
        return str.length <= max ? str : str.substring(0, max);
      }

      /** Pretty-print XML */
      function beautifyXml(xml) {
        const INDENT = "  ";
        let formatted = "";
        let depth = 0;

        xml.replace(/(>)(<)(\/*)/g, "$1\r\n$2$3")
          .split("\r\n")
          .forEach((node) => {
            let delta = 0;
            if (node.match(/.+<\/\w[^>]*>$/)) {
              delta = 0; // self-closing or inline
            } else if (node.match(/^<\/\w/)) {
              if (depth > 0) depth--;
            } else if (node.match(/^<\w[^>]*[^/]>.*$/)) {
              delta = 1; // opening tag
            }
            formatted += INDENT.repeat(depth) + node.trim() + "\r\n";
            depth += delta;
          });

        return formatted;
      }

      /** Trigger download of a Blob */
      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement("a"), {
          href: url, download: filename, style: "display:none",
        });
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      /* ==============================================================
         6. XPath HELPERS
         ============================================================== */

      function xpathNode(ctx, xpath) {
        return xmlDoc.evaluate(xpath, ctx, nsResolver, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
      }

      function xpathNodes(ctx, xpath) {
        const result = xmlDoc.evaluate(xpath, ctx, nsResolver, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
        return Array.from({ length: result.snapshotLength }, (_, i) => result.snapshotItem(i));
      }

      /* ==============================================================
         7. i18n ‚Äî DATA-ATTRIBUTE DRIVEN LANGUAGE SWITCHING
         ============================================================== */

      /**
       * Update all elements with data-i18n / data-i18n-html attributes,
       * then re-apply BT tags from data-bt attributes.
       */
      function applyLanguage() {
        const labels = L();

        // Text content translations
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.getAttribute("data-i18n");
          if (labels[key] != null) el.textContent = labels[key];
        });

        // HTML translations (for elements needing rich content)
        document.querySelectorAll("[data-i18n-html]").forEach((el) => {
          const key = el.getAttribute("data-i18n-html");
          if (labels[key] != null) el.innerHTML = labels[key];
        });

        // Re-apply ZUGFeRD BT code tags
        document.querySelectorAll("[data-bt]").forEach((el) => {
          const existing = el.querySelector(".zugferd-tag");
          if (existing) existing.remove();
          const tag = document.createElement("span");
          tag.className = "zugferd-tag";
          tag.textContent = ` (${el.getAttribute("data-bt")})`;
          el.appendChild(tag);
        });

        // QR button labels (not data-i18n since they might be hidden/dynamic)
        if (dom.showQrBtn) dom.showQrBtn.textContent = labels.showQr;
        if (dom.downloadQrBtn) dom.downloadQrBtn.textContent = labels.saveQr;
        if (dom.modalDownloadQr) dom.modalDownloadQr.textContent = labels.saveQr;
        const closeBtn = dom.closeQrModal;
        if (closeBtn) closeBtn.textContent = labels.close;

        // Language toggle buttons
        document.querySelectorAll(".lang-btn").forEach((b) => b.classList.remove("active"));
        $(currentLanguage === "de" ? "langDe" : "langEn").classList.add("active");

        // Page title
        document.title = labels.mainTitle;
      }

      function setLanguage(lang) {
        currentLanguage = lang;
        try { localStorage.setItem("lang", lang); } catch (_) { /* ignored */ }
        applyLanguage();
      }

      function initLanguage() {
        let saved = null;
        try { saved = localStorage.getItem("lang"); } catch (_) { /* ignored */ }
        const browserLang = (navigator.language || navigator.userLanguage || "en");
        setLanguage(saved || (browserLang.startsWith("de") ? "de" : "en"));
      }

      /* ==============================================================
         8. UI HELPERS ‚Äî SHOW / HIDE / RESET
         ============================================================== */

      function showLoading() { dom.loadingSection.classList.remove("hidden"); }
      function hideLoading() { dom.loadingSection.classList.add("hidden"); }

      function showSuccess() {
        dom.successSection.classList.remove("hidden");
        setTimeout(() => dom.successSection.classList.add("hidden"), 3000);
      }

      function showError(msg) {
        dom.errorSection.textContent = msg;
        dom.errorSection.classList.remove("hidden");
      }

      /** Attach a one-click copy button next to a table cell's text */
      function attachCopyButton(cellId) {
        const cell = $(cellId);
        if (!cell || cell.querySelector(".copy-btn")) return;
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "copy-btn";
        btn.style.marginLeft = "8px";
        btn.style.fontSize = "0.85em";
        btn.textContent = L().copy;
        btn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(cell.firstChild?.textContent?.trim() || "");
            const prev = btn.textContent;
            btn.textContent = L().copied;
            setTimeout(() => { btn.textContent = prev; }, 1200);
          } catch (e) {
            console.error("Clipboard failed", e);
          }
        });
        cell.appendChild(btn);
      }

      /** Set a cell's text and store a value in invoiceData */
      function setField(cellId, value, dataPath) {
        if (value == null || value === "") return;
        const cell = $(cellId);
        if (cell) cell.textContent = value;
        if (dataPath) {
          const parts = dataPath.split(".");
          let obj = invoiceData;
          for (let i = 0; i < parts.length - 1; i++) {
            if (!obj[parts[i]]) obj[parts[i]] = {};
            obj = obj[parts[i]];
          }
          obj[parts[parts.length - 1]] = value;
        }
      }

      function resetUI() {
        dom.errorSection.textContent = "";
        dom.errorSection.classList.add("hidden");
        dom.successSection.classList.add("hidden");

        CONTENT_SECTIONS.forEach((s) => s.classList.add("hidden"));

        // Reset QR modal
        if (dom.qrModal) {
          dom.qrModal.classList.remove("visible");
          dom.qrModal.setAttribute("aria-hidden", "true");
          const container = dom.qrModal.querySelector(".qr-code-container");
          if (container) container.innerHTML = "";
          if (dom.modalDownloadQr) dom.modalDownloadQr.onclick = null;
        }
        if (dom.showQrBtn) dom.showQrBtn.classList.add("hidden");
        if (dom.downloadQrBtn) dom.downloadQrBtn.classList.add("hidden");

        // Clear table cells
        document.querySelectorAll(
          "#headerSection td, #sellerSection td, #buyerSection td, #paymentSection td"
        ).forEach((td) => (td.textContent = ""));

        dom.originalXml.textContent = "";
        dom.lineItemsTable.querySelector("tbody").innerHTML = "";

        invoiceData = {};
      }

      /* ==============================================================
         9. PDF XML EXTRACTION
         ============================================================== */

      async function extractXmlFromPdf(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(arrayBuffer) }).promise;
        const attachments = await pdf.getAttachments();
        if (!attachments) return null;

        for (const [filename, attachment] of Object.entries(attachments)) {
          if (filename.toLowerCase().endsWith(".xml")) {
            return new TextDecoder("utf-8").decode(attachment.content);
          }
        }
        return null;
      }

      /* ==============================================================
         10. INVOICE DATA EXTRACTION & DISPLAY
         ============================================================== */

      function displayInvoiceInfo() {
        const invNumber   = xpathNode(xmlDoc, "/rsm:CrossIndustryInvoice/rsm:ExchangedDocument/ram:ID");
        const invType     = xpathNode(xmlDoc, "/rsm:CrossIndustryInvoice/rsm:ExchangedDocument/ram:TypeCode");
        const invDateNode = xpathNode(xmlDoc, "/rsm:CrossIndustryInvoice/rsm:ExchangedDocument/ram:IssueDateTime/udt:DateTimeString");
        const invDueNode  = xpathNode(xmlDoc, "//ram:SpecifiedTradePaymentTerms/ram:DueDateDateTime/udt:DateTimeString");
        const invOrder    = xpathNode(xmlDoc, "//ram:BuyerOrderReferencedDocument/ram:IssuerAssignedID");
        const invNotes    = xpathNodes(xmlDoc, "/rsm:CrossIndustryInvoice/rsm:ExchangedDocument/ram:IncludedNote/ram:Content");

        invoiceData.header = {};

        if (invNumber) {
          setField("invNumber", invNumber.textContent.trim(), "header.number");
          attachCopyButton("invNumber");
        }
        if (invType)     setField("invType", invType.textContent.trim(), "header.type");
        if (invDateNode) setField("invDate", formatDate(invDateNode.textContent.trim()), "header.date");
        if (invDueNode)  setField("invDueDate", formatDate(invDueNode.textContent.trim()), "header.dueDate");
        if (invOrder)    setField("invOrderNumber", invOrder.textContent.trim(), "header.orderNumber");

        if (invNotes.length > 0) {
          const notes = invNotes.map((n) => n.textContent.trim()).join("\n");
          setField("invNote", notes, "header.notes");
        }

        dom.headerSection.classList.remove("hidden");
      }

      function displayPartyInfo(partyXPath, sectionEl, fieldMappings) {
        const dataKey = sectionEl === dom.sellerSection ? "seller" : "buyer";
        invoiceData[dataKey] = {};

        fieldMappings.forEach(({ cellId, xpath, dataField, formatter }) => {
          const node = xpathNode(xmlDoc, xpath);
          if (node) {
            const val = formatter ? formatter(node.textContent.trim()) : node.textContent.trim();
            setField(cellId, val, `${dataKey}.${dataField}`);
          }
        });

        sectionEl.classList.remove("hidden");
      }

      function displaySellerInfo() {
        invoiceData.seller = {};

        // Name
        const sellerName = xpathNode(xmlDoc, "//ram:SellerTradeParty/ram:Name");
        if (sellerName) setField("sellerName", sellerName.textContent.trim(), "seller.name");

        // Address (composite)
        const street  = xpathNode(xmlDoc, "//ram:SellerTradeParty/ram:PostalTradeAddress/ram:LineOne");
        const city    = xpathNode(xmlDoc, "//ram:SellerTradeParty/ram:PostalTradeAddress/ram:CityName");
        const zip     = xpathNode(xmlDoc, "//ram:SellerTradeParty/ram:PostalTradeAddress/ram:PostcodeCode");
        const country = xpathNode(xmlDoc, "//ram:SellerTradeParty/ram:PostalTradeAddress/ram:CountryID");
        const address = [
          street?.textContent.trim(),
          (zip && city) ? `${zip.textContent.trim()} ${city.textContent.trim()}` : null,
          country?.textContent.trim(),
        ].filter(Boolean).join(", ");
        if (address) setField("sellerAddress", address, "seller.address");

        // Contact
        const email = xpathNode(xmlDoc, "//ram:SellerTradeParty/ram:DefinedTradeContact/ram:EmailURIUniversalCommunication/ram:URIID");
        const phone = xpathNode(xmlDoc, "//ram:SellerTradeParty/ram:DefinedTradeContact/ram:TelephoneUniversalCommunication/ram:CompleteNumber");
        if (email) setField("sellerEmail", email.textContent.trim(), "seller.email");
        if (phone) setField("sellerPhone", phone.textContent.trim(), "seller.phone");

        // Tax
        const taxVA = xpathNode(xmlDoc, "//ram:SellerTradeParty/ram:SpecifiedTaxRegistration/ram:ID[@schemeID='VA']");
        const taxFC = xpathNode(xmlDoc, "//ram:SellerTradeParty/ram:SpecifiedTaxRegistration/ram:ID[@schemeID='FC']");
        const taxInfo = [
          taxVA ? `VA: ${taxVA.textContent.trim()}` : null,
          taxFC ? `FC: ${taxFC.textContent.trim()}` : null,
        ].filter(Boolean).join("\n");
        if (taxInfo) setField("sellerTaxID", taxInfo, "seller.taxId");

        // Register
        const register = xpathNode(xmlDoc, "//ram:SellerTradeParty/ram:SpecifiedLegalOrganization/ram:ID");
        if (register) setField("sellerRegister", register.textContent.trim(), "seller.register");

        dom.sellerSection.classList.remove("hidden");
      }

      function displayBuyerInfo() {
        invoiceData.buyer = {};

        const buyerName = xpathNode(xmlDoc, "//ram:BuyerTradeParty/ram:Name");
        if (buyerName) setField("buyerName", buyerName.textContent.trim(), "buyer.name");

        const street  = xpathNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:LineOne");
        const line2   = xpathNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:LineTwo");
        const city    = xpathNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:CityName");
        const zip     = xpathNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:PostcodeCode");
        const country = xpathNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:CountryID");

        const address = [
          street?.textContent.trim(),
          (zip && city) ? `${zip.textContent.trim()} ${city.textContent.trim()}` : null,
          country?.textContent.trim(),
        ].filter(Boolean).join(", ");
        if (address)  setField("buyerAddress", address, "buyer.address");
        if (line2)    setField("buyerAddress2", line2.textContent.trim(), "buyer.address2");

        const email = xpathNode(xmlDoc, "//ram:BuyerTradeParty/ram:DefinedTradeContact/ram:EmailURIUniversalCommunication/ram:URIID");
        const phone = xpathNode(xmlDoc, "//ram:BuyerTradeParty/ram:DefinedTradeContact/ram:TelephoneUniversalCommunication/ram:CompleteNumber");
        if (email) setField("buyerEmail", email.textContent.trim(), "buyer.email");
        if (phone) setField("buyerPhone", phone.textContent.trim(), "buyer.phone");

        const taxVA = xpathNode(xmlDoc, "//ram:BuyerTradeParty/ram:SpecifiedTaxRegistration/ram:ID[@schemeID='VA']");
        const taxFC = xpathNode(xmlDoc, "//ram:BuyerTradeParty/ram:SpecifiedTaxRegistration/ram:ID[@schemeID='FC']");
        const taxInfo = [
          taxVA ? `VA: ${taxVA.textContent.trim()}` : null,
          taxFC ? `FC: ${taxFC.textContent.trim()}` : null,
        ].filter(Boolean).join("\n");
        if (taxInfo) setField("buyerTaxID", taxInfo, "buyer.taxId");

        dom.buyerSection.classList.remove("hidden");
      }

      function displayPaymentInfo() {
        const paymentMeans = xpathNode(xmlDoc, "//ram:ApplicableHeaderTradeSettlement/ram:SpecifiedTradeSettlementPaymentMeans");
        const paymentTerms = xpathNode(xmlDoc, "//ram:SpecifiedTradePaymentTerms/ram:Description");
        let currencySymbol = "‚Ç¨";

        invoiceData.payment = {};

        if (paymentMeans) {
          // Currency
          const currencyNode = xpathNode(xmlDoc, "//ram:ApplicableHeaderTradeSettlement/ram:InvoiceCurrencyCode");
          let currencyCode = "EUR";
          if (currencyNode) {
            currencyCode = currencyNode.textContent.trim();
            setField("currency", currencyCode, "payment.currency");
            currencySymbol = getCurrencySymbol(currencyCode);
          }

          // Payment type
          const typeCode = xpathNode(paymentMeans, ".//ram:TypeCode");
          if (typeCode) {
            const typeName = getPaymentTypeName(typeCode.textContent.trim());
            setField("paymentType", typeName, "payment.type");
          }

          // IBAN
          const ibanNode = xpathNode(paymentMeans,
            ".//ram:PayerPartyCreditorFinancialAccount/ram:IBANID | .//ram:PayeePartyCreditorFinancialAccount/ram:IBANID");
          if (ibanNode) {
            const rawIban = ibanNode.textContent.trim();
            setField("iban", formatIBAN(rawIban), "payment.iban");
            invoiceData.payment.iban = rawIban; // store raw value for QR code
            if (!isValidIBAN(rawIban)) console.warn("Invalid IBAN detected");
            attachCopyButton("iban");
          }

          // BIC
          const bicNode = xpathNode(paymentMeans,
            ".//ram:PayeeSpecifiedCreditorFinancialInstitution/ram:BICID | .//ram:PayeePartyCreditorFinancialInstitution/ram:BICID");
          if (bicNode) {
            setField("bic", bicNode.textContent.trim(), "payment.bic");
            attachCopyButton("bic");
          }

          // Account holder
          const holderNode = xpathNode(paymentMeans, ".//ram:PayeePartyCreditorFinancialAccount/ram:AccountName");
          if (holderNode) setField("accountHolder", holderNode.textContent.trim(), "payment.accountHolder");
        }

        // Payment terms
        if (paymentTerms) setField("paymentTerms", paymentTerms.textContent.trim(), "payment.terms");

        // Monetary summation
        const summation = xpathNode(xmlDoc,
          "//ram:ApplicableHeaderTradeSettlement/ram:SpecifiedTradeSettlementMonetarySummation | " +
          "//ram:ApplicableHeaderTradeSettlement/ram:SpecifiedTradeSettlementHeaderMonetarySummation");

        if (summation) {
          const amounts = [
            { xpath: ".//ram:LineTotalAmount",   cellId: "netAmount",   key: "netAmount" },
            { xpath: ".//ram:TaxTotalAmount",     cellId: "taxAmount",   key: "taxAmount" },
            { xpath: ".//ram:GrandTotalAmount",   cellId: "grossAmount", key: "grossAmount" },
            { xpath: ".//ram:DuePayableAmount",   cellId: "dueAmount",   key: "dueAmount" },
          ];

          amounts.forEach(({ xpath, cellId, key }) => {
            const node = xpathNode(summation, xpath);
            if (node) {
              const raw = node.textContent.trim();
              setField(cellId, formatCurrency(raw, currencySymbol));
              invoiceData.payment[key] = parseFloat(raw);
            }
          });
        }

        dom.paymentSection.classList.remove("hidden");
        generateEPCQRCode(invoiceData.payment);
      }

      function displayLineItems() {
        const items = xpathNodes(xmlDoc, "//ram:IncludedSupplyChainTradeLineItem");
        const tbody = dom.lineItemsTable.querySelector("tbody");
        const currencyCode = $("currency")?.textContent?.trim() || "EUR";
        const symbol = getCurrencySymbol(currencyCode);
        let totalNet = 0;

        invoiceData.lineItems = [];

        items.forEach((item, index) => {
          const lineID      = xpathNode(item, "./ram:AssociatedDocumentLineDocument/ram:LineID")?.textContent.trim() || String(index + 1);
          const productNote = xpathNode(item, "./ram:AssociatedDocumentLineDocument/ram:IncludedNote/ram:Content")?.textContent.trim() || "";
          const productName = xpathNode(item, "./ram:SpecifiedTradeProduct/ram:Name")?.textContent.trim() || "";
          const productDesc = xpathNode(item, "./ram:SpecifiedTradeProduct/ram:Description")?.textContent.trim() || "";
          const qtyEl       = xpathNode(item, "./ram:SpecifiedLineTradeDelivery/ram:BilledQuantity");
          const quantity     = parseFloat(qtyEl?.textContent.trim() || "0");
          const unitCode     = qtyEl?.getAttribute("unitCode") || "";
          const unitDisplay  = getUnitDisplay(unitCode);
          const unitPrice    = parseFloat(xpathNode(item, "./ram:SpecifiedLineTradeAgreement/ram:NetPriceProductTradePrice/ram:ChargeAmount")?.textContent.trim() || "0");
          const taxRate      = parseFloat(xpathNode(item, "./ram:SpecifiedLineTradeSettlement/ram:ApplicableTradeTax/ram:RateApplicablePercent")?.textContent.trim() || "0");
          const lineNet      = unitPrice * quantity;
          const lineGross    = lineNet + lineNet * (taxRate / 100);

          totalNet += lineNet;

          invoiceData.lineItems.push({
            position: lineID, productName, description: productDesc,
            notes: productNote, quantity, unitCode, unit: unitDisplay,
            unitPrice, lineNet, taxRate, lineGross,
          });

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(lineID)}</td>
            <td>${escapeHtml(productName)}</td>
            <td>${escapeHtml(productDesc)}</td>
            <td>${escapeHtml(productNote)}</td>
            <td>${escapeHtml(quantity.toFixed(2))}</td>
            <td>${escapeHtml(unitDisplay)}</td>
            <td>${formatCurrency(unitPrice.toFixed(2), symbol)}</td>
            <td>${formatCurrency(lineNet.toFixed(2), symbol)}</td>
            <td>${escapeHtml(taxRate.toFixed(2))}%</td>
            <td>${formatCurrency(lineGross.toFixed(2), symbol)}</td>
          `;
          tbody.appendChild(tr);
        });

        if (items.length > 0) {
          const net = $("netAmount");
          if (!net.textContent) net.textContent = formatCurrency(totalNet.toFixed(2), symbol);
          dom.lineItemsSection.classList.remove("hidden");
        }

        return items.length;
      }

      function displayStatistics(count) {
        $("statLineItems").textContent  = count;
        $("statNetAmount").textContent  = $("netAmount").textContent  || "0 ‚Ç¨";
        $("statTaxAmount").textContent  = $("taxAmount").textContent  || "0 ‚Ç¨";
        $("statGrossAmount").textContent = $("grossAmount").textContent || "0 ‚Ç¨";
        dom.statsSection.classList.remove("hidden");
      }

      /* ==============================================================
         11. EPC QR CODE GENERATION
         ============================================================== */

      function generateEPCQRCode(paymentData) {
        const modalContainer = dom.qrModal?.querySelector(".qr-code-container");

        if (!paymentData?.iban || (!paymentData.grossAmount && !paymentData.dueAmount)) {
          if (dom.showQrBtn)     dom.showQrBtn.classList.add("hidden");
          if (dom.downloadQrBtn) dom.downloadQrBtn.classList.add("hidden");
          if (dom.qrModal) {
            dom.qrModal.classList.remove("visible");
            dom.qrModal.setAttribute("aria-hidden", "true");
            if (modalContainer) modalContainer.innerHTML = "";
          }
          return;
        }

        try {
          if (modalContainer) modalContainer.innerHTML = "";

          // Build EPC069-12 payload
          let amount = paymentData.grossAmount || paymentData.dueAmount || 0;
          if (amount > 999999999.99) amount = 999999999.99;

          const prefix = currentLanguage === "en" ? "Invoice" : "Rechnung";
          const epcPayload = [
            "BCD",                                          // Service Tag
            "002",                                          // Version
            "1",                                            // Charset (UTF-8)
            "SCT",                                          // SEPA Credit Transfer
            paymentData.bic || "",                           // BIC
            truncate(invoiceData.seller?.name || "", 70),   // Beneficiary
            paymentData.iban.replace(/\s/g, ""),            // IBAN
            `EUR${amount.toFixed(2)}`,                      // Amount
            "",                                             // Purpose
            "",                                             // Structured reference
            truncate(`${prefix} ${invoiceData.header?.number || ""}`.trim(), 140),
            "",                                             // Beneficiary info
          ].join("\n");

          const canvas = document.createElement("canvas");
          if (modalContainer) modalContainer.appendChild(canvas);

          QRCode.toCanvas(canvas, epcPayload, {
            width: 200, height: 200,
            color: { dark: "#000000", light: "#FFFFFF" },
            errorCorrectionLevel: "M",
          }, (error) => {
            if (error) {
              console.error("EPC QR Code generation failed:", error);
              if (dom.showQrBtn) dom.showQrBtn.classList.add("hidden");
              return;
            }

            // Show "open modal" button
            if (dom.showQrBtn) {
              dom.showQrBtn.classList.remove("hidden");
              dom.showQrBtn.onclick = () => {
                dom.qrModal.classList.add("visible");
                dom.qrModal.setAttribute("aria-hidden", "false");
              };
            }

            // Keep inline download hidden; use modal download
            if (dom.downloadQrBtn) dom.downloadQrBtn.classList.add("hidden");

            if (dom.modalDownloadQr) {
              dom.modalDownloadQr.onclick = () => {
                try {
                  const link = document.createElement("a");
                  link.href = canvas.toDataURL("image/png");
                  link.download = `epc_qrcode_${invoiceData.header?.number || "invoice"}.png`;
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
                } catch (e) { console.error("QR download failed", e); }
              };
            }

            if (dom.closeQrModal) {
              dom.closeQrModal.onclick = () => {
                dom.qrModal.classList.remove("visible");
                dom.qrModal.setAttribute("aria-hidden", "true");
              };
            }
          });
        } catch (error) {
          console.error("EPC QR Code generation failed:", error);
          if (dom.showQrBtn) dom.showQrBtn.classList.add("hidden");
          if (dom.downloadQrBtn) dom.downloadQrBtn.classList.add("hidden");
        }
      }

      /* ==============================================================
         12. EXPORT ‚Äî JSON & CSV
         ============================================================== */

      function downloadInvoiceAsJson() {
        const blob = new Blob([JSON.stringify(invoiceData, null, 2)], { type: "application/json" });
        downloadBlob(blob, `invoice_${invoiceData.header?.number || "unknown"}.json`);
      }

      function downloadInvoiceAsCsv() {
        const labels = L();
        if (!invoiceData.lineItems?.length) {
          alert(labels.noPositionsToExport);
          return;
        }

        const headers = [
          labels.posNr, labels.productName, labels.description, labels.notes,
          labels.quantity, labels.unit, labels.unitPrice, labels.lineNet,
          labels.taxRate, labels.lineGross,
        ];

        const rows = invoiceData.lineItems.map((item) => [
          `"${item.position}"`, `"${item.productName}"`,
          `"${item.description}"`, `"${item.notes}"`,
          item.quantity, `"${item.unit}"`,
          item.unitPrice.toFixed(2), item.lineNet.toFixed(2),
          item.taxRate.toFixed(2), item.lineGross.toFixed(2),
        ].join(","));

        const csv = [headers.join(","), ...rows].join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        downloadBlob(blob, `invoice_${invoiceData.header?.number || "unknown"}_positions.csv`);
      }

      /* ==============================================================
         13. MAIN PARSING PIPELINE
         ============================================================== */

      function parseXML(xmlString) {
        const parser = new DOMParser();
        xmlDoc = parser.parseFromString(xmlString, "application/xml");

        if (xmlDoc.querySelector("parsererror")) {
          showError(L().invalidXml);
          return;
        }

        // Show raw XML
        dom.originalXml.textContent = beautifyXml(xmlString);
        dom.xmlViewer.classList.remove("hidden");

        // Configure download buttons
        if (originalXmlBlob || originalPdfBlob) {
          dom.downloadButtons.classList.remove("hidden");
          $("downloadXml").onclick = () => downloadBlob(originalXmlBlob, "invoice.xml");
          $("downloadPdf").onclick = () => {
            if (originalPdfBlob) downloadBlob(originalPdfBlob, "invoice.pdf");
            else showError(L().pdfNotAvailable);
          };
          $("downloadJson").onclick = downloadInvoiceAsJson;
          $("downloadCsv").onclick = downloadInvoiceAsCsv;
        }

        // Extract & display all sections
        displayInvoiceInfo();
        displaySellerInfo();
        displayBuyerInfo();
        displayPaymentInfo();
        const count = displayLineItems();
        displayStatistics(count);
        showSuccess();
      }

      /* ==============================================================
         14. FILE HANDLING
         ============================================================== */

      async function handleFile(file) {
        resetUI();
        showLoading();

        try {
          if (file.type === "application/pdf") {
            originalPdfBlob = file;
            const xmlContent = await extractXmlFromPdf(file);
            if (xmlContent) {
              originalXmlBlob = new Blob([xmlContent], { type: "application/xml" });
              parseXML(xmlContent);
            } else {
              showError(L().noFileFound);
            }
          } else if (file.name.toLowerCase().endsWith(".xml")) {
            originalXmlBlob = file;
            parseXML(await file.text());
          } else {
            showError(L().unsupportedFormat);
          }
        } catch (err) {
          showError(`${L().processingError}${err.message}`);
          console.error(err);
        } finally {
          hideLoading();
        }
      }

      /* ==============================================================
         15. EVENT LISTENERS
         ============================================================== */

      // Language toggle
      $("langDe").addEventListener("click", () => setLanguage("de"));
      $("langEn").addEventListener("click", () => setLanguage("en"));

      // Drop zone
      dom.dropZone.addEventListener("click", () => dom.fileInput.click());

      dom.dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dom.dropZone.classList.add("dragover");
      });

      dom.dropZone.addEventListener("dragleave", (e) => {
        e.preventDefault();
        dom.dropZone.classList.remove("dragover");
      });

      dom.dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dom.dropZone.classList.remove("dragover");
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file);
      });

      dom.fileInput.addEventListener("change", () => {
        const file = dom.fileInput.files[0];
        if (file) handleFile(file);
      });

      // Sample invoice
      if (dom.loadSampleBtn) {
        dom.loadSampleBtn.addEventListener("click", async () => {
          try {
            resetUI();
            showLoading();
            const resp = await fetch("https://simonwaldherr.github.io/InvoiceInspector/RE-2025-0815.pdf");
            if (!resp.ok) throw new Error("HTTP " + resp.status);
            const blob = await resp.blob();
            await handleFile(new File([blob], "RE-2025-0815.pdf", { type: "application/pdf" }));
          } catch (e) {
            console.error("Sample invoice load failed", e);
            showError(L().sampleLoadError + e.message);
          } finally {
            hideLoading();
            dom.loadSampleBtn.classList.add("hidden");
          }
        });
      }

      /* ==============================================================
         16. INITIALISE
         ============================================================== */

      initLanguage();

    })();
  </script>
</body>
</html>
