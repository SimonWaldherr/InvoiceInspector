<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ZUGFeRD / XRechnung / EN16931 E-Rechnungs-Reader inkl. PDF-Extraktion</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.6.172/pdf.min.js"></script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.6;
      background: #f7f7f7;
    }

    h1, h2 {
      margin-bottom: 0.5em;
    }

    h1 {
      font-size: 2em;
      margin-top: 0;
      color: #333;
      flex: 1;
    }

    /* Language Switcher */
    .language-switcher {
      display: flex;
      gap: 5px;
    }

    .lang-btn {
      padding: 8px 15px;
      border: 2px solid #007BFF;
      background: #fff;
      color: #007BFF;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .lang-btn:hover {
      background: #f0f8ff;
      transform: scale(1.05);
    }

    .lang-btn.active {
      background: #007BFF;
      color: #fff;
    }

    .description, section, details {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .drop-zone {
      border: 2px dashed #aaa;
      border-radius: 5px;
      padding: 40px;
      text-align: center;
      color: #333;
      background: #fff;
      margin-bottom: 20px;
      transition: border-color 0.3s, background-color 0.3s;
      cursor: pointer;
      position: relative;
    }

    .drop-zone.dragover {
      border-color: #007BFF;
      background-color: #f0f8ff;
    }

    .drop-zone p {
      margin: 0;
      font-size: 1.1em;
    }

    .hidden {
      display: none;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
    }

    table th, table td {
      border: 1px solid #ccc;
      padding: 8px;
      vertical-align: top;
    }

    table th {
      background: #f0f0f0;
      text-align: left;
      width: 12.5%;
    }

    .error {
      color: red;
      background-color: #ffe6e6;
      padding: 10px;
      border-radius: 5px;
    }

    .download-buttons {
      margin-bottom: 20px;
      text-align: center;
    }

    .download-buttons button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #007BFF;
      color: white;
      transition: background-color 0.3s, transform 0.2s;
    }

    .download-buttons button:hover {
      background-color: #0056b3;
      transform: scale(1.05);
    }

    details summary {
      cursor: pointer;
      font-weight: bold;
    }

    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 400px;
      overflow: auto;
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background: #1a1a1a;
        color: #e0e0e0;
      }

      h1 {
        color: #e0e0e0;
      }

      .lang-btn {
        border-color: #0099ff;
        background: #2d2d2d;
        color: #0099ff;
      }

      .lang-btn:hover {
        background: #1a3a5a;
      }

      .lang-btn.active {
        background: #0099ff;
        color: #fff;
      }

      .description, section, details {
        background: #2d2d2d;
        border-color: #444;
        color: #e0e0e0;
      }

      .drop-zone {
        background: #2d2d2d;
        border-color: #555;
        color: #e0e0e0;
      }

      .drop-zone.dragover {
        border-color: #0099ff;
        background-color: #1a3a5a;
      }

      table th {
        background: #383838;
        color: #e0e0e0;
      }

      table th, table td {
        border-color: #555;
      }

      pre {
        background-color: #1e1e1e;
        border-color: #555;
        color: #e0e0e0;
      }

      .error {
        background-color: #4a1a1a;
        color: #ff9999;
      }
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007BFF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Improved table responsiveness */
    .table-container {
      overflow-x: auto;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    /* Success message */
    .success {
      color: #155724;
      background-color: #d4edda;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #c3e6cb;
      margin-bottom: 20px;
    }

    /* Statistics section */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #dee2e6;
      text-align: center;
    }

    .stat-card h3 {
      margin: 0 0 10px 0;
      font-size: 1.2em;
      color: #495057;
    }

    .stat-card .value {
      font-size: 1.5em;
      font-weight: bold;
      color: #007BFF;
    }

    @media (prefers-color-scheme: dark) {
      .stat-card {
        background: #343a40;
        border-color: #495057;
      }

      .stat-card h3 {
        color: #adb5bd;
      }

      .success {
        color: #b8e6b8;
        background-color: #155724;
        border-color: #28a745;
      }

      .table-container {
        border-color: #555;
      }
    }

    @media (max-width: 768px) {
      table th, table td {
        font-size: 0.9em;
      }

      .drop-zone {
        padding: 20px;
      }

      .download-buttons button {
        width: 100%;
        margin: 10px 0;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1 id="mainTitle">E-Rechnungs-Reader (ZUGFeRD, XRechnung, EN16931) mit PDF-Extraktion</h1>
    <div class="language-switcher">
      <button id="langDe" class="lang-btn active">🇩🇪 DE</button>
      <button id="langEn" class="lang-btn">🇺🇸 EN</button>
    </div>
  </div>

  <section class="description">
    <h2 id="descriptionTitle">Beschreibung</h2>
    <p id="descriptionText">Dieses Tool ermöglicht das Anzeigen von elektronischen Rechnungen im XML-Format sowie ZUGFeRD-PDF/A-3-Dateien. Die eingebettete XML-Datei in ZUGFeRD-PDFs wird automatisch extrahiert und die Rechnungsdaten werden strukturiert dargestellt.</p>
    <p id="disclaimerText"><strong>Hinweis:</strong> Dieses Tool verarbeitet elektronische Rechnungen (z. B. ZUGFeRD, XRechnung) vollständig clientseitig im Browser. Die Dateien werden nicht hochgeladen oder gespeichert.<br/>Es wird keine Gewähr für die Richtigkeit, Vollständigkeit oder Rechtskonformität der angezeigten Daten übernommen. Jegliche Haftung für Schäden oder Verluste, die aus der Nutzung resultieren, ist ausgeschlossen. Die Verantwortung für die korrekte Verarbeitung und Prüfung der Daten liegt beim Nutzer.</p>
  </section>

  <div class="drop-zone" id="dropZone">
    <p id="dropZoneText">📄 Datei hierher ziehen und fallen lassen oder klicken, um eine Datei auszuwählen.</p>
    <p id="supportedFormatsText" style="font-size: 0.9em; color: #666; margin-top: 10px;">Unterstützte Formate: ZUGFeRD PDF, XRechnung XML, EN16931 XML</p>
    <input type="file" id="invoiceFile" accept=".xml,.pdf,application/pdf" style="display:none;" />
  </div>

  <div id="loadingSection" class="hidden" style="text-align: center; padding: 20px;">
    <div class="loading"></div>
    <span id="loadingText">Verarbeitung läuft...</span>
  </div>

  <div id="successSection" class="success hidden">
    <span id="successText">✅ Rechnung erfolgreich verarbeitet!</span>
  </div>

  <section id="statsSection" class="hidden">
    <h2 id="statsTitle">📊 Statistiken</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <h3 id="statPositionsLabel">Positionen</h3>
        <div class="value" id="statLineItems">0</div>
      </div>
      <div class="stat-card">
        <h3 id="statNetLabel">Nettosumme</h3>
        <div class="value" id="statNetAmount">0 €</div>
      </div>
      <div class="stat-card">
        <h3 id="statTaxLabel">Steuern</h3>
        <div class="value" id="statTaxAmount">0 €</div>
      </div>
      <div class="stat-card">
        <h3 id="statGrossLabel">Bruttosumme</h3>
        <div class="value" id="statGrossAmount">0 €</div>
      </div>
    </div>
  </section>

  <div class="download-buttons hidden" id="downloadButtons">
    <button id="downloadXml">📄 XML speichern</button>
    <button id="downloadPdf">📋 PDF speichern</button>
    <button id="downloadJson">📊 JSON Export</button>
    <button id="downloadCsv">📈 CSV Export</button>
  </div>

  <details id="xmlViewer" class="hidden">
    <summary>XML anzeigen</summary>
    <pre id="originalXml"></pre>
  </details>

  <section id="errorSection" class="error hidden"></section>

  <section id="headerSection" class="hidden">
    <h2 id="invoiceInfoTitle">📋 Rechnungsinformationen</h2>
    <div class="table-container">
      <table>
        <tr><th id="invNumberLabel">Rechnungsnummer</th><td id="invNumber"></td></tr>
        <tr><th id="invTypeLabel">Rechnungstyp</th><td id="invType"></td></tr>
        <tr><th id="invDateLabel">Rechnungsdatum</th><td id="invDate"></td></tr>
        <tr><th id="invDueDateLabel">Fälligkeitsdatum</th><td id="invDueDate"></td></tr>
        <tr><th id="invOrderNumberLabel">Bestellnummer</th><td id="invOrderNumber"></td></tr>
        <tr><th id="invNoteLabel">Notiz</th><td id="invNote"></td></tr>
      </table>
    </div>
  </section>

  <section id="sellerSection" class="hidden">
    <h2 id="sellerInfoTitle">🏢 Verkäufer / Rechnungssteller</h2>
    <div class="table-container">
      <table>
        <tr><th id="sellerNameLabel">Name</th><td id="sellerName"></td></tr>
        <tr><th id="sellerAddressLabel">Adresse</th><td id="sellerAddress"></td></tr>
        <tr><th id="sellerEmailLabel">E-Mail</th><td id="sellerEmail"></td></tr>
        <tr><th id="sellerPhoneLabel">Telefon</th><td id="sellerPhone"></td></tr>
        <tr><th id="sellerTaxIDLabel">Steuer-ID</th><td id="sellerTaxID"></td></tr>
        <tr><th id="sellerRegisterLabel">Handelsregister</th><td id="sellerRegister"></td></tr>
      </table>
    </div>
  </section>

  <section id="buyerSection" class="hidden">
    <h2 id="buyerInfoTitle">👤 Käufer / Rechnungsempfänger</h2>
    <div class="table-container">
      <table>
        <tr><th id="buyerNameLabel">Name</th><td id="buyerName"></td></tr>
        <tr><th id="buyerAddressLabel">Adresse</th><td id="buyerAddress"></td></tr>
        <tr><th id="buyerEmailLabel">E-Mail</th><td id="buyerEmail"></td></tr>
        <tr><th id="buyerPhoneLabel">Telefon</th><td id="buyerPhone"></td></tr>
        <tr><th id="buyerTaxIDLabel">Steuer-ID</th><td id="buyerTaxID"></td></tr>
      </table>
    </div>
  </section>

  <section id="paymentSection" class="hidden">
    <h2 id="paymentInfoTitle">💳 Zahlungsinformationen</h2>
    <div class="table-container">
      <table>
        <tr><th id="currencyLabel">Währung</th><td id="currency"></td></tr>
        <tr><th id="paymentTypeLabel">Zahlungsart</th><td id="paymentType"></td></tr>
        <tr><th id="paymentTermsLabel">Zahlungsziel</th><td id="paymentTerms"></td></tr>
        <tr><th id="ibanLabel">IBAN</th><td id="iban"></td></tr>
        <tr><th id="bicLabel">BIC</th><td id="bic"></td></tr>
        <tr><th id="accountHolderLabel">Kontoinhaber</th><td id="accountHolder"></td></tr>
        <tr><th id="netAmountLabel">Gesamt netto</th><td id="netAmount"></td></tr>
        <tr><th id="taxAmountLabel">Steuerbetrag</th><td id="taxAmount"></td></tr>
        <tr><th id="grossAmountLabel">Gesamt brutto</th><td id="grossAmount"></td></tr>
        <tr><th id="dueAmountLabel">Fälliger Betrag</th><td id="dueAmount"></td></tr>
      </table>
    </div>
  </section>

  <section id="lineItemsSection" class="hidden">
    <h2 id="lineItemsTitle">📦 Positionen</h2>
    <div class="table-container">
      <table id="lineItemsTable">
        <thead>
          <tr>
            <th data-key="posNr" id="posNrHeader">Pos.-Nr.</th>
            <th data-key="productName" id="productNameHeader">Produktname</th>
            <th data-key="description" id="descriptionHeader">Beschreibung</th>
            <th data-key="notes" id="notesHeader">Notiz</th>
            <th data-key="quantity" id="quantityHeader">Menge</th>
            <th data-key="unit" id="unitHeader">Einheit</th>
            <th data-key="unitPrice" id="unitPriceHeader">Einzelpreis</th>
            <th data-key="lineNet" id="lineNetHeader">Zeilen-Netto</th>
            <th data-key="taxRate" id="taxRateHeader">Steuersatz</th>
            <th data-key="lineGross" id="lineGrossHeader">Zeilenbrutto</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <script>
    (function() {
      "use strict";

      // DOM-Elemente
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('invoiceFile');
      const loadingSection = document.getElementById('loadingSection');
      const successSection = document.getElementById('successSection');
      const errorSection = document.getElementById('errorSection');
      const statsSection = document.getElementById('statsSection');
      const headerSection = document.getElementById('headerSection');
      const sellerSection = document.getElementById('sellerSection');
      const buyerSection = document.getElementById('buyerSection');
      const paymentSection = document.getElementById('paymentSection');
      const lineItemsSection = document.getElementById('lineItemsSection');
      const xmlViewer = document.getElementById('xmlViewer');
      const originalXml = document.getElementById('originalXml');
      const downloadButtons = document.getElementById('downloadButtons');
      const downloadXmlButton = document.getElementById('downloadXml');
      const downloadPdfButton = document.getElementById('downloadPdf');
      const downloadJsonButton = document.getElementById('downloadJson');
      const downloadCsvButton = document.getElementById('downloadCsv');
      const lineItemsTable = document.getElementById('lineItemsTable');
      const tableHeaders = lineItemsTable.querySelectorAll('th');

      // Globale Variablen
      let xmlDoc = null;
      let originalPdfBlob = null;
      let originalXmlBlob = null;
      // Initiale Sprachvariable
      let currentLanguage = 'de'; // Standard: Deutsch
      let invoiceData = {}; // Für JSON/CSV Export

      // Mehrsprachige Labels
      const labels = {
        de: {
          // UI Texte
          mainTitle: "E-Rechnungs-Reader (ZUGFeRD, XRechnung, EN16931) mit PDF-Extraktion",
          descriptionTitle: "Beschreibung",
          descriptionText: "Dieses Tool ermöglicht das Anzeigen von elektronischen Rechnungen im XML-Format sowie ZUGFeRD-PDF/A-3-Dateien. Die eingebettete XML-Datei in ZUGFeRD-PDFs wird automatisch extrahiert und die Rechnungsdaten werden strukturiert dargestellt.",
          disclaimerText: "<strong>Hinweis:</strong> Dieses Tool verarbeitet elektronische Rechnungen (z. B. ZUGFeRD, XRechnung) vollständig clientseitig im Browser. Die Dateien werden nicht hochgeladen oder gespeichert.<br/>Es wird keine Gewähr für die Richtigkeit, Vollständigkeit oder Rechtskonformität der angezeigten Daten übernommen. Jegliche Haftung für Schäden oder Verluste, die aus der Nutzung resultieren, ist ausgeschlossen. Die Verantwortung für die korrekte Verarbeitung und Prüfung der Daten liegt beim Nutzer.",
          dropZoneText: "📄 Datei hierher ziehen und fallen lassen oder klicken, um eine Datei auszuwählen.",
          supportedFormatsText: "Unterstützte Formate: ZUGFeRD PDF, XRechnung XML, EN16931 XML",
          loadingText: "Verarbeitung läuft...",
          successText: "✅ Rechnung erfolgreich verarbeitet!",
          
          // Tabellen-Header
          posNr: "Pos.-Nr.",
          productName: "Produktname",
          description: "Beschreibung",
          notes: "Notiz",
          quantity: "Menge",
          unit: "Einheit",
          unitPrice: "Einzelpreis",
          lineNet: "Zeilen-Netto",
          taxRate: "Steuersatz",
          lineGross: "Zeilenbrutto",
          
          // Sektionen
          xmlViewerSummary: "XML anzeigen",
          invoiceInfo: "📋 Rechnungsinformationen",
          sellerInfo: "🏢 Verkäufer / Rechnungssteller",
          buyerInfo: "👤 Käufer / Rechnungsempfänger",
          paymentInfo: "💳 Zahlungsinformationen",
          lineItems: "📦 Positionen",
          statistics: "📊 Statistiken",
          
          // Buttons
          downloadXml: "📄 XML speichern",
          downloadPdf: "📋 PDF speichern",
          downloadJson: "📊 JSON Export",
          downloadCsv: "📈 CSV Export",
          
          // Felder
          invNumber: "Rechnungsnummer",
          invType: "Rechnungstyp",
          invDate: "Rechnungsdatum",
          invDueDate: "Fälligkeitsdatum",
          invOrderNumber: "Bestellnummer",
          invNote: "Notiz",
          sellerName: "Name",
          sellerAddress: "Adresse",
          sellerEmail: "E-Mail",
          sellerPhone: "Telefon",
          sellerTaxID: "Steuer-ID",
          sellerRegister: "Handelsregister",
          buyerName: "Name",
          buyerAddress: "Adresse",
          buyerEmail: "E-Mail",
          buyerPhone: "Telefon",
          buyerTaxID: "Steuer-ID",
          currency: "Währung",
          paymentType: "Zahlungsart",
          paymentTerms: "Zahlungsziel",
          iban: "IBAN",
          bic: "BIC",
          accountHolder: "Kontoinhaber",
          netAmount: "Gesamt netto",
          taxAmount: "Steuerbetrag",
          grossAmount: "Gesamt brutto",
          dueAmount: "Fälliger Betrag",
          
          // Statistiken
          statPositions: "Positionen",
          statNet: "Nettosumme",
          statTax: "Steuern",
          statGross: "Bruttosumme",
          
          // Fehlermeldungen
          noFileFound: "Keine XML-Datei im PDF gefunden.",
          unsupportedFormat: "Dateiformat nicht unterstützt. Bitte eine PDF (ZUGFeRD) oder XML-Datei hochladen.",
          invalidXml: "Die extrahierte Datei ist keine gültige XML-Rechnung.",
          pdfNotAvailable: "Original-PDF ist nicht verfügbar.",
          processingError: "Fehler beim Verarbeiten der Datei: ",
          noPositionsToExport: "Keine Positionen zum Exportieren verfügbar.",
        },
        en: {
          // UI Texte
          mainTitle: "Electronic Invoice Reader (ZUGFeRD, XRechnung, EN16931) with PDF Extraction",
          descriptionTitle: "Description",
          descriptionText: "This tool allows viewing electronic invoices in XML format as well as ZUGFeRD PDF/A-3 files. The embedded XML file in ZUGFeRD PDFs is automatically extracted and the invoice data is displayed in a structured format.",
          disclaimerText: "<strong>Note:</strong> This tool processes electronic invoices (e.g. ZUGFeRD, XRechnung) completely client-side in the browser. Files are not uploaded or stored.<br/>No warranty is given for the accuracy, completeness or legal compliance of the displayed data. Any liability for damage or loss resulting from use is excluded. The responsibility for correct processing and verification of data lies with the user.",
          dropZoneText: "📄 Drag and drop a file here or click to select a file.",
          supportedFormatsText: "Supported formats: ZUGFeRD PDF, XRechnung XML, EN16931 XML",
          loadingText: "Processing...",
          successText: "✅ Invoice processed successfully!",
          
          // Tabellen-Header
          posNr: "No.",
          productName: "Product Name",
          description: "Description",
          notes: "Notes",
          quantity: "Quantity",
          unit: "Unit",
          unitPrice: "Unit Price",
          lineNet: "Line Net",
          taxRate: "Tax Rate",
          lineGross: "Line Gross",
          
          // Sektionen
          xmlViewerSummary: "Show XML",
          invoiceInfo: "📋 Invoice Information",
          sellerInfo: "🏢 Seller / Issuer",
          buyerInfo: "👤 Buyer / Recipient",
          paymentInfo: "💳 Payment Information",
          lineItems: "📦 Line Items",
          statistics: "📊 Statistics",
          
          // Buttons
          downloadXml: "📄 Save XML",
          downloadPdf: "📋 Save PDF",
          downloadJson: "📊 JSON Export",
          downloadCsv: "📈 CSV Export",
          
          // Felder
          invNumber: "Invoice Number",
          invType: "Invoice Type",
          invDate: "Invoice Date",
          invDueDate: "Due Date",
          invOrderNumber: "Order Number",
          invNote: "Note",
          sellerName: "Name",
          sellerAddress: "Address",
          sellerEmail: "Email",
          sellerPhone: "Phone",
          sellerTaxID: "Tax ID",
          sellerRegister: "Commercial Register",
          buyerName: "Name",
          buyerAddress: "Address",
          buyerEmail: "Email",
          buyerPhone: "Phone",
          buyerTaxID: "Tax ID",
          currency: "Currency",
          paymentType: "Payment Type",
          paymentTerms: "Payment Terms",
          iban: "IBAN",
          bic: "BIC",
          accountHolder: "Account Holder",
          netAmount: "Total Net",
          taxAmount: "Tax Amount",
          grossAmount: "Total Gross",
          dueAmount: "Amount Due",
          
          // Statistiken
          statPositions: "Line Items",
          statNet: "Net Total",
          statTax: "Taxes",
          statGross: "Gross Total",
          
          // Fehlermeldungen
          noFileFound: "No XML file found in the PDF.",
          unsupportedFormat: "Unsupported file format. Please upload a PDF (ZUGFeRD) or XML file.",
          invalidXml: "The extracted file is not a valid XML invoice.",
          pdfNotAvailable: "Original PDF is not available.",
          processingError: "Error processing the file: ",
          noPositionsToExport: "No line items available for export.",
        }
      };

      // Sprachenerkennung und Labels setzen
      function setLanguage(lang) {
        currentLanguage = lang;
        const currentLabels = labels[lang];
        
        // UI Elemente aktualisieren
        document.getElementById('mainTitle').textContent = currentLabels.mainTitle;
        document.getElementById('descriptionTitle').textContent = currentLabels.descriptionTitle;
        document.getElementById('descriptionText').textContent = currentLabels.descriptionText;
        document.getElementById('disclaimerText').innerHTML = currentLabels.disclaimerText;
        document.getElementById('dropZoneText').textContent = currentLabels.dropZoneText;
        document.getElementById('supportedFormatsText').textContent = currentLabels.supportedFormatsText;
        document.getElementById('loadingText').textContent = currentLabels.loadingText;
        document.getElementById('successText').textContent = currentLabels.successText;

        // Sprachbuttons aktualisieren
        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(lang === 'de' ? 'langDe' : 'langEn').classList.add('active');

        // Titel setzen
        document.title = currentLabels.mainTitle;

        // Sektionen-Titel
        const statsTitle = document.getElementById('statsTitle');
        const invoiceInfoTitle = document.getElementById('invoiceInfoTitle');
        const sellerInfoTitle = document.getElementById('sellerInfoTitle');
        const buyerInfoTitle = document.getElementById('buyerInfoTitle');
        const paymentInfoTitle = document.getElementById('paymentInfoTitle');
        const lineItemsTitle = document.getElementById('lineItemsTitle');

        if (statsTitle) statsTitle.textContent = currentLabels.statistics;
        if (invoiceInfoTitle) invoiceInfoTitle.textContent = currentLabels.invoiceInfo;
        if (sellerInfoTitle) sellerInfoTitle.textContent = currentLabels.sellerInfo;
        if (buyerInfoTitle) buyerInfoTitle.textContent = currentLabels.buyerInfo;
        if (paymentInfoTitle) paymentInfoTitle.textContent = currentLabels.paymentInfo;
        if (lineItemsTitle) lineItemsTitle.textContent = currentLabels.lineItems;

        // Statistiken Labels
        const statPositionsLabel = document.getElementById('statPositionsLabel');
        const statNetLabel = document.getElementById('statNetLabel');
        const statTaxLabel = document.getElementById('statTaxLabel');
        const statGrossLabel = document.getElementById('statGrossLabel');

        if (statPositionsLabel) statPositionsLabel.textContent = currentLabels.statPositions;
        if (statNetLabel) statNetLabel.textContent = currentLabels.statNet;
        if (statTaxLabel) statTaxLabel.textContent = currentLabels.statTax;
        if (statGrossLabel) statGrossLabel.textContent = currentLabels.statGross;

        // Tabellen-Labels
        updateTableLabels(currentLabels);

        // Download-Buttons
        downloadXmlButton.textContent = currentLabels.downloadXml;
        downloadPdfButton.textContent = currentLabels.downloadPdf;
        downloadJsonButton.textContent = currentLabels.downloadJson;
        downloadCsvButton.textContent = currentLabels.downloadCsv;

        // XML Viewer Summary
        const xmlViewerSummary = document.querySelector('#xmlViewer summary');
        if (xmlViewerSummary) {
          xmlViewerSummary.textContent = currentLabels.xmlViewerSummary;
        }

        // Tabellenkopf für Line Items
        document.getElementById('posNrHeader').textContent = currentLabels.posNr;
        document.getElementById('productNameHeader').textContent = currentLabels.productName;
        document.getElementById('descriptionHeader').textContent = currentLabels.description;
        document.getElementById('notesHeader').textContent = currentLabels.notes;
        document.getElementById('quantityHeader').textContent = currentLabels.quantity;
        document.getElementById('unitHeader').textContent = currentLabels.unit;
        document.getElementById('unitPriceHeader').textContent = currentLabels.unitPrice;
        document.getElementById('lineNetHeader').textContent = currentLabels.lineNet;
        document.getElementById('taxRateHeader').textContent = currentLabels.taxRate;
        document.getElementById('lineGrossHeader').textContent = currentLabels.lineGross;
      }

      function updateTableLabels(currentLabels) {
        // Rechnungsinformationen
        const invNumberLabel = document.getElementById('invNumberLabel');
        const invTypeLabel = document.getElementById('invTypeLabel');
        const invDateLabel = document.getElementById('invDateLabel');
        const invDueDateLabel = document.getElementById('invDueDateLabel');
        const invOrderNumberLabel = document.getElementById('invOrderNumberLabel');
        const invNoteLabel = document.getElementById('invNoteLabel');

        if (invNumberLabel) invNumberLabel.textContent = currentLabels.invNumber;
        if (invTypeLabel) invTypeLabel.textContent = currentLabels.invType;
        if (invDateLabel) invDateLabel.textContent = currentLabels.invDate;
        if (invDueDateLabel) invDueDateLabel.textContent = currentLabels.invDueDate;
        if (invOrderNumberLabel) invOrderNumberLabel.textContent = currentLabels.invOrderNumber;
        if (invNoteLabel) invNoteLabel.textContent = currentLabels.invNote;

        // Verkäufer
        const sellerNameLabel = document.getElementById('sellerNameLabel');
        const sellerAddressLabel = document.getElementById('sellerAddressLabel');
        const sellerEmailLabel = document.getElementById('sellerEmailLabel');
        const sellerPhoneLabel = document.getElementById('sellerPhoneLabel');
        const sellerTaxIDLabel = document.getElementById('sellerTaxIDLabel');
        const sellerRegisterLabel = document.getElementById('sellerRegisterLabel');

        if (sellerNameLabel) sellerNameLabel.textContent = currentLabels.sellerName;
        if (sellerAddressLabel) sellerAddressLabel.textContent = currentLabels.sellerAddress;
        if (sellerEmailLabel) sellerEmailLabel.textContent = currentLabels.sellerEmail;
        if (sellerPhoneLabel) sellerPhoneLabel.textContent = currentLabels.sellerPhone;
        if (sellerTaxIDLabel) sellerTaxIDLabel.textContent = currentLabels.sellerTaxID;
        if (sellerRegisterLabel) sellerRegisterLabel.textContent = currentLabels.sellerRegister;

        // Käufer
        const buyerNameLabel = document.getElementById('buyerNameLabel');
        const buyerAddressLabel = document.getElementById('buyerAddressLabel');
        const buyerEmailLabel = document.getElementById('buyerEmailLabel');
        const buyerPhoneLabel = document.getElementById('buyerPhoneLabel');
        const buyerTaxIDLabel = document.getElementById('buyerTaxIDLabel');

        if (buyerNameLabel) buyerNameLabel.textContent = currentLabels.buyerName;
        if (buyerAddressLabel) buyerAddressLabel.textContent = currentLabels.buyerAddress;
        if (buyerEmailLabel) buyerEmailLabel.textContent = currentLabels.buyerEmail;
        if (buyerPhoneLabel) buyerPhoneLabel.textContent = currentLabels.buyerPhone;
        if (buyerTaxIDLabel) buyerTaxIDLabel.textContent = currentLabels.buyerTaxID;

        // Zahlungsinformationen
        const currencyLabel = document.getElementById('currencyLabel');
        const paymentTypeLabel = document.getElementById('paymentTypeLabel');
        const paymentTermsLabel = document.getElementById('paymentTermsLabel');
        const ibanLabel = document.getElementById('ibanLabel');
        const bicLabel = document.getElementById('bicLabel');
        const accountHolderLabel = document.getElementById('accountHolderLabel');
        const netAmountLabel = document.getElementById('netAmountLabel');
        const taxAmountLabel = document.getElementById('taxAmountLabel');
        const grossAmountLabel = document.getElementById('grossAmountLabel');
        const dueAmountLabel = document.getElementById('dueAmountLabel');

        if (currencyLabel) currencyLabel.textContent = currentLabels.currency;
        if (paymentTypeLabel) paymentTypeLabel.textContent = currentLabels.paymentType;
        if (paymentTermsLabel) paymentTermsLabel.textContent = currentLabels.paymentTerms;
        if (ibanLabel) ibanLabel.textContent = currentLabels.iban;
        if (bicLabel) bicLabel.textContent = currentLabels.bic;
        if (accountHolderLabel) accountHolderLabel.textContent = currentLabels.accountHolder;
        if (netAmountLabel) netAmountLabel.textContent = currentLabels.netAmount;
        if (taxAmountLabel) taxAmountLabel.textContent = currentLabels.taxAmount;
        if (grossAmountLabel) grossAmountLabel.textContent = currentLabels.grossAmount;
        if (dueAmountLabel) dueAmountLabel.textContent = currentLabels.dueAmount;
      }

      function initializeLanguage() {
        // Automatische Spracherkennung basierend auf Browser-Einstellungen
        const userLang = navigator.language || navigator.userLanguage;
        const initialLang = userLang.startsWith('de') ? 'de' : 'en';
        setLanguage(initialLang);
      }

      // Variables
      let xmlData = null;
      let lineItems = [];
      let pdfJs = null;
      // currentLanguage = 'de';

      // Event Listeners für Sprachumschaltung
      document.getElementById('langDe').addEventListener('click', () => setLanguage('de'));
      document.getElementById('langEn').addEventListener('click', () => setLanguage('en'));

      // Initialisierung der Sprache
      initializeLanguage();

      // Event-Listener für Drag-and-Drop und Klick
      dropZone.addEventListener('click', () => fileInput.click());

      ['dragover', 'dragleave', 'drop'].forEach(event => {
        dropZone.addEventListener(event, handleDragEvents, false);
      });

      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if(file) handleFile(file);
      });

      function handleDragEvents(e) {
        e.preventDefault();
        if (e.type === 'dragover') {
          dropZone.classList.add('dragover');
        } else {
          dropZone.classList.remove('dragover');
          if (e.type === 'drop') {
            const file = e.dataTransfer.files[0];
            if(file) handleFile(file);
          }
        }
      }

      async function handleFile(file) {
        resetUI();
        showLoading();
        
        try {
          if(file.type === "application/pdf") {
            originalPdfBlob = file;
            const xmlContent = await extractXmlFromPdf(file);
            if(xmlContent) {
              originalXmlBlob = new Blob([xmlContent], { type: "application/xml" });
              await parseXML(xmlContent);
            } else {
              showError(currentLabels.noFileFound || "No XML file found in the PDF.");
            }
          } else if(file.name.toLowerCase().endsWith(".xml")) {
            originalXmlBlob = file;
            const text = await file.text();
            await parseXML(text);
          } else {
            showError(currentLabels.unsupportedFormat || "Unsupported file format. Please upload a PDF (ZUGFeRD) or XML file.");
          }
        } catch (err) {
          showError(`${currentLabels.processingError || "Error processing the file: "} ${err.message}`);
          console.error(err);
        } finally {
          hideLoading();
        }
      }

      async function extractXmlFromPdf(file) {
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({data: new Uint8Array(arrayBuffer)}).promise;
          const attachments = await pdf.getAttachments(); // Korrektur: await hinzugefügt

          if(!attachments) return null;

          for (const [filename, attachment] of Object.entries(attachments)) {
            if(filename.toLowerCase().endsWith(".xml")) {
              const decoder = new TextDecoder("utf-8");
              return decoder.decode(attachment.content);
            }
          }

          return null;
        } catch (error) {
          console.error("Error extracting XML from PDF:", error);
          throw error;
        }
      }

      function parseXML(xmlString) {
        const parser = new DOMParser();
        xmlDoc = parser.parseFromString(xmlString, "application/xml");

        if(xmlDoc.querySelector("parsererror")) {
          showError(currentLabels.invalidXml || "The extracted file is not a valid XML invoice.");
          return;
        }

        // XML anzeigen
        originalXml.textContent = beautifyXml(xmlString);
        xmlViewer.classList.remove('hidden');

        // Download-Buttons konfigurieren
        if(originalXmlBlob || originalPdfBlob) {
          downloadButtons.classList.remove('hidden');
          downloadXmlButton.onclick = () => downloadBlob(originalXmlBlob, 'invoice.xml');
          downloadPdfButton.onclick = () => {
            if(originalPdfBlob) {
              downloadBlob(originalPdfBlob, 'invoice.pdf');
            } else {
              showError(currentLabels.pdfNotAvailable || "Original PDF is not available.");
            }
          };
          downloadJsonButton.onclick = () => downloadInvoiceAsJson();
          downloadCsvButton.onclick = () => downloadInvoiceAsCsv();
        }

        // Namespace-Resolver
        const namespaces = {
          'rsm': "urn:un:unece:uncefact:data:standard:CrossIndustryInvoice:100",
          'ram': "urn:un:unece:uncefact:data:standard:ReusableAggregateBusinessInformationEntity:100",
          'udt': "urn:un:unece:uncefact:data:standard:UnqualifiedDataType:100"
        };

        const resolver = (prefix) => namespaces[prefix] || null;

        // XPath-Hilfsfunktionen
        const selectNode = (contextNode, xpath) => {
          const result = xmlDoc.evaluate(
            xpath,
            contextNode,
            resolver,
            XPathResult.FIRST_ORDERED_NODE_TYPE,
            null
          );
          return result.singleNodeValue;
        };

        const selectNodes = (contextNode, xpath) => {
          const result = xmlDoc.evaluate(
            xpath,
            contextNode,
            resolver,
            XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,
            null
          );
          return Array.from({length: result.snapshotLength}, (_, i) => result.snapshotItem(i));
        };

        // Rechnungsinformationen auslesen und anzeigen
        displayInvoiceInfo(selectNode, selectNodes);
        displaySellerInfo(selectNode);
        displayBuyerInfo(selectNode);
        displayPaymentInfo(selectNode, selectNodes);
        const lineItemsCount = displayLineItems(selectNode, selectNodes);
        
        // Statistiken anzeigen
        displayStatistics(lineItemsCount);
        
        // Erfolg anzeigen
        showSuccess();
      }

      function displayInvoiceInfo(selectNode, selectNodes) {
        const invNumber = selectNode(xmlDoc, "/rsm:CrossIndustryInvoice/rsm:ExchangedDocument/ram:ID");
        const invType = selectNode(xmlDoc, "/rsm:CrossIndustryInvoice/rsm:ExchangedDocument/ram:TypeCode");
        const invDateNode = selectNode(xmlDoc, "/rsm:CrossIndustryInvoice/rsm:ExchangedDocument/ram:IssueDateTime/udt:DateTimeString");
        const invDueDateNode = selectNode(xmlDoc, "//ram:SpecifiedTradePaymentTerms/ram:DueDateDateTime/udt:DateTimeString");
        const invOrderNumber = selectNode(xmlDoc, "//ram:BuyerOrderReferencedDocument/ram:IssuerAssignedID");
        const invNoteNodes = selectNodes(xmlDoc, "/rsm:CrossIndustryInvoice/rsm:ExchangedDocument/ram:IncludedNote/ram:Content");

        invoiceData.header = {};
        
        if(invNumber) {
          const number = invNumber.textContent.trim();
          document.getElementById("invNumber").textContent = number;
          invoiceData.header.number = number;
        }
        
        if(invType) {
          const type = invType.textContent.trim();
          document.getElementById("invType").textContent = type;
          invoiceData.header.type = type;
        }
        
        if(invDateNode) {
          let dtStr = invDateNode.textContent.trim();
          let formattedDate = formatDate(dtStr);
          document.getElementById("invDate").textContent = formattedDate;
          invoiceData.header.date = formattedDate;
        }
        
        if(invDueDateNode) {
          let dtStr = invDueDateNode.textContent.trim();
          let formattedDate = formatDate(dtStr);
          document.getElementById("invDueDate").textContent = formattedDate;
          invoiceData.header.dueDate = formattedDate;
        }
        
        if(invOrderNumber) {
          const orderNumber = invOrderNumber.textContent.trim();
          document.getElementById("invOrderNumber").textContent = orderNumber;
          invoiceData.header.orderNumber = orderNumber;
        }
        
        if(invNoteNodes.length > 0) {
          const notes = invNoteNodes.map(note => note.textContent.trim()).join("\n");
          document.getElementById("invNote").textContent = notes;
          invoiceData.header.notes = notes;
        }
        
        headerSection.classList.remove('hidden');
      }

      function displaySellerInfo(selectNode) {
        const sellerName = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:Name");
        const sellerStreet = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:PostalTradeAddress/ram:LineOne");
        const sellerCity = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:PostalTradeAddress/ram:CityName");
        const sellerZip = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:PostalTradeAddress/ram:PostcodeCode");
        const sellerCountry = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:PostalTradeAddress/ram:CountryID");
        const sellerEmail = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:DefinedTradeContact/ram:EmailURIUniversalCommunication/ram:URIID");
        const sellerPhone = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:DefinedTradeContact/ram:TelephoneUniversalCommunication/ram:CompleteNumber");
        const sellerTaxVA = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:SpecifiedTaxRegistration/ram:ID[@schemeID='VA']");
        const sellerTaxFC = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:SpecifiedTaxRegistration/ram:ID[@schemeID='FC']");
        const sellerRegister = selectNode(xmlDoc, "//ram:SellerTradeParty/ram:SpecifiedLegalOrganization/ram:ID");

        invoiceData.seller = {};
        
        if(sellerName) {
          const name = sellerName.textContent.trim();
          document.getElementById("sellerName").textContent = name;
          invoiceData.seller.name = name;
        }

        const sellerAddressParts = [
          sellerStreet?.textContent.trim(),
          (sellerZip && sellerCity) ? `${sellerZip.textContent.trim()} ${sellerCity.textContent.trim()}` : null,
          sellerCountry?.textContent.trim()
        ].filter(Boolean).join(", ");
        if(sellerAddressParts) {
          document.getElementById("sellerAddress").textContent = sellerAddressParts;
          invoiceData.seller.address = sellerAddressParts;
        }

        if(sellerEmail) {
          const email = sellerEmail.textContent.trim();
          document.getElementById("sellerEmail").textContent = email;
          invoiceData.seller.email = email;
        }

        if(sellerPhone) {
          const phone = sellerPhone.textContent.trim();
          document.getElementById("sellerPhone").textContent = phone;
          invoiceData.seller.phone = phone;
        }

        const taxInfo = [
          sellerTaxVA ? `VA: ${sellerTaxVA.textContent.trim()}` : null,
          sellerTaxFC ? `FC: ${sellerTaxFC.textContent.trim()}` : null
        ].filter(Boolean).join("\n");
        if(taxInfo) {
          document.getElementById("sellerTaxID").textContent = taxInfo;
          invoiceData.seller.taxId = taxInfo;
        }

        if(sellerRegister) {
          const register = sellerRegister.textContent.trim();
          document.getElementById("sellerRegister").textContent = register;
          invoiceData.seller.register = register;
        }

        sellerSection.classList.remove('hidden');
      }

      function displayBuyerInfo(selectNode) {
        const buyerName = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:Name");
        const buyerStreet = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:LineOne");
        const buyerCity = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:CityName");
        const buyerZip = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:PostcodeCode");
        const buyerCountry = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:PostalTradeAddress/ram:CountryID");
        const buyerEmail = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:DefinedTradeContact/ram:EmailURIUniversalCommunication/ram:URIID");
        const buyerPhone = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:DefinedTradeContact/ram:TelephoneUniversalCommunication/ram:CompleteNumber");
        const buyerTaxVA = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:SpecifiedTaxRegistration/ram:ID[@schemeID='VA']");
        const buyerTaxFC = selectNode(xmlDoc, "//ram:BuyerTradeParty/ram:SpecifiedTaxRegistration/ram:ID[@schemeID='FC']");

        invoiceData.buyer = {};
        
        if(buyerName) {
          const name = buyerName.textContent.trim();
          document.getElementById("buyerName").textContent = name;
          invoiceData.buyer.name = name;
        }

        const buyerAddressParts = [
          buyerStreet?.textContent.trim(),
          (buyerZip && buyerCity) ? `${buyerZip.textContent.trim()} ${buyerCity.textContent.trim()}` : null,
          buyerCountry?.textContent.trim()
        ].filter(Boolean).join(", ");
        if(buyerAddressParts) {
          document.getElementById("buyerAddress").textContent = buyerAddressParts;
          invoiceData.buyer.address = buyerAddressParts;
        }

        if(buyerEmail) {
          const email = buyerEmail.textContent.trim();
          document.getElementById("buyerEmail").textContent = email;
          invoiceData.buyer.email = email;
        }

        if(buyerPhone) {
          const phone = buyerPhone.textContent.trim();
          document.getElementById("buyerPhone").textContent = phone;
          invoiceData.buyer.phone = phone;
        }

        const taxInfo = [
          buyerTaxVA ? `VA: ${buyerTaxVA.textContent.trim()}` : null,
          buyerTaxFC ? `FC: ${buyerTaxFC.textContent.trim()}` : null
        ].filter(Boolean).join("\n");
        if(taxInfo) {
          document.getElementById("buyerTaxID").textContent = taxInfo;
          invoiceData.buyer.taxId = taxInfo;
        }

        buyerSection.classList.remove('hidden');
      }

      function displayPaymentInfo(selectNode, selectNodes) {
        const paymentMeans = selectNode(xmlDoc, "//ram:ApplicableHeaderTradeSettlement/ram:SpecifiedTradeSettlementPaymentMeans");
        const paymentTerms = selectNode(xmlDoc, "//ram:SpecifiedTradePaymentTerms/ram:Description");
        let currencySymbol = "€"; // Standard-Währung

        invoiceData.payment = {};

        if(paymentMeans) {
          // Währung
          const currencyNode = selectNode(xmlDoc, "//ram:ApplicableHeaderTradeSettlement/ram:InvoiceCurrencyCode");
          let currencyCode = "EUR";
          if(currencyNode) {
            currencyCode = currencyNode.textContent.trim();
            document.getElementById("currency").textContent = currencyCode;
            currencySymbol = getCurrencySymbol(currencyCode);
            invoiceData.payment.currency = currencyCode;
          }

          // Zahlungsart
          const paymentTypeCode = selectNode(paymentMeans, ".//ram:TypeCode");
          if(paymentTypeCode) {
            const paymentType = getPaymentTypeName(paymentTypeCode.textContent.trim());
            document.getElementById("paymentType").textContent = paymentType;
            invoiceData.payment.type = paymentType;
          }

          // IBAN
          const iban = selectNode(paymentMeans, ".//ram:PayerPartyCreditorFinancialAccount/ram:IBANID | .//ram:PayeePartyCreditorFinancialAccount/ram:IBANID");
          if(iban) {
            const ibanValue = iban.textContent.trim();
            document.getElementById("iban").textContent = ibanValue;
            invoiceData.payment.iban = ibanValue;
          }

          // BIC
          const bic = selectNode(paymentMeans, ".//ram:PayeeSpecifiedCreditorFinancialInstitution/ram:BICID | .//ram:PayeePartyCreditorFinancialInstitution/ram:BICID");
          if(bic) {
            const bicValue = bic.textContent.trim();
            document.getElementById("bic").textContent = bicValue;
            invoiceData.payment.bic = bicValue;
          }

          // Kontoinhaber
          const accountHolder = selectNode(paymentMeans, ".//ram:PayeePartyCreditorFinancialAccount/ram:AccountName");
          if(accountHolder) {
            const holder = accountHolder.textContent.trim();
            document.getElementById("accountHolder").textContent = holder;
            invoiceData.payment.accountHolder = holder;
          }
        }

        // Zahlungsziel
        if(paymentTerms) {
          const terms = paymentTerms.textContent.trim();
          document.getElementById("paymentTerms").textContent = terms;
          invoiceData.payment.terms = terms;
        }

        // Monetäre Summen
        const monetarySummation = selectNode(xmlDoc, "//ram:ApplicableHeaderTradeSettlement/ram:SpecifiedTradeSettlementMonetarySummation | //ram:ApplicableHeaderTradeSettlement/ram:SpecifiedTradeSettlementHeaderMonetarySummation");
        if(monetarySummation) {
          const netAmountNode = selectNode(monetarySummation, ".//ram:LineTotalAmount");
          const taxAmountNode = selectNode(monetarySummation, ".//ram:TaxTotalAmount");
          const grossAmountNode = selectNode(monetarySummation, ".//ram:GrandTotalAmount");
          const dueAmountNode = selectNode(monetarySummation, ".//ram:DuePayableAmount");

          if(netAmountNode) {
            const netAmount = netAmountNode.textContent.trim();
            const formattedNet = formatCurrency(netAmount, currencySymbol);
            document.getElementById("netAmount").textContent = formattedNet;
            invoiceData.payment.netAmount = parseFloat(netAmount);
          }

          if(taxAmountNode) {
            const taxAmount = taxAmountNode.textContent.trim();
            const formattedTax = formatCurrency(taxAmount, currencySymbol);
            document.getElementById("taxAmount").textContent = formattedTax;
            invoiceData.payment.taxAmount = parseFloat(taxAmount);
          }

          if(grossAmountNode) {
            const grossAmount = grossAmountNode.textContent.trim();
            const formattedGross = formatCurrency(grossAmount, currencySymbol);
            document.getElementById("grossAmount").textContent = formattedGross;
            invoiceData.payment.grossAmount = parseFloat(grossAmount);
          }

          if(dueAmountNode) {
            const dueAmount = dueAmountNode.textContent.trim();
            const formattedDue = formatCurrency(dueAmount, currencySymbol);
            document.getElementById("dueAmount").textContent = formattedDue;
            invoiceData.payment.dueAmount = parseFloat(dueAmount);
          }
        }

        paymentSection.classList.remove('hidden');
      }

      function displayLineItems(selectNode, selectNodes) {
        const lineItems = selectNodes(xmlDoc, "//ram:IncludedSupplyChainTradeLineItem");
        const tbody = lineItemsTable.querySelector("tbody");
        let calculatedTotalNet = 0;

        invoiceData.lineItems = [];

        lineItems.forEach((item, index) => {
          const lineID = selectNode(item, "./ram:AssociatedDocumentLineDocument/ram:LineID")?.textContent.trim() || (index + 1).toString();
          const productNote = selectNode(item, "./ram:AssociatedDocumentLineDocument/ram:IncludedNote/ram:Content")?.textContent.trim() || "";
          const productName = selectNode(item, "./ram:SpecifiedTradeProduct/ram:Name")?.textContent.trim() || "";
          const productDesc = selectNode(item, "./ram:SpecifiedTradeProduct/ram:Description")?.textContent.trim() || "";
          const qtyElement = selectNode(item, "./ram:SpecifiedLineTradeDelivery/ram:BilledQuantity");
          const qtyText = qtyElement?.textContent.trim() || "0";
          const quantity = parseFloat(qtyText);
          const unit = qtyElement?.getAttribute('unitCode') || "";
          const netPricePerUnit = parseFloat(selectNode(item, "./ram:SpecifiedLineTradeAgreement/ram:NetPriceProductTradePrice/ram:ChargeAmount")?.textContent.trim() || "0");
          const taxRateText = selectNode(item, "./ram:SpecifiedLineTradeSettlement/ram:ApplicableTradeTax/ram:RateApplicablePercent")?.textContent.trim() || "0";
          const taxRate = parseFloat(taxRateText);
          const lineNet = netPricePerUnit * quantity;
          const vatAmount = lineNet * (taxRate / 100);
          const lineGross = lineNet + vatAmount;

          calculatedTotalNet += lineNet;

          // Daten für Export speichern
          invoiceData.lineItems.push({
            position: lineID,
            productName,
            description: productDesc,
            notes: productNote,
            quantity,
            unit,
            unitPrice: netPricePerUnit,
            lineNet,
            taxRate,
            lineGross
          });

          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${escapeHtml(lineID)}</td>
            <td>${escapeHtml(productName)}</td>
            <td>${escapeHtml(productDesc)}</td>
            <td>${escapeHtml(productNote)}</td>
            <td>${escapeHtml(quantity.toFixed(2))}</td>
            <td>${escapeHtml(unit)}</td>
            <td>${formatCurrency(netPricePerUnit.toFixed(2), getCurrencySymbol(document.getElementById("currency").textContent.trim() || 'EUR'))}</td>
            <td>${formatCurrency(lineNet.toFixed(2), getCurrencySymbol(document.getElementById("currency").textContent.trim() || 'EUR'))}</td>
            <td>${escapeHtml(taxRate.toFixed(2))}%</td>
            <td>${formatCurrency(lineGross.toFixed(2), getCurrencySymbol(document.getElementById("currency").textContent.trim() || 'EUR'))}</td>
          `;

          tbody.appendChild(tr);
        });

        if(lineItems.length > 0) {
          const netAmountDisplay = document.getElementById("netAmount");
          if(!netAmountDisplay.textContent) {
            netAmountDisplay.textContent = formatCurrency(calculatedTotalNet.toFixed(2), getCurrencySymbol(document.getElementById("currency").textContent.trim() || 'EUR'));
          }
          lineItemsSection.classList.remove('hidden');
        }

        return lineItems.length;
      }

      function showLoading() {
        loadingSection.classList.remove('hidden');
      }

      function hideLoading() {
        loadingSection.classList.add('hidden');
      }

      function showSuccess() {
        successSection.classList.remove('hidden');
        setTimeout(() => successSection.classList.add('hidden'), 3000);
      }

      function displayStatistics(lineItemsCount) {
        document.getElementById('statLineItems').textContent = lineItemsCount;
        document.getElementById('statNetAmount').textContent = document.getElementById('netAmount').textContent || '0 €';
        document.getElementById('statTaxAmount').textContent = document.getElementById('taxAmount').textContent || '0 €';
        document.getElementById('statGrossAmount').textContent = document.getElementById('grossAmount').textContent || '0 €';
        statsSection.classList.remove('hidden');
      }

      function formatDate(dateStr) {
        if (/^\d{8}$/.test(dateStr)) {
          return `${dateStr.slice(6,8)}.${dateStr.slice(4,6)}.${dateStr.slice(0,4)}`;
        }
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
          const [year, month, day] = dateStr.split('-');
          return `${day}.${month}.${year}`;
        }
        return dateStr;
      }

      function getPaymentTypeName(code) {
        const paymentTypes = {
          '1': 'Instrumentenbasierte Zahlung',
          '10': 'Barzahlung',
          '20': 'Scheck',
          '30': 'Überweisung',
          '31': 'Abbuchung',
          '42': 'Zahlung an ein Bankkonto',
          '48': 'Kartenzahlung',
          '49': 'Lastschrift',
          '58': 'SEPA-Überweisung',
          '59': 'SEPA-Lastschrift'
        };
        return paymentTypes[code] || `Unbekannt (${code})`;
      }

      function downloadInvoiceAsJson() {
        const jsonData = JSON.stringify(invoiceData, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const filename = `invoice_${invoiceData.header?.number || 'unknown'}.json`;
        downloadBlob(blob, filename);
      }

      function downloadInvoiceAsCsv() {
        if (!invoiceData.lineItems || invoiceData.lineItems.length === 0) {
          alert('Keine Positionen zum Exportieren verfügbar.');
          return;
        }

        // CSV Header
        const headers = ['Position', 'Produktname', 'Beschreibung', 'Notiz', 'Menge', 'Einheit', 'Einzelpreis', 'Zeilen-Netto', 'Steuersatz', 'Zeilenbrutto'];
        
        // CSV Daten
        const csvData = [
          headers.join(','),
          ...invoiceData.lineItems.map(item => [
            `"${item.position}"`,
            `"${item.productName}"`,
            `"${item.description}"`,
            `"${item.notes}"`,
            item.quantity,
            `"${item.unit}"`,
            item.unitPrice.toFixed(2),
            item.lineNet.toFixed(2),
            item.taxRate.toFixed(2),
            item.lineGross.toFixed(2)
          ].join(','))
        ].join('\n');

        const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
        const filename = `invoice_${invoiceData.header?.number || 'unknown'}_positions.csv`;
        downloadBlob(blob, filename);
      }

      function showError(msg) {
        errorSection.textContent = msg;
        errorSection.classList.remove("hidden");
      }

      function resetUI() {
        // Fehler- und Anzeigeabschnitte zurücksetzen
        errorSection.textContent = "";
        errorSection.classList.add("hidden");
        successSection.classList.add("hidden");

        [headerSection, sellerSection, buyerSection, paymentSection, lineItemsSection, xmlViewer, downloadButtons, statsSection].forEach(section => section.classList.add('hidden'));

        // Inhalt der Tabellen und Bereiche zurücksetzen
        document.querySelectorAll("#headerSection td, #sellerSection td, #buyerSection td, #paymentSection td").forEach(td => td.textContent = "");
        originalXml.textContent = "";
        lineItemsTable.querySelector("tbody").innerHTML = "";
        
        // Daten zurücksetzen
        invoiceData = {};
      }

      function beautifyXml(xml) {
        const PADDING = '  ';
        const reg = /(>)(<)(\/*)/g;
        let formatted = '';
        let pad = 0;

        xml = xml.replace(reg, '$1\r\n$2$3');
        xml.split('\r\n').forEach(node => {
          let indent = 0;
          if (node.match(/.+<\/\w[^>]*>$/)) {
            indent = 0;
          } else if (node.match(/^<\/\w/)) {
            if (pad !== 0) pad -= 1;
          } else if (node.match(/^<\w[^>]*[^\/]>.*$/)) {
            indent = 1;
          }

          formatted += PADDING.repeat(pad) + node.trim() + '\r\n';
          pad += indent;
        });

        return formatted;
      }

      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function getCurrencySymbol(code) {
        const symbols = {
          'EUR': '€',
          'USD': '$',
          'GBP': '£',
          'CHF': 'CHF',
          // Weitere Währungen können hier hinzugefügt werden
        };
        return symbols[code] || code;
      }

      function formatCurrency(amount, currencySymbol) {
        const formattedAmount = parseFloat(amount).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        switch(currencySymbol) {
          case 'CHF':
            return `${formattedAmount} ${currencySymbol}`;
          case '€':
            return `${formattedAmount} ${currencySymbol}`;
          case '$':
            return `${currencySymbol}${formattedAmount}`;
          case '£':
            return `${currencySymbol}${formattedAmount}`;
          default:
            return `${formattedAmount} ${currencySymbol}`;
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

    })();
  </script>
</body>
</html>
